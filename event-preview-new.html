<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Preview - Crowd</title>
    <link rel="stylesheet" href="event-preview-styles-enhanced.css">
</head>
<body>
    <div class="preview-container">
        <!-- Header -->
        <header class="preview-header">
            <div class="header-content">
                <div class="header-left">
                    <button class="exit-btn" onclick="goBackToDashboard()">
                        ‚Üê Exit
                    </button>
                </div>
                <div class="header-right">
                    <div class="device-icons">
                        <span>üíª</span>
                        <span>üì±</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-content">
                <div class="logo">
                    <img src="logo.jpg" alt="Crowd Logo" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display: none; align-items: center; gap: 0.25rem;">
                        <span class="logo-icon">üéüÔ∏è</span>
                        <span class="logo-text">crowd</span>
                    </div>
                </div>
                <div class="nav-search">
                    <input type="text" placeholder="Search events">
                </div>
                <div class="nav-links">
                    <a href="#">Browse Events</a>
                    <a href="#">Create an event</a>
                    <a href="#">Organize</a>
                    <a href="Help_center_logged_in.html">Help</a>
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">
                            <span id="userInitials">U</span>
                        </div>
                        <span class="user-name" id="userName">Loading...</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Update Banner -->
        <div class="update-banner">
            <p>Need to make some updates? <a href="#" onclick="editCurrentEvent()">Edit event</a></p>
        </div>

        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
            <p>Loading event details...</p>
        </div>

        <!-- Error State -->
        <div class="error-container" id="errorContainer" style="display: none;">
            <div class="error-content">
                <h2>Unable to Load Event</h2>
                <p id="errorMessage">There was an issue loading the event preview.</p>
                <button onclick="retryLoad()" class="retry-btn">Try Again</button>
                <button onclick="goBackToDashboard()" class="back-btn">Back to Dashboard</button>
            </div>
        </div>

        <!-- Event Content -->
        <div class="event-content" id="eventContent" style="display: none;">
            <div class="event-image">
                <img src="" alt="Event" id="eventImage">
            </div>

            <div class="event-details">
                <div class="event-main">
                    <div class="event-badge" id="eventBadge">Loading...</div>
                    <div class="event-date" id="eventDate"></div>
                    <h1 class="event-title" id="eventTitle">Loading...</h1>
                    <p class="event-description" id="eventDescription">Loading event details...</p>

                    <!-- Organizer Profile Section -->
                    <div class="organizer-section" id="organizerSection">
                        <h3>Organized by</h3>
                        <div class="organizer-card">
                            <div class="organizer-avatar" id="organizerAvatar">O</div>
                            <div class="organizer-info">
                                <div class="organizer-name" id="organizerName">Loading...</div>
                                <div class="organizer-title" id="organizerTitle">Event Organizer</div>
                                <div class="organizer-bio" id="organizerBio" style="display: none;"></div>
                                <div class="organizer-social" id="organizerSocial"></div>
                            </div>
                        </div>
                    </div>

                    <div class="event-info-section">
                        <h3>Date and time</h3>
                        <div class="datetime-info">
                            <span class="calendar-icon">üìÖ</span>
                            <span id="fullDateTime">Loading...</span>
                        </div>
                    </div>

                    <div class="event-info-section">
                        <h3>Location</h3>
                        <p id="eventLocation">To be announced</p>
                    </div>

                    <div class="event-info-section">
                        <h3>About this event</h3>
                        <div id="eventOverview">Loading event details...</div>
                    </div>

                    <div class="event-info-section">
                        <h3>Tickets</h3>
                        <div id="ticketTypesSection">
                            <p>Loading ticket information...</p>
                        </div>
                    </div>

                    <div class="event-info-section">
                        <h3>Refund Policy</h3>
                        <p>Contact the organizer to request a refund. Eventbrite's fee is nonrefundable.</p>
                    </div>
                </div>

                <div class="event-sidebar">
                    <div class="ticket-info">
                        <div class="price" id="ticketPrice">Loading...</div>
                        <div class="event-time" id="sidebarDateTime">Loading...<br>Timezone</div>
                        <div class="attendee-info">
                            <span id="attendeeCount">0</span> / <span id="maxAttendees">0</span> attendees
                        </div>
                        <button class="get-tickets-btn" onclick="getTickets()">Get tickets</button>
                        
                        <!-- Event Stats (for organizer) -->
                        <div class="event-stats" id="eventStats" style="display: none;">
                            <h4>Event Statistics</h4>
                            <div class="stat-item">
                                <span class="stat-label">Registration Rate:</span>
                                <span class="stat-value" id="registrationRate">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Revenue:</span>
                                <span class="stat-value" id="totalRevenue">$0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Tickets Sold:</span>
                                <span class="stat-value" id="ticketsSold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="event-actions">
                <button class="publish-btn" id="publishBtn" onclick="publishEvent()" style="display: none;">
                    Publish now
                </button>
                <button class="edit-btn" onclick="editCurrentEvent()">Edit event</button>
                <button class="stats-btn" onclick="viewEventStats()">View Statistics</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="notification" id="notification" style="display: none;">
        <div class="notification-content">
            <span id="notificationMessage"></span>
            <button class="notification-close" onclick="closeNotification()">√ó</button>
        </div>
    </div>

    <script>
        // Global variables
        let currentEventData = null;
        let currentUser = null;
        let eventId = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventPreview();
        });

        async function initializeEventPreview() {
            try {
                // Get event ID from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                eventId = urlParams.get('eventId');
                
                if (!eventId) {
                    // Try getting from localStorage (fallback)
                    const editingEvent = localStorage.getItem('editingEvent');
                    if (editingEvent) {
                        const eventData = JSON.parse(editingEvent);
                        eventId = eventData.id;
                    }
                }
                
                if (!eventId) {
                    showError('No event ID provided. Please select an event from your dashboard.');
                    return;
                }

                // Check authentication
                const token = localStorage.getItem('authToken');
                if (!token) {
                    localStorage.setItem('redirectAfterLogin', `event-preview-new.html?eventId=${eventId}`);
                    window.location.href = 'login.html';
                    return;
                }

                // Load user and event data
                await Promise.all([
                    loadCurrentUser(),
                    loadEventData()
                ]);

                console.log('‚úÖ Event preview initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing event preview:', error);
                showError('Failed to load event preview: ' + error.message);
            }
        }

        async function loadCurrentUser() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }

                currentUser = await response.json();
                updateUserDisplay(currentUser);
            } catch (error) {
                console.error('Error loading user data:', error);
                // Redirect to login on auth failure
                localStorage.setItem('redirectAfterLogin', `event-preview-new.html?eventId=${eventId}`);
                window.location.href = 'login.html';
            }
        }

        async function loadEventData() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/events/${eventId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Event not found or access denied');
                    } else if (response.status === 401) {
                        throw new Error('Authentication required');
                    } else {
                        throw new Error('Failed to load event data');
                    }
                }

                const result = await response.json();
                currentEventData = result.data.event;
                
                // Load organizer info and event stats
                await Promise.all([
                    loadOrganizerInfo(),
                    loadEventStats()
                ]);
                
                displayEventData();
                hideLoading();
            } catch (error) {
                console.error('Error loading event data:', error);
                showError(error.message);
            }
        }

        async function loadOrganizerInfo() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/events/${eventId}/organizer`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentEventData.organizerInfo = result.data.organizer;
                }
            } catch (error) {
                console.error('Error loading organizer info:', error);
                // Non-critical error, continue without organizer info
            }
        }

        async function loadEventStats() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/events/${eventId}/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentEventData.stats = result.data.stats;
                }
            } catch (error) {
                console.error('Error loading event stats:', error);
                // Non-critical error, continue without stats
            }
        }

        function updateUserDisplay(user) {
            const userInitials = getUserInitials(user);
            const userName = getUserDisplayName(user);
            
            document.getElementById('userInitials').textContent = userInitials;
            document.getElementById('userName').textContent = userName;
        }

        function displayEventData() {
            if (!currentEventData) return;

            // Update basic event info
            document.getElementById('eventTitle').textContent = currentEventData.title || 'Untitled Event';
            document.getElementById('eventDescription').textContent = currentEventData.description || 'No description available.';
            
            // Update event image
            const eventImage = document.getElementById('eventImage');
            if (currentEventData.imageUrl) {
                eventImage.src = currentEventData.imageUrl;
                eventImage.alt = currentEventData.title;
            } else {
                eventImage.src = 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=400&q=80';
                eventImage.alt = 'Event placeholder';
            }

            // Update dates and times
            displayEventDateTime();
            
            // Update location
            document.getElementById('eventLocation').textContent = currentEventData.location || 'To be announced';
            
            // Update pricing
            displayEventPricing();
            
            // Update event overview
            displayEventOverview();
            
            // Update organizer info
            displayOrganizerInfo();
            
            // Update event status badge
            updateEventBadge();
            
            // Update ticket types
            displayTicketTypes();
            
            // Update attendee info
            displayAttendeeInfo();
            
            // Show stats if available
            displayEventStats();
            
            // Show/hide publish button
            updateActionButtons();
        }

        function displayEventDateTime() {
            if (!currentEventData.startDate) return;
            
            const startDate = new Date(currentEventData.startDate);
            const endDate = currentEventData.endDate ? new Date(currentEventData.endDate) : null;
            
            // Format full date
            const dateOptions = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            const dateStr = startDate.toLocaleDateString('en-US', dateOptions);
            document.getElementById('eventDate').textContent = dateStr;
            
            // Format time
            const startTime = currentEventData.startTime || formatTime(startDate);
            const endTime = currentEventData.endTime || (endDate ? formatTime(endDate) : null);
            
            const timeStr = endTime ? `${startTime} - ${endTime}` : startTime;
            const timezone = currentEventData.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            document.getElementById('fullDateTime').textContent = `${dateStr} ‚Ä¢ ${timeStr} ${getTimezoneShort(timezone)}`;
            
            // Sidebar date time
            const shortDate = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('sidebarDateTime').innerHTML = `${shortDate} ‚Ä¢ ${startTime}<br>${getTimezoneShort(timezone)}`;
        }

        function displayEventPricing() {
            if (!currentEventData.ticketTypes || currentEventData.ticketTypes.length === 0) {
                if (currentEventData.price === 0) {
                    document.getElementById('ticketPrice').textContent = 'Free';
                } else {
                    document.getElementById('ticketPrice').textContent = `$${currentEventData.price}`;
                }
                return;
            }
            
            const prices = currentEventData.ticketTypes.map(ticket => ticket.price || 0);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            
            if (minPrice === 0 && maxPrice === 0) {
                document.getElementById('ticketPrice').textContent = 'Free';
            } else if (minPrice === maxPrice) {
                document.getElementById('ticketPrice').textContent = `$${minPrice}`;
            } else if (minPrice === 0) {
                document.getElementById('ticketPrice').textContent = `Free - $${maxPrice}`;
            } else {
                document.getElementById('ticketPrice').textContent = `$${minPrice} - $${maxPrice}`;
            }
        }

        function displayEventOverview() {
            const overviewDiv = document.getElementById('eventOverview');
            let overviewHTML = '';
            
            if (currentEventData.overviewDescription) {
                overviewHTML += `<p>${currentEventData.overviewDescription}</p>`;
            }
            
            if (currentEventData.whyAttend) {
                overviewHTML += `<h4>Why attend this event?</h4><p>${currentEventData.whyAttend}</p>`;
            }
            
            if (currentEventData.howToParticipate) {
                overviewHTML += `<h4>How to participate:</h4><p>${currentEventData.howToParticipate}</p>`;
            }
            
            if (currentEventData.closingMessage) {
                overviewHTML += `<p>${currentEventData.closingMessage}</p>`;
            }
            
            if (!overviewHTML) {
                overviewHTML = `<p>Welcome to ${currentEventData.title}! More details coming soon.</p>`;
            }
            
            overviewDiv.innerHTML = overviewHTML;
        }

        function displayOrganizerInfo() {
            if (!currentEventData.organizerInfo) {
                document.getElementById('organizerSection').style.display = 'none';
                return;
            }
            
            const organizer = currentEventData.organizerInfo;
            const initials = getOrganizerInitials(organizer);
            
            document.getElementById('organizerAvatar').textContent = initials;
            document.getElementById('organizerName').textContent = organizer.name || 'Event Organizer';
            
            if (organizer.bio) {
                document.getElementById('organizerBio').textContent = organizer.bio;
                document.getElementById('organizerBio').style.display = 'block';
            }
            
            // Add social links if available
            displayOrganizerSocial(organizer);
        }

        function displayTicketTypes() {
            const ticketSection = document.getElementById('ticketTypesSection');
            
            if (!currentEventData.ticketTypes || currentEventData.ticketTypes.length === 0) {
                ticketSection.innerHTML = '<p>Free admission</p>';
                return;
            }
            
            let ticketsHTML = '<div class="ticket-types">';
            currentEventData.ticketTypes.forEach(ticket => {
                const available = ticket.quantity - (ticket.sold || 0);
                ticketsHTML += `
                    <div class="ticket-type">
                        <div class="ticket-info">
                            <h5>${ticket.name}</h5>
                            <p class="ticket-description">${ticket.description || ''}</p>
                            <p class="ticket-availability">${available} of ${ticket.quantity} available</p>
                        </div>
                        <div class="ticket-price">$${ticket.price || 0}</div>
                    </div>
                `;
            });
            ticketsHTML += '</div>';
            
            ticketSection.innerHTML = ticketsHTML;
        }

        function displayAttendeeInfo() {
            document.getElementById('attendeeCount').textContent = currentEventData.currentAttendees || 0;
            document.getElementById('maxAttendees').textContent = currentEventData.maxAttendees || 0;
        }

        function displayEventStats() {
            if (!currentEventData.stats) return;
            
            const statsDiv = document.getElementById('eventStats');
            const stats = currentEventData.stats;
            
            document.getElementById('registrationRate').textContent = `${stats.registrationRate}%`;
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue.toFixed(2)}`;
            document.getElementById('ticketsSold').textContent = stats.ticketsSold;
            
            statsDiv.style.display = 'block';
        }

        function updateEventBadge() {
            const badge = document.getElementById('eventBadge');
            
            switch (currentEventData.status) {
                case 'published':
                    badge.textContent = 'Published';
                    badge.style.background = '#dcfce7';
                    badge.style.color = '#166534';
                    break;
                case 'draft':
                    badge.textContent = 'Draft';
                    badge.style.background = '#f3f4f6';
                    badge.style.color = '#6b7280';
                    break;
                case 'cancelled':
                    badge.textContent = 'Cancelled';
                    badge.style.background = '#fef2f2';
                    badge.style.color = '#dc2626';
                    break;
                default:
                    badge.textContent = 'Draft';
                    badge.style.background = '#f3f4f6';
                    badge.style.color = '#6b7280';
            }
        }

        function updateActionButtons() {
            const publishBtn = document.getElementById('publishBtn');
            
            if (currentEventData.status === 'draft') {
                publishBtn.style.display = 'inline-block';
            } else {
                publishBtn.style.display = 'none';
            }
        }

        // Action functions
        async function publishEvent() {
            if (!currentEventData || !eventId) {
                showNotification('No event data found.', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/events/${eventId}/publish`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to publish event');
                }

                const result = await response.json();
                currentEventData = result.data.event;
                
                showNotification('Event published successfully!', 'success');
                displayEventData(); // Refresh display
                
            } catch (error) {
                console.error('Error publishing event:', error);
                showNotification('Failed to publish event: ' + error.message, 'error');
            }
        }

        function editCurrentEvent() {
            if (eventId) {
                window.location.href = `event-editor.html?eventId=${eventId}`;
            } else {
                showNotification('No event data found to edit.', 'error');
            }
        }

        function viewEventStats() {
            // Could open a detailed stats modal or page
            showNotification('Detailed statistics coming soon!', 'info');
        }

        function getTickets() {
            if (currentEventData.status === 'published') {
                showNotification('Ticket purchasing system coming soon!', 'info');
            } else {
                showNotification('This event is not yet published. Please publish the event first.', 'warning');
            }
        }

        function goBackToDashboard() {
            window.location.href = 'organizer-dashboard.html';
        }

        function retryLoad() {
            hideError();
            showLoading();
            initializeEventPreview();
        }

        // Utility functions
        function getUserInitials(user) {
            if (user.firstName && user.lastName) {
                return (user.firstName.charAt(0) + user.lastName.charAt(0)).toUpperCase();
            } else if (user.email) {
                return user.email.charAt(0).toUpperCase();
            }
            return 'U';
        }

        function getUserDisplayName(user) {
            if (user.firstName && user.lastName) {
                return `${user.firstName} ${user.lastName}`;
            } else if (user.firstName) {
                return user.firstName;
            } else if (user.email) {
                return user.email.split('@')[0];
            }
            return 'User';
        }

        function getOrganizerInitials(organizer) {
            if (organizer.name) {
                const nameParts = organizer.name.split(' ');
                if (nameParts.length >= 2) {
                    return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
                }
                return nameParts[0].charAt(0).toUpperCase();
            }
            return 'O';
        }

        function formatTime(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHour = hours % 12 || 12;
            const displayMinutes = minutes.toString().padStart(2, '0');
            return `${displayHour}:${displayMinutes} ${ampm}`;
        }

        function getTimezoneShort(timezone) {
            try {
                const parts = timezone.split('/');
                return parts[parts.length - 1].replace('_', ' ');
            } catch (e) {
                return 'Local';
            }
        }

        function displayOrganizerSocial(organizer) {
            // Implementation for social links if needed
            const socialDiv = document.getElementById('organizerSocial');
            socialDiv.innerHTML = ''; // Clear for now
        }

        // UI state management
        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'flex';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('eventContent').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('eventContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('eventContent').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function hideError() {
            document.getElementById('errorContainer').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.className = `notification notification-${type}`;
            notification.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                closeNotification();
            }, 5000);
        }

        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
        }
    </script>
</body>
</html>