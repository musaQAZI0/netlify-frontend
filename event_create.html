<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event</title>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; connect-src 'self' https://crowd-backend-zxxp.onrender.com http://localhost:3001 http://localhost:3002 ws://crowd-backend-zxxp.onrender.com; script-src 'self' 'unsafe-inline' 'unsafe-hashes' 'unsafe-eval'; script-src-attr 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://images.unsplash.com https://*.unsplash.com;">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="event_create.css">
    <script src="js/config.js"></script>
    <script src="js/auth-mongodb.js"></script>
</head>

<body>
    <!-- Modal -->
    <div id="modal" class="modal-overlay">
        <div class="modal">
            <button class="close-button" onclick="closeModal()">&times;</button>

            <h1 class="modal-title">How do you want to build your event?</h1>

            <div class="options-container">
                <div class="option-card" onclick="startFromScratch()">
                    <div class="option-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="option-title">Start from scratch</h2>
                    <p class="option-description">Add all your event details, create new tickets, and set up recurring
                        events</p>
                </div>

                <div class="option-card" onclick="createWithAI()">
                    <div class="option-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h2 class="option-title">Create my event faster with AI</h2>
                    <p class="option-description">Answer a few quick questions to generate an event that's ready to
                        publish almost instantly</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div id="mainForm" class="main-container">
        <div class="background-decorations">
            <div class="decoration-top"></div>
            <div class="decoration-right"></div>
            <div class="decoration-bottom"></div>
        </div>

        <div class="header">
            <div class="logo">
                <img src="logo.jpg" alt="Logo" style="height: 32px; width: auto; object-fit: contain;">
            </div>
            <div class="user-profile" id="userProfile" style="display: none;">
                <div class="user-avatar">
                    <img id="userAvatar" src="" alt="User Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="avatar-placeholder" style="display: none;">
                        <span id="userInitials"></span>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName"></div>
                    <div class="user-email" id="userEmail"></div>
                </div>
            </div>
        </div>

        <div class="form-container">
            <form id="eventForm">
                <div class="form-section">
                    <h1 class="section-title">Create an event with AI</h1>
                    <p class="section-description">
                        Answer a few questions about your event and our AI creation tool will use internal data to build
                        an event page.
                        You can still <a href="#" style="color: #6366f1;">create an event without AI</a>.
                    </p>
                </div>

                <div class="form-section">
                    <h2 class="section-subtitle">What's the name of your event?</h2>
                    <p class="section-description">
                        This will be your event's title. Your title will be used to help create your event's summary,
                        description, category, and tags â€“ so be specific!
                    </p>
                    <div class="form-group">
                        <div class="input-container">
                            <input type="text" id="eventTitle" name="title" class="input-field" placeholder="e.g., Summer Music Festival 2025" maxlength="75" required>
                            <label class="input-label">Event title *</label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-subtitle">When does your event start and end?</h2>
                    <div class="form-row">
                        <div>
                            <div class="input-container">
                                <svg class="input-icon" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17 6.5v-2h-2v2H9v-2H7v2H5v13h14v-13zm0 11H7v-7h10v8z" />
                                </svg>
                                <input type="date" id="eventDate" name="date" class="input-field" value="2025-09-08" required>
                                <label class="input-label">Date</label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <div class="input-container">
                                    <svg class="input-icon" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M18 12c0-3.308-2.692-6-6-6s-6 2.692-6 6 2.692 6 6 6 6-2.692 6-6m2 0a8 8 0 1 1-16 0 8 8 0 0 1 16 0m-7.008-4h-1.99v6h4.63v-2h-2.64z" />
                                    </svg>
                                    <input type="time" id="startTime" name="startTime" class="input-field" value="10:00" required>
                                    <label class="input-label">Start time</label>
                                </div>
                            </div>
                            <div>
                                <div class="input-container">
                                    <svg class="input-icon" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M18 12c0-3.308-2.692-6-6-6s-6 2.692-6 6 2.692 6 6 6 6-2.692 6-6m2 0a8 8 0 1 1-16 0 8 8 0 0 1 16 0m-7.008-4h-1.99v6h4.63v-2h-2.64z" />
                                    </svg>
                                    <input type="time" id="endTime" name="endTime" class="input-field" value="12:00" required>
                                    <label class="input-label">End time</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-subtitle">Where is it located?</h2>
                    <div class="toggle-group">
                        <button type="button" class="toggle-button active" onclick="setLocationType('venue')">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12.067 4C8.934 4 6.4 6.504 6.4 9.6c0 4.2 5.667 10.4 5.667 10.4s5.667-6.2 5.667-10.4c0-3.096-2.534-5.6-5.667-5.6m0 7.6c-1.117 0-2.024-.896-2.024-2s.907-2 2.024-2 2.024.896 2.024 2-.907 2-2.024 2" />
                            </svg>
                            Venue
                        </button>
                        <button type="button" class="toggle-button" onclick="setLocationType('online')">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 4h2v16h-2v-1H5v1H3V4h2v1h14zM5 17h14V7H5zm10-5-5 3V9z" />
                            </svg>
                            Online event
                        </button>
                        <button type="button" class="toggle-button" onclick="setLocationType('tba')">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17 6.5v-2h-2v2H9v-2H7v2H5v13h14v-13zm0 11H7v-7h10v8z" />
                            </svg>
                            To be announced
                        </button>
                    </div>
                    <div class="form-group">
                        <div class="input-container">
                            <svg class="input-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M14.926 13.426a6 6 0 1 0-1.454 1.468L18.5 20l1.5-1.5zM10 14a4 4 0 1 0 0-8 4 4 0 0 0 0 8" />
                            </svg>
                            <input type="text" id="eventLocation" name="location" class="input-field" placeholder="e.g., Madison Square Garden, New York" required>
                            <label class="input-label">Location *</label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-subtitle">How much do you want to charge for tickets?</h2>
                    <p class="section-description">
                        Our tool can only generate one General Admission ticket for now. You can edit and add more
                        ticket types later.
                    </p>
                    <div class="price-input-container">
                        <div class="input-container">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="ticketPrice" name="price" class="input-field price-input" placeholder="0.00" step="0.01" min="0"
                                required>
                            <label class="input-label">Price *</label>
                        </div>
                    </div>
                    <div class="switch-container" onclick="toggleFreeTickets()">
                        <div class="switch" id="freeSwitch">
                            <div class="switch-thumb"></div>
                        </div>
                        <span>My tickets are free</span>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-subtitle">What's the capacity for your event?</h2>
                    <p class="section-description">
                        Event capacity is the total number of tickets you're willing to sell.
                    </p>
                    <div class="price-input-container">
                        <div class="input-container">
                            <input type="number" id="eventCapacity" name="capacity" class="input-field" placeholder="0" step="1" min="1" required>
                            <label class="input-label">Total capacity *</label>
                        </div>
                    </div>
                </div>
                <!-- Hidden fields for location type -->
                <input type="hidden" id="locationType" name="locationType" value="venue">
            </form>
        </div>

        <div class="action-bar">
            <button type="button" class="btn btn-ghost" onclick="exitForm()">Exit</button>
            <button type="submit" class="btn btn-primary" onclick="createEventWithAI()">Create event</button>
        </div>
    </div>

    <script>
        // Load user profile on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
        });

        async function loadUserProfile() {
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    console.log('No auth token found');
                    return;
                }

                const response = await fetch(`${window.API_ENDPOINTS.auth}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        displayUserProfile(data.user);
                    }
                } else {
                    console.log('Failed to fetch user profile');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function displayUserProfile(user) {
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');
            const avatarPlaceholder = userAvatar.nextElementSibling;
            const userInitials = document.getElementById('userInitials');
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');

            // Show user profile section
            userProfile.style.display = 'flex';

            // Set user name
            userName.textContent = `${user.firstName} ${user.lastName}`;
            
            // Set user email
            userEmail.textContent = user.email;

            // Set avatar or initials
            if (user.profile && user.profile.avatar) {
                userAvatar.src = user.profile.avatar;
                userAvatar.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
            } else {
                // Generate initials
                const initials = (user.firstName[0] + user.lastName[0]).toUpperCase();
                userInitials.textContent = initials;
                userAvatar.style.display = 'none';
                avatarPlaceholder.style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function startFromScratch() {
            console.log('ðŸš€ Starting event creation from scratch...');
            
            // Ensure authentication state is maintained
            try {
                // Check if user is authenticated before proceeding
                const authToken = localStorage.getItem('authToken');
                const currentUser = localStorage.getItem('currentUser');
                
                if (!authToken && !currentUser) {
                    console.warn('No authentication found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('âœ… Authentication verified, proceeding to event builder');
                window.location.href = 'event-builder.html';
                
            } catch (error) {
                console.error('Error during navigation:', error);
                // Fallback - still try to navigate
                window.location.href = 'event-builder.html';
            }
        }

        function createWithAI() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('mainForm').style.display = 'block';
        }

        function setLocationType(type) {
            // Remove active class from all buttons
            document.querySelectorAll('.toggle-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Update hidden field
            document.getElementById('locationType').value = type;
        }

        function toggleFreeTickets() {
            const switchElement = document.getElementById('freeSwitch');
            const priceInput = document.querySelector('.price-input');

            switchElement.classList.toggle('active');

            if (switchElement.classList.contains('active')) {
                priceInput.value = '0.00';
                priceInput.disabled = true;
            } else {
                priceInput.disabled = false;
                priceInput.focus();
            }
        }

        function exitForm() {
            if (confirm('Are you sure you want to exit? Your progress will be lost.')) {
                document.getElementById('mainForm').style.display = 'none';
                document.getElementById('modal').style.display = 'flex';
            }
        }

        // Global variable to store current event data
        let currentEventData = null;

        async function createEventWithAI() {
            const form = document.getElementById('eventForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show loading state
            const createBtn = document.querySelector('.btn-primary');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'Creating Event...';
            createBtn.disabled = true;

            try {
                // Check authentication
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    throw new Error('Authentication required. Please login.');
                }

                // Get form data
                const formData = new FormData(form);
                const eventData = {
                    title: formData.get('title'),
                    description: generateAIDescription(formData.get('title')),
                    category: determineCategory(formData.get('title')),
                    startDate: new Date(`${formData.get('date')}T${formData.get('startTime')}`).toISOString(),
                    endDate: new Date(`${formData.get('date')}T${formData.get('endTime')}`).toISOString(),
                    location: {
                        type: formData.get('locationType') === 'online' ? 'online' : 'physical',
                        venue: formData.get('location')
                    },
                    totalCapacity: parseInt(formData.get('capacity')),
                    isFree: parseFloat(formData.get('price')) === 0,
                    ticketTypes: [{
                        name: 'General Admission',
                        description: 'Standard entry ticket',
                        price: parseFloat(formData.get('price')) || 0,
                        quantity: parseInt(formData.get('capacity'))
                    }],
                    status: 'draft',
                    isPublic: false,
                    tags: generateTags(formData.get('title'))
                };

                console.log('Creating event with data:', eventData);

                // Create event via API
                const response = await fetch(`${window.API_ENDPOINTS.events}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(eventData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('Event created successfully:', result.event);
                    
                    // Store event data for preview
                    currentEventData = result.event;
                    localStorage.setItem('editingEvent', JSON.stringify(result.event));
                    
                    // Show success message
                    showNotification('Event created successfully! Redirecting to preview...', 'success');
                    
                    // Redirect to preview after short delay
                    setTimeout(() => {
                        window.location.href = 'event-preview.html';
                    }, 1500);
                    
                } else {
                    throw new Error(result.message || 'Failed to create event');
                }

            } catch (error) {
                console.error('Error creating event:', error);
                showNotification(error.message || 'Failed to create event. Please try again.', 'error');
            } finally {
                // Restore button state
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            }
        }

        // AI Helper functions to generate content
        function generateAIDescription(title) {
            const templates = [
                `Join us for an exciting ${title}! This event promises to be an unforgettable experience with great activities and networking opportunities.`,
                `Don't miss out on ${title}! We've planned an amazing program that you won't want to miss.`,
                `Experience the best of ${title} with fellow enthusiasts. This event is designed to bring people together for a memorable time.`,
                `${title} is here! Come and be part of this incredible gathering where you'll create lasting memories.`
            ];
            return templates[Math.floor(Math.random() * templates.length)];
        }

        function determineCategory(title) {
            const titleLower = title.toLowerCase();
            
            if (titleLower.includes('music') || titleLower.includes('concert') || titleLower.includes('band')) return 'music';
            if (titleLower.includes('business') || titleLower.includes('conference') || titleLower.includes('networking')) return 'business';
            if (titleLower.includes('food') || titleLower.includes('restaurant') || titleLower.includes('cooking')) return 'food';
            if (titleLower.includes('art') || titleLower.includes('gallery') || titleLower.includes('exhibition')) return 'arts';
            if (titleLower.includes('party') || titleLower.includes('club') || titleLower.includes('nightlife')) return 'nightlife';
            if (titleLower.includes('holiday') || titleLower.includes('festival') || titleLower.includes('celebration')) return 'holidays';
            if (titleLower.includes('dating') || titleLower.includes('singles') || titleLower.includes('romance')) return 'dating';
            if (titleLower.includes('hobby') || titleLower.includes('craft') || titleLower.includes('diy')) return 'hobbies';
            
            return 'other';
        }

        function generateTags(title) {
            const words = title.toLowerCase().split(' ');
            return words.filter(word => word.length > 3).slice(0, 5);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }

        // Handle form submission
        document.getElementById('eventForm').addEventListener('submit', function (e) {
            e.preventDefault();
            createEventWithAI();
        });
    </script>
</body>

</html>