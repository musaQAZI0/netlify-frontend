<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <link rel="stylesheet" href="orders-styles.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="js/config.js"></script>
    <script src="js/auth-mongodb.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="logo.jpg" alt="Logo" style="height: 32px; width: auto; object-fit: contain;">
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard-home.html" class="nav-item" title="Home">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                </a>

                <a href="events-calendar.html" class="nav-item" title="Events">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                </a>

                <a href="orders.html" class="nav-item active" title="Orders">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                </a>

                <a href="marketing.html" class="nav-item" title="Marketing">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg>
                </a>

                <a href="analytics.html" class="nav-item" title="Analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20V10" />
                        <path d="M18 20V4" />
                        <path d="M6 20v-4" />
                    </svg>
                </a>

                <a href="finance.html" class="nav-item" title="Finance">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                    </svg>
                </a>
            </nav>

            <div class="sidebar-bottom">
                <a href="settings.html" class="nav-item" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M20.46 20.46l-4.24-4.24M1.54 20.46l4.24-4.24M21 12h-6m-6 0H3" />
                    </svg>
                </a>

                <a href="AppMarketplace.html" class="nav-item" title="Apps">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                </a>

                <a href="#" onclick="navigateToHelpCenter()" class="nav-item" title="Help">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                </a>
            </div>
        </aside>
            
                

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="logo-text">
                    </div>
                    <div class="header-right">
                        <button class="create-btn" onclick="window.location.href='event-builder.html'">
                            + Create
                        </button>
                        <div class="user-menu" onclick="toggleUserMenu()">
                            <div class="user-avatar" id="userAvatar">AA</div>
                            <span class="user-name" id="userName">abdul ahad</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Orders Content -->
            <div class="orders-content">
                <div class="orders-header">
                    <h1>Order Management</h1>
                    <p class="orders-description">
                        Manage all orders, including editing buyer info, resending tickets and processing refunds. To download a list of orders, view the 
                        <a href="#" class="orders-report-link">Orders report</a>.
                    </p>
                </div>

                <!-- Advanced Search and Filters -->
                <div class="orders-filters">
                    <div class="search-container">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="search-icon">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" id="orderSearch" placeholder="Search order number, email, or name" class="search-input">
                    </div>
                    
                    <div class="filter-container">
                        <select id="searchByFilter" class="filter-select">
                            <option value="buyer">Search by</option>
                            <option value="buyer">Buyer</option>
                            <option value="order">Order number</option>
                            <option value="email">Email</option>
                            <option value="event">Event</option>
                        </select>
                    </div>
                    
                    <div class="filter-container">
                        <select id="orderStatusFilter" class="filter-select">
                            <option value="all">All statuses</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="refunded">Refunded</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div class="filter-container">
                        <select id="paymentStatusFilter" class="filter-select">
                            <option value="all">All payments</option>
                            <option value="paid">Paid</option>
                            <option value="pending">Payment pending</option>
                            <option value="failed">Payment failed</option>
                        </select>
                    </div>
                    
                    <div class="filter-container">
                        <select id="dateRangeFilter" class="filter-select">
                            <option value="past3months">Date range</option>
                            <option value="today">Today</option>
                            <option value="past7days">Past 7 days</option>
                            <option value="pastweek">Past week</option>
                            <option value="pastmonth">Past month</option>
                            <option value="past3months">Past 3 months</option>
                            <option value="custom">Custom range</option>
                        </select>
                    </div>
                    
                    <div class="bulk-actions" id="bulkActions" style="display: none;">
                        <select id="bulkActionSelect" class="filter-select">
                            <option value="">Bulk actions</option>
                            <option value="export">Export selected</option>
                            <option value="email">Send email</option>
                            <option value="refund">Process refunds</option>
                        </select>
                        <button id="applyBulkAction" class="apply-bulk-btn">Apply</button>
                    </div>
                </div>
                
                <!-- Revenue Dashboard -->
                <div class="revenue-dashboard" id="revenueDashboard">
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalRevenue">$0.00</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalOrders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingPayouts">$0.00</div>
                            <div class="stat-label">Pending Payouts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="refundedAmount">$0.00</div>
                            <div class="stat-label">Refunded</div>
                        </div>
                    </div>
                    <div class="dashboard-actions">
                        <button class="dashboard-btn" onclick="exportOrders()">Export All Orders</button>
                        <button class="dashboard-btn" onclick="generateReport()">Generate Report</button>
                        <button class="dashboard-btn" onclick="showFinancialSummary()">Financial Summary</button>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="orders-table-container" id="ordersTableContainer">
                    <!-- Table header with bulk selection -->
                    <div class="table-header-controls">
                        <label class="bulk-checkbox">
                            <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll()">
                            <span class="checkmark"></span>
                        </label>
                        <span class="selected-count" id="selectedCount" style="display: none;">0 selected</span>
                    </div>
                    <!-- Orders will be populated here -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="#9ca3af">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <p>No orders to show. Use the filters above to search for specific orders or refine your results.</p>
                </div>

                <!-- Learn More -->
                <div class="learn-more">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#3b82f6">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" x2="12.01" y1="17" y2="17"/>
                    </svg>
                    <span>Learn more about <a href="#" class="learn-link">managing orders</a></span>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Communication Modal Template -->
    <div id="messageModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Send Message</h3>
                <button class="modal-close" onclick="closeMessageModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="sendMessageToUser(event)">
                    <div class="form-group">
                        <label for="messageRecipient">Recipient</label>
                        <input type="text" id="messageRecipient" readonly>
                    </div>
                    <div class="form-group">
                        <label for="messageSubject">Subject</label>
                        <input type="text" id="messageSubject" placeholder="Message subject" required>
                    </div>
                    <div class="form-group">
                        <label for="messageContent">Message</label>
                        <textarea id="messageContent" rows="6" placeholder="Type your message here..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="messageTemplate">Template</label>
                        <select id="messageTemplate" onchange="loadMessageTemplate()">
                            <option value="">Select a template</option>
                            <option value="ticket_resend">Ticket Resend Notification</option>
                            <option value="refund_processed">Refund Processed</option>
                            <option value="event_update">Event Update</option>
                            <option value="check_in_reminder">Check-in Reminder</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeMessageModal()">Cancel</button>
                        <button type="submit" class="send-btn">Send Message</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        /* Enhanced responsive styles */
        @media (max-width: 768px) {
            .orders-filters {
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-container {
                width: 100%;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .orders-mobile {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            
            .order-card {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 16px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .order-card:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            
            .order-card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
            }
            
            .order-card-title {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .order-card-content {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .order-detail {
                font-size: 14px;
                color: #6b7280;
            }
            
            .mobile-menu-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
            }
            
            .mobile-menu-btn:hover {
                background: #f3f4f6;
            }
            
            .orders-table {
                display: none;
            }
            
            .revenue-dashboard {
                margin: 16px 0;
            }
            
            .dashboard-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .dashboard-btn {
                width: 100%;
            }
        }
        
        @media (min-width: 769px) {
            .orders-mobile {
                display: none;
            }
        }
        
        /* Additional styles for new features */
        .bulk-actions {
            display: none;
            align-items: center;
            gap: 12px;
        }
        
        .apply-bulk-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .revenue-dashboard {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .dashboard-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .dashboard-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .dashboard-btn:hover {
            background: #2563eb;
        }
        
        .table-header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .bulk-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .bulk-checkbox input[type="checkbox"] {
            display: none;
        }
        
        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            position: relative;
            transition: all 0.2s;
        }
        
        .bulk-checkbox input[type="checkbox"]:checked + .checkmark {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        .bulk-checkbox input[type="checkbox"]:checked + .checkmark:after {
            content: 'âœ“';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .selected-count {
            font-size: 14px;
            color: #3b82f6;
            font-weight: 500;
        }
        
        .select-cell {
            width: 40px;
        }
        
        .action-menu {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }
        
        .menu-item:hover {
            background: #f3f4f6;
        }
        
        .menu-item.danger {
            color: #dc2626;
        }
        
        .menu-item.danger:hover {
            background: #fef2f2;
        }
        
        .menu-divider {
            border-top: 1px solid #e5e7eb;
            margin: 4px 0;
        }
        
        .order-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d1d5db;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        .timeline-item.completed .timeline-dot {
            background: #10b981;
        }
        
        .timeline-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .timeline-content span {
            font-size: 14px;
            color: #6b7280;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin: 24px 0;
        }
        
        .financial-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .breakdown-item.total {
            border-top: 2px solid #e5e7eb;
            border-bottom: none;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .guest-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .guest-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        .guest-name {
            font-weight: 500;
        }
        
        .guest-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .guest-status.checked-in {
            background: #d1fae5;
            color: #065f46;
        }
        
        .guest-status.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .guest-action-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .inline-btn {
            background: #e5e7eb;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .inline-btn:hover {
            background: #d1d5db;
        }
        
        .payment-badge, .status-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .payment-badge.paid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .payment-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .payment-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .payment-badge.refunded {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .check-in-status {
            font-size: 12px;
        }
        
        .check-in-status.checked-in {
            color: #065f46;
        }
        
        .check-in-status.not-checked-in {
            color: #92400e;
        }
        
        .order-transaction {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .fee-breakdown {
            font-size: 12px;
            color: #6b7280;
        }
        
        .order-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .action-button.danger {
            background: #dc2626;
        }
        
        .action-button.danger:hover {
            background: #b91c1c;
        }
        
        .financial-summary .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .payout-info, .tax-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .payout-info h4, .tax-info h4 {
            margin: 0 0 12px 0;
            color: #1f2937;
        }
        
        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .date-range span {
            color: #6b7280;
            font-size: 14px;
        }
        
        .generate-btn, .transfer-btn, .send-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .generate-btn:hover, .transfer-btn:hover, .send-btn:hover {
            background: #059669;
        }
        
        .transfer-details, .bulk-email-info {
            background: #f8fafc;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
    
    <script>
        let allOrders = [];
        let filteredOrders = [];

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadUserProfile();
                initializeOrders();
            }, 100);
        });

        async function loadUserProfile() {
            console.log('ðŸ‘¤ Loading user profile...');
            
            try {
                const userStr = localStorage.getItem('currentUser');
                if (userStr) {
                    const user = JSON.parse(userStr);
                    updateUserDisplay(user);
                }
                
                if (window.mongoAuthAPI) {
                    const freshUserData = await window.mongoAuthAPI.getProfile();
                    if (freshUserData && freshUserData.user) {
                        updateUserDisplay(freshUserData.user);
                        localStorage.setItem('currentUser', JSON.stringify(freshUserData.user));
                    }
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function updateUserDisplay(user) {
            console.log('ðŸ”„ Updating user display with:', user);
            
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (userAvatar && userName) {
                if (user.profilePicture) {
                    userAvatar.innerHTML = `<img src="${user.profilePicture}" alt="${user.fullName || user.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    const initials = getInitials(user.fullName || user.name || user.email || 'User');
                    userAvatar.textContent = initials;
                    userAvatar.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
                    userAvatar.style.color = 'white';
                    userAvatar.style.fontWeight = '600';
                    userAvatar.style.fontSize = '14px';
                }
                
                userName.textContent = user.fullName || user.name || user.email || 'User';
            }
        }

        function getInitials(name) {
            if (!name) return 'U';
            const names = name.trim().split(' ');
            if (names.length === 1) {
                return names[0].charAt(0).toUpperCase();
            }
            return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
        }
        
        async function initializeOrders() {
            console.log('ðŸ“‹ Initializing orders...');
            
            // Wait for authAPI to be available
            if (!window.authAPI) {
                console.error('AuthAPI not available, retrying in 500ms...');
                setTimeout(initializeOrders, 500);
                return;
            }

            let isAuthenticated = false;
            
            try {
                // Use the actual authentication system (authAPI)
                isAuthenticated = await window.authAPI.isAuthenticated();
                console.log('ðŸ” AuthAPI authentication check:', isAuthenticated);
                
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to login');
                    localStorage.setItem('redirectAfterLogin', window.location.pathname);
                    window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
                    return;
                }

                console.log('âœ… User authenticated, loading orders...');
                await loadUserData();
                await loadOrdersDataAndSetup();
                setupEventListeners();
                console.log('âœ… Orders initialized successfully');
            } catch (error) {
                console.error('âŒ Error initializing orders:', error);
                showErrorMessage('There was an issue loading the orders page.');
            }
        }
        
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-weight: 500;
                max-width: 400px;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function loadUserData() {
            try {
                // Always fetch fresh user data from the database API - NEVER use localStorage
                console.log('ðŸ”„ Fetching fresh user data from database...');
                const currentUser = await window.authAPI.getCurrentUser();
                
                if (!currentUser) {
                    console.error('âŒ No user data received from API - user may not be logged in');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('âœ… Fresh user data loaded from database:', currentUser.email);

                // Update user display with fresh data from API
                if (currentUser.firstName && currentUser.lastName) {
                    const firstName = currentUser.firstName.charAt(0).toUpperCase() + currentUser.firstName.slice(1).toLowerCase();
                    const lastName = currentUser.lastName.charAt(0).toUpperCase() + currentUser.lastName.slice(1).toLowerCase();
                    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                    document.getElementById('userAvatar').textContent = initials;
                    document.getElementById('userName').textContent = `${firstName} ${lastName}`;
                } else if (currentUser.name) {
                    const nameParts = currentUser.name.split(' ');
                    const initials = nameParts.length > 1 
                        ? (nameParts[0].charAt(0) + nameParts[nameParts.length-1].charAt(0)).toUpperCase()
                        : nameParts[0].charAt(0).toUpperCase();
                    document.getElementById('userAvatar').textContent = initials;
                    document.getElementById('userName').textContent = currentUser.name;
                } else {
                    const initial = currentUser.email.charAt(0).toUpperCase();
                    document.getElementById('userAvatar').textContent = initial;
                    document.getElementById('userName').textContent = currentUser.email.split('@')[0];
                }

                // Store fresh data for offline access only
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
            } catch (error) {
                console.error('âŒ Error loading fresh user data:', error);
                // If API fails, redirect to login - don't use stale data
                window.location.href = 'login.html';
            }
        }

        async function loadOrdersDataAndSetup() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');

                if (!currentUser.id || !token) {
                    console.error('No user or token found');
                    allOrders = [];
                    filteredOrders = [];
                    renderOrders();
                    return;
                }

                // Fetch orders from backend
                console.log('ðŸ“¦ Fetching orders from backend...');
                const response = await fetch(`${window.Config.API_BASE_URL}/api/orders`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // No orders found - use empty array
                        console.log('No orders found, generating sample data');
                        await generateSampleOrders();
                        allOrders = [];
                    } else if (response.status === 401) {
                        console.error('Unauthorized - redirecting to login');
                        window.location.href = 'login.html';
                        return;
                    } else {
                        throw new Error(`Failed to fetch orders: ${response.statusText}`);
                    }
                } else {
                    const data = await response.json();
                    allOrders = data.orders || data || [];
                    console.log(`âœ… Loaded ${allOrders.length} orders from backend`);
                }

                filteredOrders = [...allOrders];
                renderOrders();
                updateRevenueDashboard();
            } catch (error) {
                console.error('âŒ Error loading orders:', error);
                // Fallback to sample data on error
                console.log('Falling back to sample orders due to error');
                try {
                    await generateSampleOrders();
                } catch (sampleError) {
                    console.error('Failed to generate sample orders:', sampleError);
                }
                allOrders = [];
                filteredOrders = [];
                renderOrders();
                updateRevenueDashboard();
            }
        }

        async function generateSampleOrders() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!currentUser || !currentUser.id) {
                console.error('âŒ Current user not available for generating sample orders');
                return;
            }
            
            // Get user events from backend
            let userEvents = [];
            try {
                const eventsResponse = await fetch(`${window.Config.API_BASE_URL}/events?organizerId=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (eventsResponse.ok) {
                    const eventsData = await eventsResponse.json();
                    userEvents = eventsData.events || [];
                }
            } catch (error) {
                console.error('Error fetching user events:', error);
            }
            
            if (userEvents.length === 0) {
                // Create a sample event first
                const sampleEvent = {
                    title: 'Sample Music Festival',
                    date: '2025-08-15',
                    time: '18:00',
                    location: 'Central Park, New York',
                    description: 'A sample event for demonstration',
                    status: 'published',
                    category: 'music'
                };
                
                try {
                    const eventResponse = await fetch(`${window.Config.API_BASE_URL}/events`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(sampleEvent)
                    });
                    
                    if (eventResponse.ok) {
                        const newEvent = await eventResponse.json();
                        userEvents.push(newEvent);
                    }
                } catch (error) {
                    console.error('Error creating sample event:', error);
                }
            }

            const sampleOrders = [
                {
                    id: 'ORD-001',
                    eventId: userEvents[0].id,
                    eventTitle: userEvents[0].title,
                    buyerName: 'John Smith',
                    buyerEmail: 'john.smith@email.com',
                    orderDate: '2025-01-20',
                    orderTime: '14:30',
                    ticketType: 'General Admission',
                    quantity: 2,
                    total: 150.00,
                    status: 'completed',
                    paymentMethod: 'Credit Card',
                    paymentStatus: 'paid',
                    transactionId: 'TXN-' + Date.now(),
                    platformFee: 7.50,
                    processingFee: 4.35,
                    checkedIn: true,
                    guestList: ['John Smith', 'Jane Smith']
                },
                {
                    id: 'ORD-002',
                    eventId: userEvents[0].id,
                    eventTitle: userEvents[0].title,
                    buyerName: 'Sarah Johnson',
                    buyerEmail: 'sarah.j@email.com',
                    orderDate: '2025-01-19',
                    orderTime: '09:15',
                    ticketType: 'VIP',
                    quantity: 1,
                    total: 250.00,
                    status: 'completed',
                    paymentMethod: 'PayPal',
                    paymentStatus: 'paid',
                    transactionId: 'TXN-' + (Date.now() + 1),
                    platformFee: 12.50,
                    processingFee: 7.25,
                    checkedIn: false,
                    guestList: ['Sarah Johnson']
                },
                {
                    id: 'ORD-003',
                    eventId: userEvents[0].id,
                    eventTitle: userEvents[0].title,
                    buyerName: 'Mike Davis',
                    buyerEmail: 'mike.davis@email.com',
                    orderDate: '2025-01-18',
                    orderTime: '16:45',
                    ticketType: 'General Admission',
                    quantity: 4,
                    total: 300.00,
                    status: 'pending',
                    paymentMethod: 'Credit Card',
                    paymentStatus: 'pending',
                    transactionId: 'TXN-' + (Date.now() + 2),
                    platformFee: 15.00,
                    processingFee: 8.70,
                    checkedIn: false,
                    guestList: ['Mike Davis', 'Lisa Davis', 'Tom Davis', 'Amy Davis']
                },
                {
                    id: 'ORD-004',
                    eventId: userEvents[0].id,
                    eventTitle: userEvents[0].title,
                    buyerName: 'Emma Wilson',
                    buyerEmail: 'emma.wilson@email.com',
                    orderDate: '2025-01-17',
                    orderTime: '11:20',
                    ticketType: 'VIP',
                    quantity: 2,
                    total: 500.00,
                    status: 'refunded',
                    paymentMethod: 'Credit Card',
                    paymentStatus: 'refunded',
                    transactionId: 'TXN-' + (Date.now() + 3),
                    platformFee: 25.00,
                    processingFee: 14.50,
                    refundAmount: 500.00,
                    refundReason: 'customer_request',
                    refundDate: '2025-01-19',
                    checkedIn: false,
                    guestList: ['Emma Wilson', 'David Wilson']
                }
            ];

            // Save sample orders to backend
            for (const order of sampleOrders) {
                try {
                    await fetch(`${window.Config.API_BASE_URL}/finance/orders`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(order)
                    });
                } catch (error) {
                    console.error('Error saving sample order:', error);
                }
            }
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('orderSearch').addEventListener('input', handleSearch);
            
            // Filter dropdowns
            document.getElementById('searchByFilter').addEventListener('change', handleSearch);
            document.getElementById('orderStatusFilter').addEventListener('change', handleStatusFilter);
            document.getElementById('paymentStatusFilter').addEventListener('change', handlePaymentFilter);
            document.getElementById('dateRangeFilter').addEventListener('change', handleDateRangeChange);
            
            // Bulk actions
            document.getElementById('applyBulkAction').addEventListener('click', applyBulkAction);
        }

        function handleSearch() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const searchBy = document.getElementById('searchByFilter').value;
            
            filteredOrders = allOrders.filter(order => {
                if (!searchTerm) return true;
                
                switch(searchBy) {
                    case 'buyer':
                        return order.buyerName.toLowerCase().includes(searchTerm);
                    case 'order':
                        return order.id.toLowerCase().includes(searchTerm);
                    case 'email':
                        return order.buyerEmail.toLowerCase().includes(searchTerm);
                    case 'event':
                        return order.eventTitle.toLowerCase().includes(searchTerm);
                    default:
                        return order.buyerName.toLowerCase().includes(searchTerm) ||
                               order.buyerEmail.toLowerCase().includes(searchTerm) ||
                               order.id.toLowerCase().includes(searchTerm) ||
                               order.eventTitle.toLowerCase().includes(searchTerm);
                }
            });
            
            renderOrders();
        }

        function handleDateRangeChange() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            
            if (dateRange === 'custom') {
                showCustomDateRangePicker();
                return;
            }
            
            const now = new Date();
            let startDate = new Date();
            
            switch(dateRange) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'past7days':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'pastweek':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'pastmonth':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'past3months':
                    startDate.setMonth(now.getMonth() - 3);
                    break;
                default:
                    startDate = null;
            }
            
            if (startDate) {
                filteredOrders = allOrders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    return orderDate >= startDate;
                });
            } else {
                filteredOrders = [...allOrders];
            }
            
            handleSearch(); // Apply search filter as well
        }

        function showCustomDateRangePicker() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Custom Date Range</h3>
                        <button class="modal-close" onclick="closeModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="applyCustomDateRange(event)">
                            <div class="date-range-form">
                                <div class="form-group">
                                    <label for="startDate">Start Date</label>
                                    <input type="date" id="startDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="endDate">End Date</label>
                                    <input type="date" id="endDate" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" onclick="closeModal()">Cancel</button>
                                <button type="submit">Apply</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        function applyCustomDateRange(event) {
            event.preventDefault();
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }
            
            filteredOrders = allOrders.filter(order => {
                const orderDate = new Date(order.orderDate);
                return orderDate >= startDate && orderDate <= endDate;
            });
            
            closeModal();
            handleSearch(); // Apply search filter as well
        }

        function renderOrders() {
            const container = document.getElementById('ordersTableContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="table-header-controls">
                        <label class="bulk-checkbox">
                            <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll()">
                            <span class="checkmark"></span>
                        </label>
                        <span class="selected-count" id="selectedCount" style="display: none;">0 selected</span>
                    </div>
                `;
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = `
                <div class="table-header-controls">
                    <label class="bulk-checkbox">
                        <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll()">
                        <span class="checkmark"></span>
                    </label>
                    <span class="selected-count" id="selectedCount" style="display: none;">0 selected</span>
                </div>
                <div class="orders-table">
                    <div class="table-header">
                        <div class="header-cell select-cell"></div>
                        <div class="header-cell">Order</div>
                        <div class="header-cell">Event</div>
                        <div class="header-cell">Buyer</div>
                        <div class="header-cell">Date</div>
                        <div class="header-cell">Amount</div>
                        <div class="header-cell">Status</div>
                        <div class="header-cell">Payment</div>
                        <div class="header-cell">Actions</div>
                    </div>
                    <div class="table-body">
                        ${filteredOrders.map(order => `
                            <div class="table-row" data-order-id="${order.id}">
                                <div class="table-cell select-cell">
                                    <label class="bulk-checkbox">
                                        <input type="checkbox" class="order-checkbox" value="${order.id}" onchange="updateBulkSelection()">
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <div class="order-id">${order.id}</div>
                                    <div class="order-tickets">${order.quantity} Ã— ${order.ticketType}</div>
                                    <div class="order-transaction">TXN: ${order.transactionId || 'N/A'}</div>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <div class="event-title">${order.eventTitle}</div>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <div class="buyer-name">${order.buyerName}</div>
                                    <div class="buyer-email">${order.buyerEmail}</div>
                                    <div class="check-in-status ${order.checkedIn ? 'checked-in' : 'not-checked-in'}">
                                        ${order.checkedIn ? 'âœ“ Checked in' : 'Not checked in'}
                                    </div>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <div class="order-date">${formatDate(order.orderDate)}</div>
                                    <div class="order-time">${formatTime(order.orderTime || '12:00')}</div>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <div class="order-amount">$${order.total.toFixed(2)}</div>
                                    <div class="fee-breakdown">Fees: $${(order.platformFee || 0).toFixed(2)}</div>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <span class="status-badge ${order.status}">${capitalizeFirst(order.status)}</span>
                                </div>
                                <div class="table-cell" onclick="viewOrderDetails('${order.id}')">
                                    <span class="payment-badge ${order.paymentStatus || 'paid'}">${capitalizeFirst(order.paymentStatus || 'paid')}</span>
                                </div>
                                <div class="table-cell">
                                    <div class="action-buttons">
                                        <button class="action-btn" onclick="event.stopPropagation(); showActionMenu('${order.id}', event)" title="More Actions">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                <circle cx="12" cy="12" r="1"/>
                                                <circle cx="12" cy="5" r="1"/>
                                                <circle cx="12" cy="19" r="1"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            updateBulkSelection();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content order-details-modal">
                    <div class="modal-header">
                        <h3>Order Details - ${order.id}</h3>
                        <button class="modal-close" onclick="closeModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="order-details">
                            <div class="detail-section">
                                <h4>Event Information</h4>
                                <p><strong>Event:</strong> ${order.eventTitle}</p>
                                <p><strong>Ticket Type:</strong> ${order.ticketType}</p>
                                <p><strong>Quantity:</strong> ${order.quantity}</p>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Buyer Information</h4>
                                <p><strong>Name:</strong> ${order.buyerName}</p>
                                <p><strong>Email:</strong> ${order.buyerEmail}</p>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Order Information</h4>
                                <p><strong>Order Date:</strong> ${formatDate(order.orderDate)}</p>
                                <p><strong>Total Amount:</strong> $${order.total.toFixed(2)}</p>
                                <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                                <p><strong>Status:</strong> <span class="status-badge ${order.status}">${capitalizeFirst(order.status)}</span></p>
                            </div>
                        </div>
                        
                        <div class="order-actions">
                            <button class="action-button primary" onclick="resendTickets('${order.id}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                                Resend Tickets
                            </button>
                            <button class="action-button secondary" onclick="processRefund('${order.id}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                    <path d="M3 3v5h5"/>
                                </svg>
                                Process Refund
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        function resendTickets(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            if (confirm(`Resend tickets for order ${orderId} to ${order.buyerEmail}?`)) {
                // Simulate sending tickets
                showNotification(`Tickets resent to ${order.buyerEmail}`, 'success');
                closeModal();
            }
        }

        function processRefund(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Process Refund - ${orderId}</h3>
                        <button class="modal-close" onclick="closeModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="confirmRefund(event, '${orderId}')">
                            <div class="refund-details">
                                <p><strong>Order:</strong> ${orderId}</p>
                                <p><strong>Buyer:</strong> ${order.buyerName}</p>
                                <p><strong>Original Amount:</strong> $${order.total.toFixed(2)}</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="refundAmount">Refund Amount</label>
                                <input type="number" id="refundAmount" value="${order.total}" max="${order.total}" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="refundReason">Refund Reason</label>
                                <select id="refundReason" required>
                                    <option value="">Select reason</option>
                                    <option value="customer_request">Customer Request</option>
                                    <option value="event_cancelled">Event Cancelled</option>
                                    <option value="duplicate_order">Duplicate Order</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="refundNotes">Additional Notes (Optional)</label>
                                <textarea id="refundNotes" rows="3" placeholder="Enter any additional notes..."></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="refund-btn">Process Refund</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        function confirmRefund(event, orderId) {
            event.preventDefault();
            
            const refundAmount = parseFloat(document.getElementById('refundAmount').value);
            const refundReason = document.getElementById('refundReason').value;
            const refundNotes = document.getElementById('refundNotes').value;
            
            if (confirm(`Process refund of $${refundAmount.toFixed(2)} for order ${orderId}?`)) {
                // Update order status
                const orderIndex = allOrders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = 'refunded';
                    allOrders[orderIndex].refundAmount = refundAmount;
                    allOrders[orderIndex].refundReason = refundReason;
                    allOrders[orderIndex].refundNotes = refundNotes;
                    allOrders[orderIndex].refundDate = new Date().toISOString();
                    
                    // Save updated order to backend
                    try {
                        fetch(`${window.Config.API_BASE_URL}/finance/orders/${allOrders[orderIndex].id}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(allOrders[orderIndex])
                        }).catch(error => {
                            console.error('Error updating order:', error);
                        });
                    } catch (error) {
                        console.error('Error updating order:', error);
                    }
                }
                
                // Update filtered orders
                filteredOrders = [...allOrders];
                renderOrders();
                
                showNotification(`Refund of $${refundAmount.toFixed(2)} processed for order ${orderId}`, 'success');
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-weight: 500;
                max-width: 400px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.createElement('div');
            dropdown.className = 'user-dropdown';
            dropdown.innerHTML = `
                <div class="dropdown-item" onclick="window.location.href='dashboard-home.html'">Dashboard</div>
                <div class="dropdown-item" onclick="window.location.href='events-calendar.html'">Events</div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="logoutUser()">Sign Out</div>
            `;
            
            dropdown.style.cssText = `
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                padding: 8px 0;
                min-width: 150px;
                z-index: 1000;
                margin-top: 8px;
            `;
            
            userMenu.style.position = 'relative';
            userMenu.appendChild(dropdown);
            
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!userMenu.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        function logoutUser() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        function navigateToHelpCenter() {
            console.log('Navigating to help center from orders page...');
            // Set organizer context flag
            localStorage.setItem('organizerContext', 'true');
            // Navigate to logged-in help center directly
            window.location.href = 'Help_center_logged_in.html';
        }
        
        // Enhanced filtering functions
        function handleStatusFilter() {
            const statusFilter = document.getElementById('orderStatusFilter').value;
            
            if (statusFilter === 'all') {
                filteredOrders = [...allOrders];
            } else {
                filteredOrders = allOrders.filter(order => order.status === statusFilter);
            }
            
            handleSearch(); // Apply other filters
        }
        
        function handlePaymentFilter() {
            const paymentFilter = document.getElementById('paymentStatusFilter').value;
            
            if (paymentFilter === 'all') {
                filteredOrders = [...allOrders];
            } else {
                filteredOrders = allOrders.filter(order => (order.paymentStatus || 'paid') === paymentFilter);
            }
            
            handleSearch(); // Apply other filters
        }
        
        // Bulk selection functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllOrders');
            const checkboxes = document.querySelectorAll('.order-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkSelection();
        }
        
        function updateBulkSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const selectedCount = document.getElementById('selectedCount');
            const bulkActions = document.getElementById('bulkActions');
            
            if (checkboxes.length > 0) {
                selectedCount.textContent = `${checkboxes.length} selected`;
                selectedCount.style.display = 'inline';
                bulkActions.style.display = 'flex';
            } else {
                selectedCount.style.display = 'none';
                bulkActions.style.display = 'none';
            }
        }
        
        function applyBulkAction() {
            const action = document.getElementById('bulkActionSelect').value;
            const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
            
            if (!action || selectedOrders.length === 0) {
                alert('Please select an action and at least one order.');
                return;
            }
            
            switch(action) {
                case 'export':
                    exportSelectedOrders(selectedOrders);
                    break;
                case 'email':
                    showBulkEmailModal(selectedOrders);
                    break;
                case 'refund':
                    processBulkRefunds(selectedOrders);
                    break;
            }
        }
        
        // Action menu function
        function showActionMenu(orderId, event) {
            event.stopPropagation();
            
            const existingMenu = document.querySelector('.action-menu');
            if (existingMenu) existingMenu.remove();
            
            const menu = document.createElement('div');
            menu.className = 'action-menu';
            menu.innerHTML = `
                <div class="menu-item" onclick="viewOrderDetails('${orderId}')">View Details</div>
                <div class="menu-item" onclick="resendTickets('${orderId}')">Resend Tickets</div>
                <div class="menu-item" onclick="downloadReceipt('${orderId}')">Download Receipt</div>
                <div class="menu-item" onclick="processRefund('${orderId}')">Process Refund</div>
                <div class="menu-item" onclick="showTransferModal('${orderId}')">Transfer Tickets</div>
                <div class="menu-item" onclick="sendMessage('${orderId}')">Message Buyer</div>
                <div class="menu-divider"></div>
                <div class="menu-item danger" onclick="cancelOrder('${orderId}')">Cancel Order</div>
            `;
            
            menu.style.cssText = `
                position: absolute;
                top: ${event.clientY}px;
                left: ${event.clientX}px;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                padding: 8px 0;
                min-width: 180px;
                z-index: 1000;
            `;
            
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }
        
        // Revenue dashboard functions
        function updateRevenueDashboard() {
            const totalRevenue = allOrders.reduce((sum, order) => {
                return order.status !== 'cancelled' ? sum + order.total : sum;
            }, 0);
            
            const totalOrders = allOrders.length;
            
            const pendingPayouts = allOrders.reduce((sum, order) => {
                return order.paymentStatus === 'paid' && order.status === 'completed' ? sum + (order.total - (order.platformFee || 0)) : sum;
            }, 0);
            
            const refundedAmount = allOrders.reduce((sum, order) => {
                return order.status === 'refunded' ? sum + (order.refundAmount || order.total) : sum;
            }, 0);
            
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2);
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('pendingPayouts').textContent = '$' + pendingPayouts.toFixed(2);
            document.getElementById('refundedAmount').textContent = '$' + refundedAmount.toFixed(2);
        }
        
        // Export functions
        function exportOrders() {
            exportOrdersToCSV(allOrders, 'all-orders.csv');
        }
        
        function exportSelectedOrders(orderIds) {
            const selectedOrders = allOrders.filter(order => orderIds.includes(order.id));
            exportOrdersToCSV(selectedOrders, 'selected-orders.csv');
        }
        
        function exportOrdersToCSV(orders, filename) {
            const headers = [
                'Order ID', 'Event', 'Buyer Name', 'Buyer Email', 'Order Date', 'Ticket Type', 
                'Quantity', 'Total Amount', 'Platform Fee', 'Processing Fee', 'Status', 
                'Payment Status', 'Transaction ID', 'Payment Method', 'Checked In'
            ];
            
            const csvContent = [
                headers.join(','),
                ...orders.map(order => [
                    order.id,
                    `"${order.eventTitle}"`,
                    `"${order.buyerName}"`,
                    order.buyerEmail,
                    order.orderDate,
                    `"${order.ticketType}"`,
                    order.quantity,
                    order.total,
                    order.platformFee || 0,
                    order.processingFee || 0,
                    order.status,
                    order.paymentStatus || 'paid',
                    order.transactionId || '',
                    `"${order.paymentMethod}"`,
                    order.checkedIn ? 'Yes' : 'No'
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Orders exported successfully!', 'success');
        }
        
        // Enhanced time formatting
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Backend API Functions for Order Management
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch(`${window.Config.API_BASE_URL}/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    throw new Error(`Failed to update order: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('âœ… Order updated successfully');
                showNotification('Order status updated successfully!', 'success');

                // Reload orders to reflect changes
                await loadOrdersDataAndSetup();
                return data;
            } catch (error) {
                console.error('âŒ Error updating order:', error);
                showNotification('Failed to update order status', 'error');
                throw error;
            }
        }

        async function processRefund(orderId, refundAmount, refundReason) {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch(`${window.Config.API_BASE_URL}/api/orders/${orderId}/refund`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: refundAmount,
                        reason: refundReason
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to process refund: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('âœ… Refund processed successfully');
                showNotification('Refund processed successfully!', 'success');

                // Reload orders to reflect changes
                await loadOrdersDataAndSetup();
                return data;
            } catch (error) {
                console.error('âŒ Error processing refund:', error);
                showNotification('Failed to process refund', 'error');
                throw error;
            }
        }

        async function getOrderDetails(orderId) {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch(`${window.Config.API_BASE_URL}/api/orders/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch order details: ${response.statusText}`);
                }

                const data = await response.json();
                return data.order || data;
            } catch (error) {
                console.error('âŒ Error fetching order details:', error);
                showNotification('Failed to load order details', 'error');
                throw error;
            }
        }

        // Make functions globally available
        window.updateOrderStatus = updateOrderStatus;
        window.processRefund = processRefund;
        window.getOrderDetails = getOrderDetails;
    </script>
</body>
</html>
