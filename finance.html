<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance</title>
    <link rel="stylesheet" href="finance-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/config.js"></script>
    <script src="js/auth-mongodb.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="logo.jpg" alt="Logo" style="height: 32px; width: auto; object-fit: contain;">
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard-home.html" class="nav-item" title="Home">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                </a>

                <a href="events-calendar.html" class="nav-item" title="Events">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                </a>

                <a href="orders.html" class="nav-item" title="Orders">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                </a>

                <a href="marketing.html" class="nav-item" title="Marketing">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg>
                </a>

                <a href="analytics.html" class="nav-item" title="Analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20V10" />
                        <path d="M18 20V4" />
                        <path d="M6 20v-4" />
                    </svg>
                </a>

                <a href="finance.html" class="nav-item active" title="Finance">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                    </svg>
                </a>
            </nav>
            
            <div class="sidebar-bottom">
                <a href="settings.html" class="nav-item" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M20.46 20.46l-4.24-4.24M1.54 20.46l4.24-4.24M21 12h-6m-6 0H3" />
                    </svg>
                </a>

                <a href="AppMarketplace.html" class="nav-item" title="Apps">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                </a>

                <a href="Help_center.html" class="nav-item" title="Help">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-actions">
                    <button class="create-btn" onclick="window.location.href='event-builder.html'">
                        <i class="fas fa-plus"></i>
                        Create
                    </button>
                    <div class="user-menu" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">AA</div>
                        <span class="user-name" id="userName">abdul ahad</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>

            <!-- Finance Content -->
            <div class="finance-content">
                <div class="content-wrapper">
                    <div class="left-sidebar">
                        <div class="sidebar-section">
                            <h3>Upcoming</h3>
                            <div class="upcoming-item">
                                <span class="upcoming-label">Next Payout</span>
                                <span class="upcoming-value" id="sidebarNextPayout">-</span>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <h3>Exports</h3>
                            <button class="export-link" onclick="exportPayouts()">
                                <i class="fas fa-download"></i>
                                Export Payouts
                            </button>
                            <button class="export-link" onclick="exportTaxReport()">
                                <i class="fas fa-file-pdf"></i>
                                Tax Report
                            </button>
                        </div>
                    </div>

                    <div class="main-panel">
                        <h1 class="page-title">Finance</h1>
                        
                        <!-- Tab Navigation -->
                        <div class="tab-navigation">
                            <button class="tab-btn active" onclick="showTab('payouts')">Payouts</button>
                            <button class="tab-btn" onclick="showTab('charges')">Charges & Credits</button>
                            <button class="tab-btn" onclick="showTab('invoices')">Invoices</button>
                            <button class="tab-btn" onclick="showTab('settings')">Settings</button>
                        </div>

                        <!-- Payouts Tab Content -->
                        <div id="payouts-tab" class="tab-content active">
                            <!-- Payout Summary Cards -->
                            <div class="payout-summary">
                                <div class="summary-card">
                                    <div class="summary-value" id="availableBalance">$0.00</div>
                                    <div class="summary-label">Available for Payout</div>
                                    <div class="summary-detail">Next payout: <span id="nextPayoutDate">-</span></div>
                                    <!-- Instant Payout Button (Eventbrite 2024 Feature) -->
                                    <div class="instant-payout-section" id="instantPayoutSection" style="margin-top: 16px;">
                                        <button id="instantPayoutBtn" onclick="showInstantPayoutModal()" 
                                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                            </svg>
                                            Instant Payout
                                        </button>
                                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                            Get funds in minutes ‚Ä¢ $0.25 fee
                                        </div>
                                    </div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-value" id="pendingBalance">$0.00</div>
                                    <div class="summary-label">Pending</div>
                                    <div class="summary-detail">Processing events</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-value" id="totalPaidOut">$0.00</div>
                                    <div class="summary-label">Total Paid Out</div>
                                    <div class="summary-detail">All time</div>
                                </div>
                            </div>

                            <!-- Payout Schedule Section -->
                            <div class="payout-schedule-section">
                                <h3>Payout Schedule</h3>
                                <div class="schedule-info">
                                    <div class="schedule-item">
                                        <span class="schedule-label">Current Schedule:</span>
                                        <span class="schedule-value">Weekly (Mondays)</span>
                                        <button class="change-schedule-btn" onclick="changePayoutSchedule()">Change</button>
                                    </div>
                                    <div class="schedule-item">
                                        <span class="schedule-label">Payout Delay:</span>
                                        <span class="schedule-value">3 business days</span>
                                    </div>
                                    <div class="schedule-item">
                                        <span class="schedule-label">Bank Account:</span>
                                        <span class="schedule-value" id="bankAccountInfo">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234</span>
                                        <button class="change-bank-btn" onclick="changeBankAccount()">Change</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filter Buttons -->
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="filterPayouts('summary')">Summary</button>
                                <button class="filter-btn secondary" onclick="filterPayouts('payout-date')">By payout date</button>
                                <button class="filter-btn inactive" onclick="filterPayouts('event-date')">
                                    By event date
                                    <span class="notification-dot"></span>
                                </button>
                            </div>

                            <!-- Description -->
                            <p class="description">View a list of payouts that have been sent to your bank account</p>

                            <!-- Action Bar -->
                            <div class="action-bar">
                                <button class="filters-btn" onclick="showFilters()">
                                    <i class="fas fa-sliders-h"></i>
                                    Filters
                                </button>
                                <button class="export-btn" onclick="exportPayouts()">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>

                            <!-- Payouts Table -->
                            <div class="payouts-table" id="payoutsTable">
                                <!-- Payouts will be populated here -->
                            </div>

                            <!-- Empty State -->
                            <div class="empty-state" id="payoutsEmptyState">
                                <div class="empty-icon">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <h3>No payouts yet</h3>
                                <p>Once you start selling tickets, your payouts will appear here.</p>
                                <div class="empty-actions">
                                    <button class="setup-payouts-btn" onclick="setupPayouts()">Set up payouts</button>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Tab Content -->
                        <div id="settings-tab" class="tab-content">
                            <div class="settings-section">
                                <h3>Payment Information</h3>
                                <div class="settings-group">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4>Bank Account</h4>
                                            <p>Where your payouts are sent</p>
                                        </div>
                                        <div class="setting-value">
                                            <span id="currentBankAccount">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234</span>
                                            <button class="setting-action-btn" onclick="changeBankAccount()">Change</button>
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4>Tax Information</h4>
                                            <p>Required for tax reporting</p>
                                        </div>
                                        <div class="setting-value">
                                            <span class="status-indicator complete">Complete</span>
                                            <button class="setting-action-btn" onclick="editTaxInfo()">Edit</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <h3>Payout Preferences</h3>
                                <div class="settings-group">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4>Payout Schedule</h4>
                                            <p>How often you receive payouts</p>
                                        </div>
                                        <div class="setting-value">
                                            <select class="schedule-select" id="payoutScheduleSelect" onchange="updatePayoutSchedule()">
                                                <option value="weekly">Weekly (Recommended)</option>
                                                <option value="monthly">Monthly</option>
                                                <option value="daily">Daily (Premium only)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4>Minimum Payout Amount</h4>
                                            <p>Minimum amount before payout is triggered</p>
                                        </div>
                                        <div class="setting-value">
                                            <input type="number" class="amount-input" id="minimumPayoutAmount" value="1.00" min="0.01" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charges & Credits Tab Content -->
                        <div id="charges-tab" class="tab-content">
                            <div class="charges-summary">
                                <div class="summary-card">
                                    <div class="summary-value" id="totalFees">$0.00</div>
                                    <div class="summary-label">Total Fees</div>
                                    <div class="summary-detail">Platform & processing</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-value" id="monthlyFees">$0.00</div>
                                    <div class="summary-label">This Month</div>
                                    <div class="summary-detail">Fees charged</div>
                                </div>
                            </div>
                            
                            <div class="charges-table" id="chargesTable">
                                <!-- Charges will be populated here -->
                            </div>
                        </div>

                        <!-- Invoices Tab Content -->
                        <div id="invoices-tab" class="tab-content">
                            <div class="invoices-header">
                                <h3>Invoices & Receipts</h3>
                                <p>Download invoices for your accounting records</p>
                            </div>
                            
                            <div class="invoices-table" id="invoicesTable">
                                <!-- Invoices will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Payout Filters Side Panel -->
    <div id="payoutFiltersPanel" class="filters-panel" style="display: none;">
        <div class="filters-panel-content">
            <div class="filters-header">
                <h3>Payout filters</h3>
                <div class="filters-header-actions">
                    <button class="clear-btn" onclick="clearFilters()">Clear</button>
                    <button class="filters-close" onclick="closeFiltersPanel()">&times;</button>
                </div>
            </div>
            
            <div class="filters-body">
                <!-- Payout date range -->
                <div class="filter-group">
                    <label class="filter-label">Payout date range</label>
                    <select class="filter-select" id="payoutDateRange">
                        <option value="all-time">All time</option>
                        <option value="last-7-days">Last 7 days</option>
                        <option value="last-30-days">Last 30 days</option>
                        <option value="last-90-days">Last 90 days</option>
                        <option value="last-year">Last year</option>
                        <option value="custom">Custom range</option>
                    </select>
                </div>

                <!-- Payout Status -->
                <div class="filter-group">
                    <label class="filter-label">Payout Status</label>
                    <select class="filter-select" id="payoutStatus">
                        <option value="">All statuses</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                        <option value="processing">Processing</option>
                    </select>
                </div>

                <!-- Payout method -->
                <div class="filter-group">
                    <label class="filter-label">Payout method</label>
                    <select class="filter-select" id="payoutMethod">
                        <option value="">All methods</option>
                        <option value="bank-transfer">Bank transfer</option>
                        <option value="paypal">PayPal</option>
                        <option value="stripe">Stripe</option>
                        <option value="check">Check</option>
                    </select>
                </div>

                <!-- Enter a single payout ID -->
                <div class="filter-group">
                    <label class="filter-label">Enter a single payout ID</label>
                    <input type="text" class="filter-input" id="payoutId" placeholder="e.g: 23179153">
                </div>

                <!-- Event name -->
                <div class="filter-group">
                    <label class="filter-label">Event name</label>
                    <select class="filter-select" id="eventName">
                        <option value="">All events</option>
                        <!-- Event options will be populated dynamically -->
                    </select>
                </div>
            </div>

            <div class="filters-footer">
                <button class="filter-btn-cancel" onclick="closeFiltersPanel()">Cancel</button>
                <button class="filter-btn-apply" onclick="applyFilters()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="bankAccountModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bank Account Information</h3>
                <button class="modal-close" onclick="closeModal('bankAccountModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveBankAccount(event)">
                    <div class="form-group">
                        <label for="country">Country</label>
                        <select id="country" onchange="updateBankAccountFields()" required>
                            <option value="">Select Country</option>
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="UK">üá¨üáß United Kingdom</option>
                            <option value="CA">üá®üá¶ Canada</option>
                            <option value="AU">üá¶üá∫ Australia</option>
                            <option value="DE">üá©üá™ Germany</option>
                            <option value="FR">üá´üá∑ France</option>
                            <option value="IN">üáÆüá≥ India</option>
                            <option value="PK">üáµüá∞ Pakistan</option>
                            <option value="JP">üáØüáµ Japan</option>
                            <option value="CN">üá®üá≥ China</option>
                            <option value="BR">üáßüá∑ Brazil</option>
                            <option value="MX">üá≤üáΩ Mexico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="accountHolderName">Account Holder Name</label>
                        <input type="text" id="accountHolderName" required placeholder="Enter the full name on the account">
                    </div>
                    
                    <div class="form-group">
                        <label for="bankName">Bank Name</label>
                        <select id="bankName" required onchange="handleBankSelection(this.value)">
                            <option value="">Select your bank</option>
                            <optgroup label="üá∫üá∏ United States">
                                <option value="Chase Bank">üèõÔ∏è Chase Bank</option>
                                <option value="Bank of America">üè¶ Bank of America</option>
                                <option value="Wells Fargo">üè™ Wells Fargo</option>
                                <option value="Citibank">üè¢ Citibank</option>
                                <option value="US Bank">üá∫üá∏ US Bank</option>
                                <option value="PNC Bank">üèõÔ∏è PNC Bank</option>
                                <option value="Capital One">üí≥ Capital One</option>
                                <option value="TD Bank">üçÅ TD Bank</option>
                            </optgroup>
                            <optgroup label="üá¨üáß United Kingdom">
                                <option value="HSBC">üåç HSBC</option>
                                <option value="Barclays">üá¨üáß Barclays</option>
                                <option value="Lloyds Bank">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Lloyds Bank</option>
                                <option value="NatWest">üèõÔ∏è NatWest</option>
                                <option value="Santander UK">üá™üá∏ Santander UK</option>
                                <option value="TSB Bank">üè¶ TSB Bank</option>
                                <option value="Nationwide">üè† Nationwide</option>
                            </optgroup>
                            <optgroup label="üá®üá¶ Canada">
                                <option value="Royal Bank of Canada">üçÅ Royal Bank of Canada</option>
                                <option value="Bank of Montreal">üèîÔ∏è Bank of Montreal</option>
                                <option value="Scotiabank">üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø Scotiabank</option>
                                <option value="TD Bank Canada">üçÅ TD Bank Canada</option>
                                <option value="CIBC">üíº CIBC</option>
                                <option value="National Bank of Canada">üá®üá¶ National Bank</option>
                            </optgroup>
                            <optgroup label="üá¶üá∫ Australia">
                                <option value="Commonwealth Bank">üá¶üá∫ Commonwealth Bank</option>
                                <option value="ANZ Bank">üè¶ ANZ Bank</option>
                                <option value="Westpac">üá¶üá∫ Westpac</option>
                                <option value="NAB">üìä NAB</option>
                                <option value="Macquarie Bank">üíº Macquarie Bank</option>
                            </optgroup>
                            <optgroup label="üáÆüá≥ India">
                                <option value="ICICI Bank">üáÆüá≥ ICICI Bank</option>
                                <option value="HDFC Bank">üèõÔ∏è HDFC Bank</option>
                                <option value="State Bank of India">üáÆüá≥ State Bank of India</option>
                                <option value="Axis Bank">üìà Axis Bank</option>
                                <option value="Kotak Mahindra">üíº Kotak Mahindra</option>
                                <option value="Yes Bank">‚úÖ Yes Bank</option>
                                <option value="IndusInd Bank">üè≠ IndusInd Bank</option>
                            </optgroup>
                            <optgroup label="üáµüá∞ Pakistan">
                                <option value="HBL">üáµüá∞ HBL</option>
                                <option value="UBL">üè¶ UBL</option>
                                <option value="MCB Bank">üí≥ MCB Bank</option>
                                <option value="Allied Bank">üèõÔ∏è Allied Bank</option>
                                <option value="Bank Alfalah">üìä Bank Alfalah</option>
                                <option value="Meezan Bank">üïå Meezan Bank</option>
                            </optgroup>
                            <optgroup label="üá©üá™ Germany">
                                <option value="Deutsche Bank">üá©üá™ Deutsche Bank</option>
                                <option value="Commerzbank">üè¢ Commerzbank</option>
                                <option value="DZ Bank">üèõÔ∏è DZ Bank</option>
                                <option value="KfW">üè¶ KfW</option>
                            </optgroup>
                            <optgroup label="üá´üá∑ France">
                                <option value="BNP Paribas">üá´üá∑ BNP Paribas</option>
                                <option value="Credit Agricole">üåæ Credit Agricole</option>
                                <option value="Societe Generale">üèõÔ∏è Societe Generale</option>
                                <option value="Credit Mutuel">ü§ù Credit Mutuel</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="custom">‚úèÔ∏è Enter custom bank name</option>
                            </optgroup>
                        </select>
                        <input type="text" id="customBankName" placeholder="Enter bank name" style="display: none; margin-top: 8px;">
                    </div>

                    <div id="countrySpecificFields"></div>

                    <div class="form-group">
                        <label for="bankAddress">Bank Address (Optional)</label>
                        <textarea id="bankAddress" rows="3" placeholder="Bank's full address"></textarea>
                    </div>

                    <div class="form-group">
                        <input type="checkbox" id="isPrimary">
                        <label for="isPrimary">Set as primary account</label>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="closeModal('bankAccountModal')">Cancel</button>
                        <button type="submit" class="save-btn">Save Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tax Information Modal -->
    <div id="taxInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Tax Information</h3>
                <button class="modal-close" onclick="closeModal('taxInfoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveTaxInfo(event)">
                    <!-- Country Selection -->
                    <div class="form-group">
                        <label>Country/Region <span class="required">*</span></label>
                        <select id="taxCountry" required onchange="updateTaxForm()">
                            <option value="">Select your country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="NL">Netherlands</option>
                            <option value="SE">Sweden</option>
                            <option value="NO">Norway</option>
                            <option value="DK">Denmark</option>
                            <option value="FI">Finland</option>
                            <option value="CH">Switzerland</option>
                            <option value="AT">Austria</option>
                            <option value="BE">Belgium</option>
                            <option value="IE">Ireland</option>
                            <option value="PT">Portugal</option>
                            <option value="LU">Luxembourg</option>
                            <option value="JP">Japan</option>
                            <option value="KR">South Korea</option>
                            <option value="SG">Singapore</option>
                            <option value="HK">Hong Kong</option>
                            <option value="NZ">New Zealand</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="IN">India</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <!-- Taxpayer Type -->
                    <div class="form-group">
                        <label>Taxpayer Type <span class="required">*</span></label>
                        <select id="taxpayerType" required onchange="updateTaxForm()">
                            <option value="">Select taxpayer type</option>
                            <option value="individual">Individual</option>
                            <option value="business">Business/Company</option>
                            <option value="nonprofit">Non-profit Organization</option>
                            <option value="partnership">Partnership</option>
                            <option value="trust">Trust/Estate</option>
                        </select>
                    </div>

                    <!-- Personal Information Section -->
                    <div id="personalInfoSection" class="form-section">
                        <h4>Personal Information</h4>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label>First Name <span class="required">*</span></label>
                                <input type="text" id="taxFirstName" required>
                            </div>
                            <div class="form-group half-width">
                                <label>Last Name <span class="required">*</span></label>
                                <input type="text" id="taxLastName" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dateOfBirth">
                        </div>
                    </div>

                    <!-- Business Information Section -->
                    <div id="businessInfoSection" class="form-section" style="display: none;">
                        <h4>Business Information</h4>
                        <div class="form-group">
                            <label>Legal Business Name <span class="required">*</span></label>
                            <input type="text" id="businessName">
                        </div>
                        <div class="form-group">
                            <label>Business Type</label>
                            <select id="businessType">
                                <option value="">Select business type</option>
                                <option value="sole-proprietorship">Sole Proprietorship</option>
                                <option value="corporation">Corporation</option>
                                <option value="llc">Limited Liability Company (LLC)</option>
                                <option value="partnership">Partnership</option>
                                <option value="cooperative">Cooperative</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tax ID Section (Dynamic based on country) -->
                    <div class="form-section">
                        <h4>Tax Identification</h4>
                        <div id="taxIdFields">
                            <!-- Dynamic tax ID fields will be populated here -->
                        </div>
                    </div>

                    <!-- Address Section -->
                    <div class="form-section">
                        <h4>Tax Address</h4>
                        <div class="form-group">
                            <label>Street Address <span class="required">*</span></label>
                            <input type="text" id="taxAddress1" required placeholder="Street address">
                        </div>
                        <div class="form-group">
                            <label>Address Line 2</label>
                            <input type="text" id="taxAddress2" placeholder="Apartment, suite, etc.">
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label>City <span class="required">*</span></label>
                                <input type="text" id="taxCity" required>
                            </div>
                            <div class="form-group half-width">
                                <label id="stateProvinceLabel">State/Province</label>
                                <input type="text" id="taxStateProvince" placeholder="State, province, or region">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label id="postalCodeLabel">Postal Code <span class="required">*</span></label>
                                <input type="text" id="taxPostalCode" required placeholder="Postal code">
                            </div>
                            <div class="form-group half-width">
                                <label>Country <span class="required">*</span></label>
                                <input type="text" id="taxAddressCountry" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Exemption Section -->
                    <div class="form-section">
                        <h4>Tax Exemption Status</h4>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="taxExempt" onchange="toggleTaxExemptDetails()">
                                I claim tax exemption status
                            </label>
                        </div>
                        <div id="taxExemptDetails" class="form-subsection" style="display: none;">
                            <div class="form-group">
                                <label>Exemption Reason</label>
                                <select id="exemptionReason">
                                    <option value="">Select exemption reason</option>
                                    <option value="nonprofit">Non-profit organization</option>
                                    <option value="government">Government entity</option>
                                    <option value="educational">Educational institution</option>
                                    <option value="religious">Religious organization</option>
                                    <option value="charitable">Charitable organization</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Exemption Certificate Number</label>
                                <input type="text" id="exemptionCertificate" placeholder="Certificate or permit number">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Documentation -->
                    <div class="form-section">
                        <h4>Additional Information</h4>
                        <div class="form-group">
                            <label>Additional Notes</label>
                            <textarea id="taxNotes" rows="3" placeholder="Any additional tax-related information or special circumstances"></textarea>
                        </div>
                    </div>

                    <!-- Certification -->
                    <div class="form-section certification">
                        <div class="form-group">
                            <label class="checkbox-label required-checkbox">
                                <input type="checkbox" id="taxCertification" required>
                                I certify that the information provided is accurate and complete to the best of my knowledge. I understand that this information will be used for tax reporting purposes and that providing false information may result in penalties.
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="closeModal('taxInfoModal')">Cancel</button>
                        <button type="submit" class="save-btn">Save Tax Information</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Instant Payout Modal (Eventbrite 2024 Feature) -->
    <div id="instantPayoutModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Instant Payout</h3>
                <button class="modal-close" onclick="closeModal('instantPayoutModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <strong style="color: #1e40af;">Instant Payouts</strong>
                    </div>
                    <p style="color: #1e40af; margin: 0; font-size: 14px; line-height: 1.4;">
                        Get your money deposited into your bank account within minutes instead of waiting for the next scheduled payout.
                    </p>
                </div>

                <form onsubmit="processInstantPayout(event)">
                    <div class="form-group">
                        <label for="instantPayoutAmount">Amount to withdraw</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                            <input type="number" id="instantPayoutAmount" step="0.01" min="1" 
                                   style="padding-left: 24px;" placeholder="0.00" required>
                        </div>
                        <div class="amount-info" style="margin-top: 8px;">
                            <div style="display: flex; justify-content: between; font-size: 14px; color: #6b7280;">
                                <span>Available: $<span id="modalAvailableBalance">0.00</span></span>
                                <button type="button" onclick="setMaxAmount()" 
                                        style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 14px; text-decoration: underline;">
                                    Use max
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="instantPayoutBank">Bank Account</label>
                        <select id="instantPayoutBank" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
                            <option value="">Loading bank accounts...</option>
                        </select>
                    </div>

                    <div class="fee-breakdown" style="background: #f9fafb; padding: 16px; border-radius: 8px; margin: 16px 0;">
                        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1e293b;">Fee Breakdown</h4>
                        <div style="display: flex; justify-content: between; margin-bottom: 8px;">
                            <span style="color: #6b7280;">Amount requested:</span>
                            <span id="requestedAmountDisplay">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: between; margin-bottom: 8px;">
                            <span style="color: #6b7280;">Instant payout fee:</span>
                            <span>$0.25</span>
                        </div>
                        <div style="display: flex; justify-content: between; font-weight: 600; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                            <span>You'll receive:</span>
                            <span id="netAmountDisplay">$0.00</span>
                        </div>
                    </div>

                    <div class="timeline-info" style="margin: 16px 0;">
                        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1e293b;">Timeline</h4>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>
                            <span style="color: #10b981; font-weight: 500;">Instant payout: Within minutes</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; color: #6b7280;">
                            <div style="width: 8px; height: 8px; background: #d1d5db; border-radius: 50%;"></div>
                            <span>Standard payout: 3-5 business days (free)</span>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 24px;">
                        <button type="button" onclick="closeModal('instantPayoutModal')" 
                                style="background: #f3f4f6; color: #374151; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; cursor: pointer; margin-right: 12px;">
                            Cancel
                        </button>
                        <button type="submit" class="save-btn" style="background: #10b981;">
                            Request Instant Payout
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'payouts';
        let payoutsData = [];
        let financialData = {
            availableBalance: 0,
            pendingBalance: 0,
            totalPaidOut: 0,
            nextPayoutDate: null,
            payoutSchedule: 'weekly',
            minimumPayout: 1.00,
            bankAccount: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234'
        };

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeFinance();
            }, 100);
        });
        
        async function initializeFinance() {
            console.log('üí∞ Initializing finance...');
            
            // Wait for authAPI to be available
            if (!window.authAPI) {
                console.error('AuthAPI not available, retrying in 500ms...');
                setTimeout(initializeFinance, 500);
                return;
            }

            let isAuthenticated = false;
            
            try {
                // Use the actual authentication system (authAPI)
                isAuthenticated = await window.authAPI.isAuthenticated();
                console.log('üîç AuthAPI authentication check:', isAuthenticated);
                
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to login');
                    localStorage.setItem('redirectAfterLogin', window.location.pathname);
                    window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
                    return;
                }

                console.log('‚úÖ User authenticated, loading finance...');
                await loadUserData();
                loadFinancialData();
                await loadBankAccounts();
                showTab('payouts');
                updateFinancialSummary();
                updateTaxInfoStatus();
                console.log('‚úÖ Finance initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing finance:', error);
                showErrorMessage('There was an issue loading the finance page.');
            }
        }
        
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-weight: 500;
                max-width: 400px;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function loadUserData() {
            try {
                // Always fetch fresh user data from the database API - NEVER use localStorage
                console.log('üîÑ Fetching fresh user data from database...');
                const currentUser = await window.authAPI.getCurrentUser();
                
                if (!currentUser) {
                    console.error('‚ùå No user data received from API - user may not be logged in');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('‚úÖ Fresh user data loaded from database:', currentUser.email);

                // Update user display - use the actual user data structure from the API
                if (currentUser.firstName && currentUser.lastName) {
                    const initials = (currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0)).toUpperCase();
                    document.getElementById('userAvatar').textContent = initials;
                    document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                } else if (currentUser.name) {
                    // Fallback if user has a name field instead
                    const nameParts = currentUser.name.split(' ');
                    const initials = nameParts.length > 1 
                        ? (nameParts[0].charAt(0) + nameParts[nameParts.length-1].charAt(0)).toUpperCase()
                        : nameParts[0].charAt(0).toUpperCase();
                    document.getElementById('userAvatar').textContent = initials;
                    document.getElementById('userName').textContent = currentUser.name;
                } else {
                    // Last resort - use email
                    const initial = currentUser.email.charAt(0).toUpperCase();
                    document.getElementById('userAvatar').textContent = initial;
                    document.getElementById('userName').textContent = currentUser.email.split('@')[0];
                }
                
                // Store fresh data for offline access only
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } catch (error) {
                console.error('‚ùå Error loading fresh user data:', error);
                window.location.href = 'login.html';
            }
        }

        function showTab(tabName, event) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to selected tab button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // When called programmatically, find the button by onclick attribute
                const tabButton = document.querySelector(`[onclick*="showTab('${tabName}')"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            currentTab = tabName;
            
            // Load tab-specific data
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'payouts':
                    loadPayoutsData();
                    break;
                case 'charges':
                    loadChargesData();
                    break;
                case 'invoices':
                    loadInvoicesData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        async function loadFinancialData() {
            try {
                console.log('üîÑ Loading financial data from API...');
                
                const response = await fetch(`${window.Config.API_BASE_URL}/finance/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load financial data');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Update financial data with real API data
                    financialData.availableBalance = data.dashboard.balances.available;
                    financialData.pendingBalance = data.dashboard.balances.pending;
                    financialData.totalPaidOut = data.dashboard.balances.totalPaidOut;
                    financialData.nextPayoutDate = new Date(data.dashboard.payoutInfo.nextPayoutDate).toLocaleDateString();
                    financialData.payoutSchedule = data.dashboard.payoutInfo.schedule;
                    financialData.instantPayoutsEnabled = data.dashboard.payoutInfo.instantPayoutsEnabled;
                    
                    if (data.dashboard.bankAccount) {
                        financialData.bankAccount = `${data.dashboard.bankAccount.bankName} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${data.dashboard.bankAccount.lastFour}`;
                    }
                    
                    console.log('‚úÖ Financial data loaded successfully');
                } else {
                    throw new Error(data.error || 'Failed to load financial data');
                }
            } catch (error) {
                console.error('‚ùå Error loading financial data:', error);
                // Fallback to mock data
                financialData.availableBalance = 0;
                financialData.pendingBalance = 0;
                financialData.totalPaidOut = 0;
                financialData.nextPayoutDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString();
            }
        }

        function updateFinancialSummary() {
            document.getElementById('availableBalance').textContent = '$' + financialData.availableBalance.toFixed(2);
            document.getElementById('pendingBalance').textContent = '$' + financialData.pendingBalance.toFixed(2);
            document.getElementById('totalPaidOut').textContent = '$' + financialData.totalPaidOut.toFixed(2);
            document.getElementById('nextPayoutDate').textContent = financialData.nextPayoutDate;
            document.getElementById('sidebarNextPayout').textContent = financialData.nextPayoutDate;
            document.getElementById('bankAccountInfo').textContent = financialData.bankAccount;
            document.getElementById('currentBankAccount').textContent = financialData.bankAccount;
            document.getElementById('payoutScheduleSelect').value = financialData.payoutSchedule;
            document.getElementById('minimumPayoutAmount').value = financialData.minimumPayout;
        }

        async function loadPayoutsData() {
            const payoutsTable = document.getElementById('payoutsTable');
            const emptyState = document.getElementById('payoutsEmptyState');

            try {
                console.log('üîÑ Fetching payouts from backend...');

                const response = await fetch(`${window.Config.API_BASE_URL}/api/finance/payouts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load payouts');
                }

                const data = await response.json();
                payoutsData = data.payouts || data || [];
                console.log('‚úÖ Payouts loaded:', payoutsData.length);

            } catch (error) {
                console.error('‚ùå Error loading payouts:', error);
                payoutsData = [];
            }

            if (payoutsData.length === 0) {
                payoutsTable.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            payoutsTable.style.display = 'block';
            emptyState.style.display = 'none';

            // Render payouts table
            payoutsTable.innerHTML = `
                <div class="table-header">
                    <div class="header-cell">Date</div>
                    <div class="header-cell">Amount</div>
                    <div class="header-cell">Status</div>
                    <div class="header-cell">Actions</div>
                </div>
                <div class="table-body">
                    ${payoutsData.map(payout => `
                        <div class="table-row">
                            <div class="table-cell">${formatDate(payout.date || payout.payoutDate)}</div>
                            <div class="table-cell">$${(payout.amount || 0).toFixed(2)}</div>
                            <div class="table-cell">
                                <span class="status-badge ${payout.status}">${payout.status || 'pending'}</span>
                            </div>
                            <div class="table-cell">
                                <button class="action-btn" onclick="viewPayoutDetails('${payout.id || payout._id}')">View</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadChargesData() {
            const chargesTable = document.getElementById('chargesTable');

            try {
                console.log('üîÑ Fetching charges from backend...');

                const response = await fetch(`${window.Config.API_BASE_URL}/api/finance/charges`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load charges');
                }

                const data = await response.json();
                const charges = data.charges || data || [];
                console.log('‚úÖ Charges loaded:', charges.length);

                // Calculate totals
                const totalFees = charges.reduce((sum, charge) => sum + (charge.amount || 0), 0);

                const thisMonth = new Date().getMonth();
                const monthlyFees = charges.filter(charge => {
                    return new Date(charge.date).getMonth() === thisMonth;
                }).reduce((sum, charge) => sum + (charge.amount || 0), 0);

                if (document.getElementById('totalFees')) {
                    document.getElementById('totalFees').textContent = '$' + totalFees.toFixed(2);
                }
                if (document.getElementById('monthlyFees')) {
                    document.getElementById('monthlyFees').textContent = '$' + monthlyFees.toFixed(2);
                }

                if (charges.length === 0) {
                    chargesTable.innerHTML = `
                        <div class="empty-state">
                            <p>No charges to display</p>
                        </div>
                    `;
                    return;
                }

                chargesTable.innerHTML = `
                    <div class="table-header">
                        <div class="header-cell">Date</div>
                        <div class="header-cell">Description</div>
                        <div class="header-cell">Type</div>
                        <div class="header-cell">Amount</div>
                    </div>
                    <div class="table-body">
                        ${charges.map(charge => `
                            <div class="table-row">
                                <div class="table-cell">${formatDate(charge.date)}</div>
                                <div class="table-cell">${charge.description || 'Platform Fee'}</div>
                                <div class="table-cell">${charge.type || 'Fee'}</div>
                                <div class="table-cell">$${(charge.amount || 0).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Error loading charges:', error);
                chargesTable.innerHTML = '<p>Failed to load charges. Please try again later.</p>';
            }
        }

        function loadInvoicesData() {
            // Load invoices data
            const invoicesTable = document.getElementById('invoicesTable');
            invoicesTable.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <h3>No invoices yet</h3>
                    <p>Invoices will appear here when you start processing payments.</p>
                </div>
            `;
        }

        function loadSettingsData() {
            // Settings are already loaded in updateFinancialSummary
        }

        function filterPayouts(filterType) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'secondary', 'inactive');
            });
            
            event.target.classList.add('active');
            
            // Apply filter logic here
            console.log('Filtering by:', filterType);
        }

        function setupPayouts() {
            // Show setup flow
            changeBankAccount();
        }

        function changeBankAccount() {
            document.getElementById('bankAccountModal').style.display = 'flex';
        }

        function changePayoutSchedule() {
            // Focus on the settings tab and schedule select
            showTab('settings');
            setTimeout(() => {
                document.getElementById('payoutScheduleSelect').focus();
            }, 100);
        }

        function updatePayoutSchedule() {
            const newSchedule = document.getElementById('payoutScheduleSelect').value;
            financialData.payoutSchedule = newSchedule;
            
            // Update next payout date based on new schedule
            const today = new Date();
            let nextPayoutDate;
            
            switch(newSchedule) {
                case 'daily':
                    nextPayoutDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'monthly':
                    nextPayoutDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    break;
                default: // weekly
                    nextPayoutDate = new Date(today);
                    nextPayoutDate.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7);
            }
            
            financialData.nextPayoutDate = nextPayoutDate.toLocaleDateString();
            updateFinancialSummary();
            
            showNotification('Payout schedule updated successfully!', 'success');
        }

        const BANK_ACCOUNT_FIELDS = {
            'US': {
                required: ['accountNumber', 'routingNumber', 'accountType'],
                optional: ['swiftCode']
            },
            'UK': {
                required: ['sortCode', 'accountNumber'],
                optional: ['swiftCode', 'iban']
            },
            'CA': {
                required: ['institutionNumber', 'transitNumber', 'accountNumber'],
                optional: ['swiftCode']
            },
            'AU': {
                required: ['bsb', 'accountNumber'],
                optional: ['swiftCode']
            },
            'DE': {
                required: ['iban', 'bic'],
                optional: []
            },
            'FR': {
                required: ['iban', 'bic'],
                optional: []
            },
            'IN': {
                required: ['accountNumber', 'ifscCode'],
                optional: ['swiftCode', 'panNumber']
            },
            'PK': {
                required: ['accountNumber', 'branchCode'],
                optional: ['swiftCode', 'iban', 'cnic']
            },
            'JP': {
                required: ['bankCode', 'branchCode', 'accountNumber'],
                optional: ['swiftCode']
            },
            'CN': {
                required: ['accountNumber', 'cityCode'],
                optional: ['swiftCode']
            },
            'BR': {
                required: ['bankCode', 'agencyNumber', 'accountNumber'],
                optional: ['swiftCode', 'cpfCnpj']
            },
            'MX': {
                required: ['clabe'],
                optional: ['swiftCode', 'rfc']
            }
        };

        function updateBankAccountFields() {
            const country = document.getElementById('country').value;
            const container = document.getElementById('countrySpecificFields');
            
            if (!country) {
                container.innerHTML = '';
                return;
            }
            
            const fields = BANK_ACCOUNT_FIELDS[country];
            if (!fields) return;
            
            let html = '';
            
            // Add required fields
            fields.required.forEach(field => {
                html += generateFieldHTML(field, true);
            });
            
            // Add optional fields
            fields.optional.forEach(field => {
                html += generateFieldHTML(field, false);
            });
            
            container.innerHTML = html;
        }

        function generateFieldHTML(fieldName, isRequired) {
            const fieldConfig = {
                'accountNumber': { label: 'Account Number', type: 'text', placeholder: 'Enter account number' },
                'routingNumber': { label: 'Routing Number', type: 'text', placeholder: '9 digits (e.g., 123456789)' },
                'accountType': { label: 'Account Type', type: 'select', options: ['checking', 'savings'] },
                'sortCode': { label: 'Sort Code', type: 'text', placeholder: '6 digits (e.g., 12-34-56)' },
                'institutionNumber': { label: 'Institution Number', type: 'text', placeholder: '3 digits' },
                'transitNumber': { label: 'Transit Number', type: 'text', placeholder: '5 digits' },
                'bsb': { label: 'BSB Number', type: 'text', placeholder: '6 digits (e.g., 123456)' },
                'iban': { label: 'IBAN', type: 'text', placeholder: 'International Bank Account Number' },
                'bic': { label: 'BIC/SWIFT Code', type: 'text', placeholder: '8 or 11 characters' },
                'ifscCode': { label: 'IFSC Code', type: 'text', placeholder: 'e.g., SBIN0001234' },
                'branchCode': { label: 'Branch Code', type: 'text', placeholder: '4 digits' },
                'bankCode': { label: 'Bank Code', type: 'text', placeholder: 'Bank identification code' },
                'cityCode': { label: 'City Code', type: 'text', placeholder: 'City identification code' },
                'agencyNumber': { label: 'Agency Number', type: 'text', placeholder: 'Agency identification' },
                'clabe': { label: 'CLABE', type: 'text', placeholder: '18 digits' },
                'swiftCode': { label: 'SWIFT Code', type: 'text', placeholder: 'Optional - for international transfers' },
                'panNumber': { label: 'PAN Number', type: 'text', placeholder: 'e.g., ABCDE1234F' },
                'cnic': { label: 'CNIC', type: 'text', placeholder: 'e.g., 12345-1234567-1' },
                'cpfCnpj': { label: 'CPF/CNPJ', type: 'text', placeholder: 'Tax identification number' },
                'rfc': { label: 'RFC', type: 'text', placeholder: 'Tax identification code' }
            };
            
            const config = fieldConfig[fieldName] || { label: fieldName, type: 'text', placeholder: '' };
            const requiredAttr = isRequired ? 'required' : '';
            const requiredLabel = isRequired ? ' *' : ' (Optional)';
            
            if (config.type === 'select') {
                let optionsHtml = '<option value="">Select ' + config.label + '</option>';
                config.options.forEach(option => {
                    optionsHtml += `<option value="${option}">${option.charAt(0).toUpperCase() + option.slice(1)}</option>`;
                });
                return `
                    <div class="form-group">
                        <label for="${fieldName}">${config.label}${requiredLabel}</label>
                        <select id="${fieldName}" ${requiredAttr}>${optionsHtml}</select>
                    </div>
                `;
            } else {
                return `
                    <div class="form-group">
                        <label for="${fieldName}">${config.label}${requiredLabel}</label>
                        <input type="${config.type}" id="${fieldName}" placeholder="${config.placeholder}" ${requiredAttr}>
                    </div>
                `;
            }
        }

        async function saveBankAccount(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const country = document.getElementById('country').value;
            
            if (!country) {
                showNotification('Please select a country', 'error');
                return;
            }
            
            // Collect form data
            const bankAccountData = {
                country: country,
                accountHolderName: document.getElementById('accountHolderName').value,
                bankName: document.getElementById('bankName').value,
                address: document.getElementById('bankAddress').value,
                isPrimary: document.getElementById('isPrimary').checked
            };
            
            // Collect country-specific fields
            const fields = BANK_ACCOUNT_FIELDS[country];
            if (fields) {
                [...fields.required, ...fields.optional].forEach(field => {
                    const element = document.getElementById(field);
                    if (element && element.value) {
                        bankAccountData[field] = element.value;
                    }
                });
            }
            
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/finance/accounts`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bankAccountData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the displayed bank account
                    const maskedAccount = result.bankAccount.accountNumber || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ****';
                    financialData.bankAccount = maskedAccount;
                    updateFinancialSummary();
                    closeModal('bankAccountModal');
                    showNotification('Bank account saved successfully!', 'success');
                } else {
                    showNotification(result.error || 'Failed to save bank account', 'error');
                }
            } catch (error) {
                console.error('Error saving bank account:', error);
                showNotification('Failed to save bank account', 'error');
            }
        }

        async function loadBankAccounts() {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/finance/accounts`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.bankAccounts.length > 0) {
                    const primaryAccount = result.bankAccounts.find(acc => acc.isPrimary) || result.bankAccounts[0];
                    financialData.bankAccount = primaryAccount.accountNumber || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ****';
                    updateFinancialSummary();
                }
            } catch (error) {
                console.error('Error loading bank accounts:', error);
            }
        }

        function editTaxInfo() {
            document.getElementById('taxInfoModal').style.display = 'flex';
            loadExistingTaxInfo();
        }

        function loadExistingTaxInfo() {
            // Load existing tax information if available
            const savedTaxInfo = JSON.parse(localStorage.getItem('taxInfo') || '{}');
            
            if (savedTaxInfo.country) {
                document.getElementById('taxCountry').value = savedTaxInfo.country;
                document.getElementById('taxAddressCountry').value = getCountryName(savedTaxInfo.country);
                updateTaxForm();
            }
            
            if (savedTaxInfo.taxpayerType) {
                document.getElementById('taxpayerType').value = savedTaxInfo.taxpayerType;
                updateTaxForm();
            }
            
            // Load personal info
            document.getElementById('taxFirstName').value = savedTaxInfo.firstName || '';
            document.getElementById('taxLastName').value = savedTaxInfo.lastName || '';
            document.getElementById('dateOfBirth').value = savedTaxInfo.dateOfBirth || '';
            
            // Load business info
            document.getElementById('businessName').value = savedTaxInfo.businessName || '';
            document.getElementById('businessType').value = savedTaxInfo.businessType || '';
            
            // Load address info
            document.getElementById('taxAddress1').value = savedTaxInfo.address1 || '';
            document.getElementById('taxAddress2').value = savedTaxInfo.address2 || '';
            document.getElementById('taxCity').value = savedTaxInfo.city || '';
            document.getElementById('taxStateProvince').value = savedTaxInfo.stateProvince || '';
            document.getElementById('taxPostalCode').value = savedTaxInfo.postalCode || '';
            
            // Load tax exemption
            document.getElementById('taxExempt').checked = savedTaxInfo.taxExempt || false;
            if (savedTaxInfo.taxExempt) {
                toggleTaxExemptDetails();
                document.getElementById('exemptionReason').value = savedTaxInfo.exemptionReason || '';
                document.getElementById('exemptionCertificate').value = savedTaxInfo.exemptionCertificate || '';
            }
            
            document.getElementById('taxNotes').value = savedTaxInfo.notes || '';
        }

        function updateTaxForm() {
            const country = document.getElementById('taxCountry').value;
            const taxpayerType = document.getElementById('taxpayerType').value;
            
            // Update country in address field
            document.getElementById('taxAddressCountry').value = getCountryName(country);
            
            // Update labels based on country
            updateLabelsForCountry(country);
            
            // Show/hide sections based on taxpayer type
            updateSectionsForTaxpayerType(taxpayerType);
            
            // Update tax ID fields based on country and taxpayer type
            updateTaxIdFields(country, taxpayerType);
        }

        function getCountryName(countryCode) {
            const countries = {
                'US': 'United States',
                'CA': 'Canada',
                'GB': 'United Kingdom',
                'AU': 'Australia',
                'DE': 'Germany',
                'FR': 'France',
                'IT': 'Italy',
                'ES': 'Spain',
                'NL': 'Netherlands',
                'SE': 'Sweden',
                'NO': 'Norway',
                'DK': 'Denmark',
                'FI': 'Finland',
                'CH': 'Switzerland',
                'AT': 'Austria',
                'BE': 'Belgium',
                'IE': 'Ireland',
                'PT': 'Portugal',
                'LU': 'Luxembourg',
                'JP': 'Japan',
                'KR': 'South Korea',
                'SG': 'Singapore',
                'HK': 'Hong Kong',
                'NZ': 'New Zealand',
                'BR': 'Brazil',
                'MX': 'Mexico',
                'IN': 'India',
                'OTHER': 'Other'
            };
            return countries[countryCode] || countryCode;
        }

        function updateLabelsForCountry(country) {
            const stateLabel = document.getElementById('stateProvinceLabel');
            const postalLabel = document.getElementById('postalCodeLabel');
            
            switch(country) {
                case 'US':
                    stateLabel.innerHTML = 'State <span class="required">*</span>';
                    postalLabel.innerHTML = 'ZIP Code <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = true;
                    document.getElementById('taxStateProvince').placeholder = 'State';
                    document.getElementById('taxPostalCode').placeholder = 'ZIP code';
                    break;
                case 'CA':
                    stateLabel.innerHTML = 'Province <span class="required">*</span>';
                    postalLabel.innerHTML = 'Postal Code <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = true;
                    document.getElementById('taxStateProvince').placeholder = 'Province';
                    document.getElementById('taxPostalCode').placeholder = 'A1A 1A1';
                    break;
                case 'GB':
                    stateLabel.innerHTML = 'County';
                    postalLabel.innerHTML = 'Postcode <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = false;
                    document.getElementById('taxStateProvince').placeholder = 'County';
                    document.getElementById('taxPostalCode').placeholder = 'SW1A 1AA';
                    break;
                case 'AU':
                    stateLabel.innerHTML = 'State/Territory <span class="required">*</span>';
                    postalLabel.innerHTML = 'Postcode <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = true;
                    document.getElementById('taxStateProvince').placeholder = 'State/Territory';
                    document.getElementById('taxPostalCode').placeholder = '1000';
                    break;
                case 'DE':
                case 'AT':
                case 'CH':
                    stateLabel.innerHTML = 'State/Region';
                    postalLabel.innerHTML = 'Postleitzahl <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = false;
                    document.getElementById('taxStateProvince').placeholder = 'State/Region';
                    document.getElementById('taxPostalCode').placeholder = '10115';
                    break;
                case 'IN':
                    stateLabel.innerHTML = 'State <span class="required">*</span>';
                    postalLabel.innerHTML = 'PIN Code <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = true;
                    document.getElementById('taxStateProvince').placeholder = 'State';
                    document.getElementById('taxPostalCode').placeholder = '110001';
                    break;
                case 'JP':
                    stateLabel.innerHTML = 'Prefecture <span class="required">*</span>';
                    postalLabel.innerHTML = 'Postal Code <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = true;
                    document.getElementById('taxStateProvince').placeholder = 'Prefecture';
                    document.getElementById('taxPostalCode').placeholder = '100-0001';
                    break;
                default:
                    stateLabel.innerHTML = 'State/Province/Region';
                    postalLabel.innerHTML = 'Postal Code <span class="required">*</span>';
                    document.getElementById('taxStateProvince').required = false;
                    document.getElementById('taxStateProvince').placeholder = 'State, province, or region';
                    document.getElementById('taxPostalCode').placeholder = 'Postal code';
            }
        }

        function updateSectionsForTaxpayerType(taxpayerType) {
            const personalSection = document.getElementById('personalInfoSection');
            const businessSection = document.getElementById('businessInfoSection');
            
            if (taxpayerType === 'individual') {
                personalSection.style.display = 'block';
                businessSection.style.display = 'none';
                document.getElementById('taxFirstName').required = true;
                document.getElementById('taxLastName').required = true;
                document.getElementById('businessName').required = false;
            } else if (taxpayerType === 'business' || taxpayerType === 'nonprofit' || taxpayerType === 'partnership' || taxpayerType === 'trust') {
                personalSection.style.display = 'none';
                businessSection.style.display = 'block';
                document.getElementById('taxFirstName').required = false;
                document.getElementById('taxLastName').required = false;
                document.getElementById('businessName').required = true;
            } else {
                personalSection.style.display = 'none';
                businessSection.style.display = 'none';
                document.getElementById('taxFirstName').required = false;
                document.getElementById('taxLastName').required = false;
                document.getElementById('businessName').required = false;
            }
        }

        function updateTaxIdFields(country, taxpayerType) {
            const taxIdContainer = document.getElementById('taxIdFields');
            taxIdContainer.innerHTML = '';
            
            if (!country) return;
            
            const isIndividual = taxpayerType === 'individual';
            const isBusiness = ['business', 'nonprofit', 'partnership', 'trust'].includes(taxpayerType);
            
            let taxIdFields = [];
            
            switch(country) {
                case 'US':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'ssn', label: 'Social Security Number (SSN)', placeholder: '123-45-6789', pattern: '\\d{3}-\\d{2}-\\d{4}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'ein', label: 'Employer Identification Number (EIN)', placeholder: '12-3456789', pattern: '\\d{2}-\\d{7}', required: true }
                        ];
                    }
                    break;
                    
                case 'CA':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'sin', label: 'Social Insurance Number (SIN)', placeholder: '123 456 789', pattern: '\\d{3} \\d{3} \\d{3}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'bn', label: 'Business Number (BN)', placeholder: '123456789RT0001', required: true },
                            { id: 'gst_hst', label: 'GST/HST Registration Number', placeholder: '123456789RT0001', required: false }
                        ];
                    }
                    break;
                    
                case 'GB':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'nino', label: 'National Insurance Number (NINO)', placeholder: 'AB123456C', pattern: '[A-Z]{2}\\d{6}[A-Z]', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'utr', label: 'Unique Taxpayer Reference (UTR)', placeholder: '1234567890', pattern: '\\d{10}', required: true },
                            { id: 'vat', label: 'VAT Registration Number', placeholder: 'GB123456789', required: false }
                        ];
                    }
                    break;
                    
                case 'AU':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'tfn', label: 'Tax File Number (TFN)', placeholder: '123 456 789', pattern: '\\d{3} \\d{3} \\d{3}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'abn', label: 'Australian Business Number (ABN)', placeholder: '12 345 678 901', pattern: '\\d{2} \\d{3} \\d{3} \\d{3}', required: true },
                            { id: 'acn', label: 'Australian Company Number (ACN)', placeholder: '123 456 789', required: false }
                        ];
                    }
                    break;
                    
                case 'DE':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'steuer_id', label: 'Steuer-Identifikationsnummer', placeholder: '12345678901', pattern: '\\d{11}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'steuernummer', label: 'Steuernummer', placeholder: '12/345/67890', required: true },
                            { id: 'ust_idnr', label: 'Umsatzsteuer-Identifikationsnummer', placeholder: 'DE123456789', required: false }
                        ];
                    }
                    break;
                    
                case 'FR':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'spi', label: 'Service des Particuliers (SPI)', placeholder: '1234567890123', pattern: '\\d{13}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'siren', label: 'SIREN', placeholder: '123456789', pattern: '\\d{9}', required: true },
                            { id: 'siret', label: 'SIRET', placeholder: '12345678901234', pattern: '\\d{14}', required: false },
                            { id: 'tva', label: 'TVA Intracommunautaire', placeholder: 'FR12345678901', required: false }
                        ];
                    }
                    break;
                    
                case 'IN':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'pan', label: 'Permanent Account Number (PAN)', placeholder: 'ABCDE1234F', pattern: '[A-Z]{5}\\d{4}[A-Z]', required: true },
                            { id: 'aadhaar', label: 'Aadhaar Number', placeholder: '1234 5678 9012', pattern: '\\d{4} \\d{4} \\d{4}', required: false }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'pan', label: 'Permanent Account Number (PAN)', placeholder: 'ABCDE1234F', pattern: '[A-Z]{5}\\d{4}[A-Z]', required: true },
                            { id: 'gstin', label: 'GSTIN', placeholder: '12ABCDE3456F7Z8', required: false },
                            { id: 'tan', label: 'Tax Deduction Account Number (TAN)', placeholder: 'ABCD12345E', required: false }
                        ];
                    }
                    break;
                    
                case 'JP':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'mynumber', label: 'My Number', placeholder: '123456789012', pattern: '\\d{12}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'corporate_number', label: 'Corporate Number', placeholder: '1234567890123', pattern: '\\d{13}', required: true }
                        ];
                    }
                    break;
                    
                case 'BR':
                    if (isIndividual) {
                        taxIdFields = [
                            { id: 'cpf', label: 'CPF', placeholder: '123.456.789-01', pattern: '\\d{3}\\.\\d{3}\\.\\d{3}-\\d{2}', required: true }
                        ];
                    } else if (isBusiness) {
                        taxIdFields = [
                            { id: 'cnpj', label: 'CNPJ', placeholder: '12.345.678/0001-90', pattern: '\\d{2}\\.\\d{3}\\.\\d{3}/\\d{4}-\\d{2}', required: true }
                        ];
                    }
                    break;
                    
                default:
                    taxIdFields = [
                        { id: 'tax_id', label: 'Tax Identification Number', placeholder: 'Enter your tax ID', required: true }
                    ];
            }
            
            // Generate tax ID fields
            taxIdFields.forEach(field => {
                const fieldHtml = `
                    <div class="form-group">
                        <label>${field.label}${field.required ? ' <span class="required">*</span>' : ''}</label>
                        <input type="text" 
                               id="${field.id}" 
                               placeholder="${field.placeholder}"
                               ${field.pattern ? `pattern="${field.pattern}"` : ''}
                               ${field.required ? 'required' : ''}>
                        ${field.pattern ? `<small class="field-hint">Format: ${field.placeholder}</small>` : ''}
                    </div>
                `;
                taxIdContainer.innerHTML += fieldHtml;
            });
            
            // Load existing values if available
            const savedTaxInfo = JSON.parse(localStorage.getItem('taxInfo') || '{}');
            if (savedTaxInfo.taxIds) {
                taxIdFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element && savedTaxInfo.taxIds[field.id]) {
                        element.value = savedTaxInfo.taxIds[field.id];
                    }
                });
            }
        }

        function toggleTaxExemptDetails() {
            const checkbox = document.getElementById('taxExempt');
            const details = document.getElementById('taxExemptDetails');
            details.style.display = checkbox.checked ? 'block' : 'none';
            
            if (!checkbox.checked) {
                document.getElementById('exemptionReason').value = '';
                document.getElementById('exemptionCertificate').value = '';
            }
        }

        function saveTaxInfo(event) {
            event.preventDefault();
            
            // Collect all form data
            const formData = {
                country: document.getElementById('taxCountry').value,
                taxpayerType: document.getElementById('taxpayerType').value,
                firstName: document.getElementById('taxFirstName').value,
                lastName: document.getElementById('taxLastName').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                businessName: document.getElementById('businessName').value,
                businessType: document.getElementById('businessType').value,
                address1: document.getElementById('taxAddress1').value,
                address2: document.getElementById('taxAddress2').value,
                city: document.getElementById('taxCity').value,
                stateProvince: document.getElementById('taxStateProvince').value,
                postalCode: document.getElementById('taxPostalCode').value,
                taxExempt: document.getElementById('taxExempt').checked,
                exemptionReason: document.getElementById('exemptionReason').value,
                exemptionCertificate: document.getElementById('exemptionCertificate').value,
                notes: document.getElementById('taxNotes').value,
                lastUpdated: new Date().toISOString()
            };
            
            // Collect tax ID values
            const taxIds = {};
            const taxIdContainer = document.getElementById('taxIdFields');
            const taxIdInputs = taxIdContainer.querySelectorAll('input');
            taxIdInputs.forEach(input => {
                if (input.value) {
                    taxIds[input.id] = input.value;
                }
            });
            formData.taxIds = taxIds;
            
            // Save to localStorage (in a real app, this would be sent to a server)
            localStorage.setItem('taxInfo', JSON.stringify(formData));
            
            // Update the status indicator
            const statusIndicator = document.querySelector('.setting-value .status-indicator');
            if (statusIndicator) {
                statusIndicator.textContent = 'Complete';
                statusIndicator.className = 'status-indicator complete';
            }
            
            // Close modal and show success message
            closeModal('taxInfoModal');
            showNotification('Tax information saved successfully!', 'success');
        }

        function updateTaxInfoStatus() {
            const savedTaxInfo = JSON.parse(localStorage.getItem('taxInfo') || '{}');
            const statusIndicator = document.querySelector('.setting-value .status-indicator');
            
            if (statusIndicator) {
                if (savedTaxInfo.country && savedTaxInfo.taxpayerType && savedTaxInfo.lastUpdated) {
                    // Check if basic required fields are filled
                    let isComplete = true;
                    
                    if (savedTaxInfo.taxpayerType === 'individual') {
                        isComplete = savedTaxInfo.firstName && savedTaxInfo.lastName;
                    } else if (['business', 'nonprofit', 'partnership', 'trust'].includes(savedTaxInfo.taxpayerType)) {
                        isComplete = savedTaxInfo.businessName;
                    }
                    
                    // Check address fields
                    isComplete = isComplete && savedTaxInfo.address1 && savedTaxInfo.city && savedTaxInfo.postalCode;
                    
                    // Check tax IDs
                    isComplete = isComplete && savedTaxInfo.taxIds && Object.keys(savedTaxInfo.taxIds).length > 0;
                    
                    if (isComplete) {
                        statusIndicator.textContent = 'Complete';
                        statusIndicator.className = 'status-indicator complete';
                    } else {
                        statusIndicator.textContent = 'Incomplete';
                        statusIndicator.className = 'status-indicator incomplete';
                    }
                } else {
                    statusIndicator.textContent = 'Not Started';
                    statusIndicator.className = 'status-indicator pending';
                }
            }
        }

        function exportPayouts() {
            // Create CSV export
            const csvContent = [
                'Date,Amount,Status,Description',
                ...payoutsData.map(payout => 
                    `${payout.date},${payout.amount},${payout.status},${payout.description || ''}`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'payouts-export.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Payouts exported successfully!', 'success');
        }

        function exportTaxReport() {
            if (window.dataManager && window.dataManager.getOrders) {
                const orders = window.dataManager.getOrders() || [];
                const taxData = orders.map(order => ({
                    date: order.orderDate,
                    orderId: order.id,
                    grossAmount: order.total,
                    platformFee: order.platformFee || 0,
                    processingFee: order.processingFee || 0,
                    netAmount: order.total - (order.platformFee || 0) - (order.processingFee || 0),
                    status: order.status
                }));
                
                const csvContent = [
                    'Date,Order ID,Gross Amount,Platform Fee,Processing Fee,Net Amount,Status',
                    ...taxData.map(row => 
                        `${row.date},${row.orderId},${row.grossAmount},${row.platformFee},${row.processingFee},${row.netAmount},${row.status}`
                    )
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tax-report-${new Date().getFullYear()}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showNotification('Tax report exported successfully!', 'success');
            } else {
                showNotification('No data available for tax report', 'error');
            }
        }

        function showFilters() {
            document.getElementById('payoutFiltersPanel').style.display = 'flex';
            loadEventNamesForFilter();
        }
        
        function closeFiltersPanel() {
            document.getElementById('payoutFiltersPanel').style.display = 'none';
        }
        
        function clearFilters() {
            document.getElementById('payoutDateRange').value = 'all-time';
            document.getElementById('payoutStatus').value = '';
            document.getElementById('payoutMethod').value = '';
            document.getElementById('payoutId').value = '';
            document.getElementById('eventName').value = '';
        }
        
        function applyFilters() {
            const filters = {
                dateRange: document.getElementById('payoutDateRange').value,
                status: document.getElementById('payoutStatus').value,
                method: document.getElementById('payoutMethod').value,
                payoutId: document.getElementById('payoutId').value,
                eventName: document.getElementById('eventName').value
            };
            
            console.log('Applying filters:', filters);
            
            // Filter the payouts data based on the selected criteria
            let filteredPayouts = payoutsData.slice();
            
            // Apply date range filter
            if (filters.dateRange !== 'all-time') {
                const now = new Date();
                let startDate;
                
                switch(filters.dateRange) {
                    case 'last-7-days':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'last-30-days':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'last-90-days':
                        startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        break;
                    case 'last-year':
                        startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                if (startDate) {
                    filteredPayouts = filteredPayouts.filter(payout => 
                        new Date(payout.date) >= startDate
                    );
                }
            }
            
            // Apply status filter
            if (filters.status) {
                filteredPayouts = filteredPayouts.filter(payout => 
                    payout.status === filters.status
                );
            }
            
            // Apply method filter
            if (filters.method) {
                filteredPayouts = filteredPayouts.filter(payout => 
                    payout.method === filters.method
                );
            }
            
            // Apply payout ID filter
            if (filters.payoutId) {
                filteredPayouts = filteredPayouts.filter(payout => 
                    payout.id.includes(filters.payoutId)
                );
            }
            
            // Apply event name filter
            if (filters.eventName) {
                filteredPayouts = filteredPayouts.filter(payout => 
                    payout.eventName === filters.eventName
                );
            }
            
            // Update the displayed payouts
            payoutsData = filteredPayouts;
            loadPayoutsData();
            
            // Close the filters panel
            closeFiltersPanel();
            
            showNotification(`Filters applied. Showing ${filteredPayouts.length} payout(s).`, 'success');
        }
        
        function loadEventNamesForFilter() {
            // Populate event names dropdown with unique event names from orders/payouts
            const eventSelect = document.getElementById('eventName');
            const currentOptions = Array.from(eventSelect.options).map(option => option.value);
            
            if (window.dataManager && window.dataManager.getOrders) {
                const orders = window.dataManager.getOrders() || [];
                const uniqueEventNames = [...new Set(orders.map(order => order.eventTitle))];
                
                // Clear existing options except the first one
                while (eventSelect.options.length > 1) {
                    eventSelect.remove(1);
                }
                
                // Add event options
                uniqueEventNames.forEach(eventName => {
                    if (eventName && !currentOptions.includes(eventName)) {
                        const option = document.createElement('option');
                        option.value = eventName;
                        option.textContent = eventName;
                        eventSelect.appendChild(option);
                    }
                });
            }
        }

        function viewPayoutDetails(payoutId) {
            alert(`Viewing details for payout: ${payoutId}`);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-weight: 500;
                max-width: 400px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.createElement('div');
            dropdown.className = 'user-dropdown';
            dropdown.innerHTML = `
                <div class="dropdown-item" onclick="window.location.href='dashboard-home.html'">Dashboard</div>
                <div class="dropdown-item" onclick="window.location.href='events-calendar.html'">Events</div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="logoutUser()">Sign Out</div>
            `;
            
            dropdown.style.cssText = `
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                padding: 8px 0;
                min-width: 150px;
                z-index: 1000;
                margin-top: 8px;
            `;
            
            userMenu.style.position = 'relative';
            userMenu.appendChild(dropdown);
            
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!userMenu.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        function logoutUser() {
            if (confirm('Are you sure you want to sign out?')) {
                if (window.dataManager) {
                    window.dataManager.logout();
                } else {
                    window.location.href = 'login.html';
                }
            }
        }

        // ================== INSTANT PAYOUT FUNCTIONS (Eventbrite 2024 Feature) ==================

        async function showInstantPayoutModal() {
            try {
                // Check if instant payouts are enabled
                if (!financialData.instantPayoutsEnabled) {
                    alert('Instant payouts are not yet enabled for your account. Please contact support.');
                    return;
                }
                
                // Load bank accounts
                await loadBankAccountsForPayout();
                
                // Update available balance in modal
                document.getElementById('modalAvailableBalance').textContent = financialData.availableBalance.toFixed(2);
                
                // Show modal
                document.getElementById('instantPayoutModal').style.display = 'flex';
                
                // Set up amount input listener for real-time calculations
                const amountInput = document.getElementById('instantPayoutAmount');
                amountInput.addEventListener('input', updatePayoutCalculation);
                
            } catch (error) {
                console.error('Error opening instant payout modal:', error);
                alert('Error loading payout information. Please try again.');
            }
        }

        async function loadBankAccountsForPayout() {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/finance/accounts`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load bank accounts');
                }
                
                const data = await response.json();
                const bankSelect = document.getElementById('instantPayoutBank');
                
                if (data.success && data.bankAccounts.length > 0) {
                    // Add default option
                    let optionsHtml = '<option value="">Select a bank account</option>';
                    
                    // Add bank account options with enhanced formatting
                    optionsHtml += data.bankAccounts.map(account => {
                        const bankIcon = getBankIcon(account.bankName);
                        const accountType = account.accountType ? ` (${account.accountType})` : '';
                        const primaryLabel = account.isPrimary ? ' ‚Ä¢ Primary' : '';
                        const verifiedLabel = account.isVerified ? ' ‚úì' : ' (Pending)';
                        
                        return `<option value="${account.id}">
                            ${bankIcon} ${account.bankName} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${account.lastFour}${accountType}${primaryLabel}${verifiedLabel}
                        </option>`;
                    }).join('');
                    
                    bankSelect.innerHTML = optionsHtml;
                    
                    // Auto-select primary account if available
                    const primaryAccount = data.bankAccounts.find(acc => acc.isPrimary);
                    if (primaryAccount) {
                        bankSelect.value = primaryAccount.id;
                    }
                    
                } else {
                    bankSelect.innerHTML = `
                        <option value="">No bank accounts found</option>
                        <option value="add_new">+ Add New Bank Account</option>
                    `;
                    document.querySelector('#instantPayoutModal form button[type="submit"]').disabled = true;
                }
                
            } catch (error) {
                console.error('Error loading bank accounts:', error);
                document.getElementById('instantPayoutBank').innerHTML = '<option value="">Error loading accounts</option>';
            }
        }

        function getBankIcon(bankName) {
            const bankIcons = {
                'Chase Bank': 'üèõÔ∏è',
                'Bank of America': 'üè¶',
                'Wells Fargo': 'üè™',
                'Citibank': 'üè¢',
                'US Bank': 'üá∫üá∏',
                'PNC Bank': 'üèõÔ∏è',
                'Capital One': 'üí≥',
                'TD Bank': 'üçÅ',
                'HSBC': 'üåç',
                'JPMorgan Chase': 'üèõÔ∏è',
                'Goldman Sachs': 'üíº',
                'Morgan Stanley': 'üìà',
                'Barclays': 'üá¨üáß',
                'Deutsche Bank': 'üá©üá™',
                'Credit Suisse': 'üá®üá≠',
                'UBS': 'üè¶',
                'BNP Paribas': 'üá´üá∑',
                'Santander': 'üá™üá∏',
                'ING': 'üá≥üá±',
                'Standard Chartered': 'üåè',
                'Royal Bank of Canada': 'üçÅ',
                'Bank of Montreal': 'üèîÔ∏è',
                'Scotiabank': 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø',
                'Commonwealth Bank': 'üá¶üá∫',
                'ANZ Bank': 'üè¶',
                'Westpac': 'üá¶üá∫',
                'NAB': 'üìä',
                'ICICI Bank': 'üáÆüá≥',
                'HDFC Bank': 'üèõÔ∏è',
                'State Bank of India': 'üáÆüá≥',
                'Axis Bank': 'üìà',
                'Kotak Mahindra': 'üíº',
                'HBL': 'üáµüá∞',
                'UBL': 'üè¶',
                'MCB Bank': 'üí≥',
                'Allied Bank': 'üèõÔ∏è',
                'Bank Alfalah': 'üìä',
                'Meezan Bank': 'üïå',
                'Industrial Bank of Korea': 'üá∞üá∑',
                'Shinhan Bank': 'üè¢',
                'Kookmin Bank': 'üèõÔ∏è',
                'Woori Bank': 'üíº',
                'Hana Bank': 'üå∏',
                'SMBC': 'üáØüáµ',
                'Mizuho Bank': 'üè¶',
                'Bank of Tokyo': 'üóæ'
            };
            
            // Try exact match first
            if (bankIcons[bankName]) {
                return bankIcons[bankName];
            }
            
            // Try partial matches
            const bankNameLower = bankName.toLowerCase();
            for (const [name, icon] of Object.entries(bankIcons)) {
                if (bankNameLower.includes(name.toLowerCase()) || name.toLowerCase().includes(bankNameLower)) {
                    return icon;
                }
            }
            
            // Default bank icon
            return 'üè¶';
        }

        function updatePayoutCalculation() {
            const amount = parseFloat(document.getElementById('instantPayoutAmount').value) || 0;
            const fee = 0.25;
            const netAmount = Math.max(0, amount - fee);
            
            document.getElementById('requestedAmountDisplay').textContent = '$' + amount.toFixed(2);
            document.getElementById('netAmountDisplay').textContent = '$' + netAmount.toFixed(2);
        }

        function setMaxAmount() {
            const maxAmount = financialData.availableBalance;
            document.getElementById('instantPayoutAmount').value = maxAmount.toFixed(2);
            updatePayoutCalculation();
        }

        async function processInstantPayout(event) {
            event.preventDefault();
            
            const amount = parseFloat(document.getElementById('instantPayoutAmount').value);
            const bankAccountId = document.getElementById('instantPayoutBank').value;
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!bankAccountId) {
                alert('Please select a bank account');
                return;
            }
            
            // Handle "add new" bank account option
            if (bankAccountId === 'add_new') {
                closeModal('instantPayoutModal');
                document.getElementById('bankAccountModal').style.display = 'flex';
                alert('Please add a bank account first, then return to request your instant payout.');
                return;
            }
            
            if (amount > financialData.availableBalance) {
                alert('Amount exceeds available balance');
                return;
            }
            
            if (amount <= 0.25) {
                alert('Amount must be greater than the $0.25 fee');
                return;
            }
            
            try {
                // Disable submit button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                const response = await fetch(`${window.Config.API_BASE_URL}/finance/payouts/instant`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        bankAccountId: bankAccountId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Close modal
                    closeModal('instantPayoutModal');
                    
                    // Show success message
                    showInstantPayoutSuccess(data.payout);
                    
                    // Refresh financial data
                    await loadFinancialData();
                    updateFinancialSummary();
                    
                    // Refresh payouts list
                    if (currentTab === 'payouts') {
                        loadPayoutsData();
                    }
                    
                } else {
                    throw new Error(data.error || 'Failed to process instant payout');
                }
                
            } catch (error) {
                console.error('Error processing instant payout:', error);
                alert('Error processing instant payout: ' + error.message);
            } finally {
                // Re-enable submit button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Request Instant Payout';
            }
        }

        function showInstantPayoutSuccess(payout) {
            const successHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; padding: 32px; border-radius: 12px; max-width: 400px; text-align: center;">
                        <div style="width: 64px; height: 64px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 style="color: #1e293b; margin-bottom: 12px;">Instant Payout Requested! ‚ö°</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">
                            $${payout.netAmount.toFixed(2)} is on its way to your ${payout.bankAccount.bankName} account ending in ${payout.bankAccount.lastFour}
                        </p>
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <div style="display: flex; justify-content: between; margin-bottom: 4px;">
                                <span style="color: #64748b;">Amount:</span>
                                <span>$${(payout.netAmount + payout.fee).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: between; margin-bottom: 4px;">
                                <span style="color: #64748b;">Fee:</span>
                                <span>$${payout.fee.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: between; font-weight: 600;">
                                <span>You receive:</span>
                                <span>$${payout.netAmount.toFixed(2)}</span>
                            </div>
                        </div>
                        <button onclick="this.closest('div').remove()" 
                                style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; cursor: pointer;">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', successHtml);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function handleBankSelection(value) {
            const customBankInput = document.getElementById('customBankName');
            if (value === 'custom') {
                customBankInput.style.display = 'block';
                customBankInput.required = true;
            } else {
                customBankInput.style.display = 'none';
                customBankInput.required = false;
                customBankInput.value = '';
            }
        }
    </script>

    <style>
        /* Additional styles for enhanced finance features */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .payout-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin: 24px 0;
        }
        
        .summary-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .summary-label {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .summary-detail {
            font-size: 14px;
            color: #9ca3af;
        }
        
        .payout-schedule-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }
        
        .schedule-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .schedule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .schedule-label {
            font-weight: 500;
            color: #374151;
        }
        
        .schedule-value {
            color: #6b7280;
        }
        
        .change-schedule-btn, .change-bank-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin: 24px 0;
        }
        
        .empty-icon {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 16px;
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            color: #374151;
        }
        
        .empty-state p {
            color: #6b7280;
            margin-bottom: 24px;
        }
        
        .setup-payouts-btn {
            background: #f97316;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .settings-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-info h4 {
            margin: 0 0 4px 0;
            color: #1f2937;
        }
        
        .setting-info p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }
        
        .setting-value {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-indicator.complete {
            background: #d1fae5;
            color: #065f46;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .setting-action-btn {
            background: #e5e7eb;
            color: #374151;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .schedule-select, .amount-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .form-actions button {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .form-actions button[type="button"] {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .save-btn {
            background: #10b981;
            color: white;
            border: none;
        }
        
        .export-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-link {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            text-align: left;
            width: 100%;
        }
        
        .upcoming-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .upcoming-label {
            color: #6b7280;
            font-size: 14px;
        }
        
        .upcoming-value {
            color: #1f2937;
            font-weight: 500;
            font-size: 14px;
        }
        
        .payouts-table, .charges-table, .invoices-table {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            margin: 24px 0;
        }
        
        .table-header {
            background: #f8fafc;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 16px;
            font-weight: 500;
            color: #374151;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 16px;
            border-top: 1px solid #f3f4f6;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .action-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .charges-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin: 24px 0;
        }
        
        .invoices-header {
            margin-bottom: 24px;
        }
        
        .invoices-header h3 {
            margin-bottom: 8px;
        }
        
        .invoices-header p {
            color: #6b7280;
        }
        
        /* Filters Panel Styles */
        .filters-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .filters-panel-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .filters-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .filters-header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .clear-btn {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
        }
        
        .clear-btn:hover {
            color: #3b82f6;
        }
        
        .filters-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .filters-close:hover {
            color: #1f2937;
        }
        
        .filters-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        .filter-group {
            margin-bottom: 24px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            background: white;
            box-sizing: border-box;
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .filter-input::placeholder {
            color: #9ca3af;
        }
        
        .filters-footer {
            padding: 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .filter-btn-cancel, .filter-btn-apply {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        
        .filter-btn-cancel {
            background: white;
            color: #374151;
        }
        
        .filter-btn-cancel:hover {
            background: #f9fafb;
        }
        
        .filter-btn-apply {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .filter-btn-apply:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        /* Tax Information Modal Styles */
        .large-modal {
            max-width: 800px;
            width: 95%;
            max-height: 95vh;
        }

        .form-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-section h4 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group.half-width {
            width: 100%;
        }

        .required {
            color: #ef4444;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            line-height: 1.4;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
            margin-top: 2px;
        }

        .form-subsection {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 16px;
            margin-top: 12px;
        }

        .certification {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .required-checkbox .checkbox-label {
            font-weight: 500;
        }

        .field-hint {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }

        select, input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            font-family: inherit;
        }

        input[readonly] {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Country-specific styling */
        #taxIdFields .form-group {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        #taxIdFields .form-group:last-child {
            margin-bottom: 0;
        }

        #taxIdFields label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        /* Tax status indicator updates */
        .status-indicator.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-indicator.incomplete {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .payout-summary {
                grid-template-columns: 1fr;
            }
            
            .charges-summary {
                grid-template-columns: 1fr;
            }
            
            .schedule-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .table-header, .table-row {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .filters-panel {
                width: 100%;
                right: 0;
            }
            
            /* Tax modal responsive styles */
            .large-modal {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-section {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .form-section h4 {
                font-size: 14px;
            }
            
            select, input, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .checkbox-label {
                font-size: 13px;
            }
            
            #taxIdFields .form-group {
                padding: 12px;
            }
        }
    </style>
</body>
</html>