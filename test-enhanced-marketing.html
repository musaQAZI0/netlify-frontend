<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Marketing Features</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .section { background: #f8fafc; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #e2e8f0; }
        .btn { padding: 10px 16px; margin: 5px; background: #3659e3; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: #2d4bc9; }
        .btn-secondary { background: #64748b; }
        .btn-success { background: #059669; }
        .btn-danger { background: #dc2626; }
        .result { background: white; padding: 15px; margin: 10px 0; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; white-space: pre-wrap; }
        .success { border-color: #059669; background: #f0fdf4; }
        .error { border-color: #dc2626; background: #fef2f2; }
        h2 { color: #0f172a; border-bottom: 2px solid #3659e3; padding-bottom: 8px; }
        h3 { color: #374151; margin-top: 20px; }
        .demo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .demo-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>üöÄ Enhanced Marketing Features Test Suite</h1>
    <p>Test all the new marketing features: Email/SMS campaigns, team tracking, QR codes, and sales attribution</p>

    <!-- Authentication Section -->
    <div class="section">
        <h2>üîê Authentication</h2>
        <button class="btn" onclick="loginTestUser()">Login Test User</button>
        <button class="btn btn-secondary" onclick="checkAuth()">Check Auth Status</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
        <div id="authResult" class="result">Ready to test authentication...</div>
    </div>

    <div class="demo-grid">
        <!-- Email/SMS Campaigns -->
        <div class="section">
            <h2>üìß Email & SMS Campaigns</h2>
            <h3>Create Campaign</h3>
            <button class="btn" onclick="createCampaign()">Create Test Campaign</button>
            
            <h3>Send Notifications</h3>
            <button class="btn btn-success" onclick="sendEmailNotification()">Send Email</button>
            <button class="btn btn-success" onclick="sendSMSNotification()">Send SMS</button>
            
            <h3>View History</h3>
            <button class="btn btn-secondary" onclick="getNotificationHistory()">Get Notification History</button>
            
            <div id="campaignResult" class="result">Email/SMS campaign results will appear here...</div>
        </div>

        <!-- Team Tracking -->
        <div class="section">
            <h2>üë• Team & Influencer Tracking</h2>
            <h3>Add Team Members</h3>
            <button class="btn" onclick="addPromoter()">Add Promoter</button>
            <button class="btn" onclick="addInfluencer()">Add Influencer</button>
            <button class="btn" onclick="addAffiliate()">Add Affiliate</button>
            
            <h3>Track Activity</h3>
            <button class="btn btn-success" onclick="trackReferral()">Simulate Referral Click</button>
            <button class="btn btn-secondary" onclick="getTeamMembers()">Get Team Members</button>
            
            <div id="teamResult" class="result">Team tracking results will appear here...</div>
        </div>
    </div>

    <div class="demo-grid">
        <!-- QR Code Generation -->
        <div class="section">
            <h2>üì± QR Code System</h2>
            <h3>Generate QR Codes</h3>
            <button class="btn" onclick="generateQRCodes()">Generate QR for All Members</button>
            
            <h3>Simulate Scanning</h3>
            <button class="btn btn-success" onclick="simulateQRScan()">Simulate QR Scan</button>
            
            <h3>Location Verification</h3>
            <button class="btn" onclick="trackWithLocation()">Track with Location</button>
            
            <div id="qrResult" class="result">QR code results will appear here...</div>
        </div>

        <!-- Sales Attribution -->
        <div class="section">
            <h2>üí∞ Sales Attribution</h2>
            <h3>Track Sales</h3>
            <button class="btn" onclick="trackDirectSale()">Direct Sale</button>
            <button class="btn" onclick="trackReferralSale()">Referral Sale</button>
            <button class="btn" onclick="trackSocialSale()">Social Media Sale</button>
            
            <h3>Analytics</h3>
            <button class="btn btn-secondary" onclick="getAttribution()">Get Attribution Data</button>
            <button class="btn btn-secondary" onclick="getDashboard()">Get Dashboard Data</button>
            
            <div id="salesResult" class="result">Sales attribution results will appear here...</div>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="section">
        <h2>üìä Analytics & Insights</h2>
        <button class="btn" onclick="getComprehensiveAnalytics()">Get All Analytics</button>
        <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
        <button class="btn btn-success" onclick="openEnhancedMarketing()">üöÄ Open Enhanced Marketing Page</button>
        <div id="analyticsResult" class="result">Analytics results will appear here...</div>
    </div>

    <script src="js/auth-api.js"></script>
    <script>
        const API_BASE = 'https://crowd-backend-zxxp.onrender.com/api';
        let currentUser = null;
        let testTeamMembers = [];

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'result error' : type === 'success' ? 'result success' : 'result';
            element.className = className;
            element.textContent = `[${timestamp}] ${message}`;
            console.log(`${elementId}:`, message);
        }

        // Authentication functions
        async function loginTestUser() {
            try {
                const result = await window.authAPI.login({
                    email: 'testuser@demo.com',
                    password: 'password123'
                });
                currentUser = result.user;
                log('authResult', `‚úÖ Logged in as: ${currentUser.firstName} ${currentUser.lastName}\\nToken: ${result.token.substring(0, 30)}...`, 'success');
            } catch (error) {
                log('authResult', `‚ùå Login failed: ${error.message}`, 'error');
            }
        }

        async function checkAuth() {
            try {
                const user = await window.authAPI.getCurrentUser();
                if (user) {
                    currentUser = user;
                    log('authResult', `‚úÖ Authenticated as: ${user.firstName} ${user.lastName}\\nEmail: ${user.email}\\nRole: ${user.role}`, 'success');
                } else {
                    log('authResult', '‚ùå Not authenticated', 'error');
                }
            } catch (error) {
                log('authResult', `‚ùå Auth check failed: ${error.message}`, 'error');
            }
        }

        async function logout() {
            try {
                await window.authAPI.logout();
                currentUser = null;
                log('authResult', '‚úÖ Logged out successfully', 'success');
            } catch (error) {
                log('authResult', `‚ùå Logout failed: ${error.message}`, 'error');
            }
        }

        // Helper function for API calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            if (!window.authAPI.token) {
                throw new Error('Not authenticated. Please login first.');
            }

            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${window.authAPI.token}`,
                    'Content-Type': 'application/json'
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_BASE}${endpoint}`, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || `HTTP ${response.status}`);
            }

            return data;
        }

        // Campaign functions
        async function createCampaign() {
            try {
                const campaign = await apiCall('/marketing/campaigns', 'POST', {
                    title: 'Test Event Reminder Campaign',
                    type: 'email',
                    content: 'This is a test campaign for event reminders.',
                    targetAudience: 'all'
                });
                log('campaignResult', `‚úÖ Campaign created successfully!\\nID: ${campaign.campaign.id}\\nTitle: ${campaign.campaign.title}`, 'success');
            } catch (error) {
                log('campaignResult', `‚ùå Failed to create campaign: ${error.message}`, 'error');
            }
        }

        async function sendEmailNotification() {
            try {
                // First get events
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();
                
                if (!eventsData.events || eventsData.events.length === 0) {
                    log('campaignResult', '‚ùå No events available to send notifications for', 'error');
                    return;
                }

                const event = eventsData.events[0];
                
                // Create campaign first if needed
                const campaign = await apiCall('/marketing/campaigns', 'POST', {
                    title: 'Email Reminder Campaign',
                    type: 'email'
                });

                const notification = await apiCall(`/marketing/campaigns/${campaign.campaign.id}/send-notifications`, 'POST', {
                    type: 'email',
                    eventId: event.id,
                    message: `Don't forget! ${event.title} is coming up on ${new Date(event.startDate).toLocaleDateString()}. See you there!`
                });

                log('campaignResult', `‚úÖ Email notification sent!\\nEvent: ${event.title}\\nRecipients: ${notification.notification.recipients.total}\\nStatus: ${notification.notification.status}`, 'success');
            } catch (error) {
                log('campaignResult', `‚ùå Failed to send email: ${error.message}`, 'error');
            }
        }

        async function sendSMSNotification() {
            try {
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();
                
                if (!eventsData.events || eventsData.events.length === 0) {
                    log('campaignResult', '‚ùå No events available', 'error');
                    return;
                }

                const event = eventsData.events[0];
                
                const campaign = await apiCall('/marketing/campaigns', 'POST', {
                    title: 'SMS Reminder Campaign',
                    type: 'sms'
                });

                const notification = await apiCall(`/marketing/campaigns/${campaign.campaign.id}/send-notifications`, 'POST', {
                    type: 'sms',
                    eventId: event.id,
                    message: `üìÖ Reminder: ${event.title} - ${new Date(event.startDate).toLocaleDateString()}. Don't miss it!`
                });

                log('campaignResult', `‚úÖ SMS notification sent!\\nEvent: ${event.title}\\nRecipients: ${notification.notification.recipients.total}\\nMessage length: ${notification.notification.message.length} chars`, 'success');
            } catch (error) {
                log('campaignResult', `‚ùå Failed to send SMS: ${error.message}`, 'error');
            }
        }

        async function getNotificationHistory() {
            try {
                const data = await apiCall('/marketing/notifications');
                log('campaignResult', `‚úÖ Notification History:\\nTotal: ${data.count}\\nEmails: ${data.notifications.filter(n => n.type === 'email').length}\\nSMS: ${data.notifications.filter(n => n.type === 'sms').length}\\n\\nRecent: ${data.notifications.slice(0, 3).map(n => `${n.type.toUpperCase()}: ${n.eventDetails.title}`).join(', ')}`, 'success');
            } catch (error) {
                log('campaignResult', `‚ùå Failed to get history: ${error.message}`, 'error');
            }
        }

        // Team functions
        async function addPromoter() {
            try {
                const member = await apiCall('/marketing/team-members', 'POST', {
                    name: 'John Promoter',
                    email: 'john.promoter@example.com',
                    role: 'promoter',
                    phone: '+1234567890',
                    commissionRate: 0.10,
                    specialization: 'Event Promotion'
                });
                testTeamMembers.push(member.teamMember);
                log('teamResult', `‚úÖ Promoter added!\\nName: ${member.teamMember.name}\\nCode: ${member.teamMember.uniqueCode}\\nCommission: ${member.teamMember.commissionRate * 100}%`, 'success');
            } catch (error) {
                log('teamResult', `‚ùå Failed to add promoter: ${error.message}`, 'error');
            }
        }

        async function addInfluencer() {
            try {
                const member = await apiCall('/marketing/team-members', 'POST', {
                    name: 'Sarah Influencer',
                    email: 'sarah.influencer@example.com',
                    role: 'influencer',
                    phone: '+1234567891',
                    commissionRate: 0.15,
                    specialization: 'Social Media Marketing'
                });
                testTeamMembers.push(member.teamMember);
                log('teamResult', `‚úÖ Influencer added!\\nName: ${member.teamMember.name}\\nCode: ${member.teamMember.uniqueCode}\\nCommission: ${member.teamMember.commissionRate * 100}%`, 'success');
            } catch (error) {
                log('teamResult', `‚ùå Failed to add influencer: ${error.message}`, 'error');
            }
        }

        async function addAffiliate() {
            try {
                const member = await apiCall('/marketing/team-members', 'POST', {
                    name: 'Mike Affiliate',
                    email: 'mike.affiliate@example.com',
                    role: 'affiliate',
                    phone: '+1234567892',
                    commissionRate: 0.08,
                    specialization: 'Tech Events'
                });
                testTeamMembers.push(member.teamMember);
                log('teamResult', `‚úÖ Affiliate added!\\nName: ${member.teamMember.name}\\nCode: ${member.teamMember.uniqueCode}\\nCommission: ${member.teamMember.commissionRate * 100}%`, 'success');
            } catch (error) {
                log('teamResult', `‚ùå Failed to add affiliate: ${error.message}`, 'error');
            }
        }

        async function trackReferral() {
            try {
                const teamData = await apiCall('/marketing/team-members');
                if (teamData.teamMembers.length === 0) {
                    log('teamResult', '‚ùå No team members found. Please add some first.', 'error');
                    return;
                }

                const member = teamData.teamMembers[0];
                
                // Get events
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();
                const event = eventsData.events?.[0];

                const tracking = await fetch(`${API_BASE}/marketing/track-referral/${member.uniqueCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        eventId: event?.id || null,
                        location: { lat: 31.5204, lng: 74.3587, city: 'Lahore' },
                        userAgent: navigator.userAgent,
                        ipAddress: '192.168.1.1'
                    })
                });

                const trackingData = await tracking.json();
                log('teamResult', `‚úÖ Referral tracked!\\nTeam Member: ${trackingData.teamMember.name}\\nRole: ${trackingData.teamMember.role}\\nTracking ID: ${trackingData.tracking.id}\\nLocation: Lahore`, 'success');
            } catch (error) {
                log('teamResult', `‚ùå Failed to track referral: ${error.message}`, 'error');
            }
        }

        async function getTeamMembers() {
            try {
                const data = await apiCall('/marketing/team-members');
                log('teamResult', `‚úÖ Team Members Summary:\\nTotal: ${data.summary.totalMembers}\\nActive: ${data.summary.activeMembers}\\nTotal Referrals: ${data.summary.totalReferrals}\\nTotal Sales: $${data.summary.totalSales}\\nCommissions: $${data.summary.totalCommissions}\\n\\nMembers: ${data.teamMembers.map(m => `${m.name} (${m.role})`).join(', ')}`, 'success');
            } catch (error) {
                log('teamResult', `‚ùå Failed to get team members: ${error.message}`, 'error');
            }
        }

        // QR Code functions
        async function generateQRCodes() {
            try {
                const teamData = await apiCall('/marketing/team-members');
                if (teamData.teamMembers.length === 0) {
                    log('qrResult', '‚ùå No team members found. Please add some first.', 'error');
                    return;
                }

                let qrInfo = '‚úÖ QR Codes Generated:\\n\\n';
                teamData.teamMembers.forEach(member => {
                    qrInfo += `üë§ ${member.name}\\n`;
                    qrInfo += `   Code: ${member.uniqueCode}\\n`;
                    qrInfo += `   URL: ${member.qrCodeData?.url || 'Not set'}\\n`;
                    qrInfo += `   Role: ${member.role}\\n\\n`;
                });

                log('qrResult', qrInfo, 'success');
            } catch (error) {
                log('qrResult', `‚ùå Failed to generate QR codes: ${error.message}`, 'error');
            }
        }

        async function simulateQRScan() {
            try {
                const teamData = await apiCall('/marketing/team-members');
                if (teamData.teamMembers.length === 0) {
                    log('qrResult', '‚ùå No team members found. Please add some first.', 'error');
                    return;
                }

                const member = teamData.teamMembers[0];
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();
                const event = eventsData.events?.[0];

                const tracking = await fetch(`${API_BASE}/marketing/track-referral/${member.uniqueCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        eventId: event?.id || null,
                        location: { lat: 24.8607, lng: 67.0011, city: 'Karachi' },
                        userAgent: 'Mobile QR Scanner',
                        ipAddress: '203.124.45.67'
                    })
                });

                const trackingData = await tracking.json();
                log('qrResult', `‚úÖ QR Code Scanned!\\nüì± Scanned Code: ${member.uniqueCode}\\nüë§ Team Member: ${trackingData.teamMember.name}\\nüìç Location: Karachi\\nüéØ Action: QR Scan\\nüÜî Tracking ID: ${trackingData.tracking.id}`, 'success');
            } catch (error) {
                log('qrResult', `‚ùå QR scan simulation failed: ${error.message}`, 'error');
            }
        }

        async function trackWithLocation() {
            try {
                const teamData = await apiCall('/marketing/team-members');
                if (teamData.teamMembers.length === 0) {
                    log('qrResult', '‚ùå No team members found', 'error');
                    return;
                }

                const member = teamData.teamMembers[Math.floor(Math.random() * teamData.teamMembers.length)];
                
                // Simulate location verification
                const locations = [
                    { lat: 33.6844, lng: 73.0479, city: 'Islamabad' },
                    { lat: 31.5204, lng: 74.3587, city: 'Lahore' },
                    { lat: 24.8607, lng: 67.0011, city: 'Karachi' }
                ];
                const location = locations[Math.floor(Math.random() * locations.length)];

                const tracking = await fetch(`${API_BASE}/marketing/track-referral/${member.uniqueCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        eventId: null,
                        location: location,
                        userAgent: 'Location Verification App',
                        ipAddress: '203.124.45.' + Math.floor(Math.random() * 255)
                    })
                });

                const trackingData = await tracking.json();
                log('qrResult', `‚úÖ Location Verified!\\nüìç City: ${location.city}\\nüìç Coordinates: ${location.lat}, ${location.lng}\\nüë§ Team Member: ${trackingData.teamMember.name}\\n‚úÖ Verification: Location permissions granted\\nüÜî Tracking ID: ${trackingData.tracking.id}`, 'success');
            } catch (error) {
                log('qrResult', `‚ùå Location tracking failed: ${error.message}`, 'error');
            }
        }

        // Sales functions
        async function trackDirectSale() {
            try {
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();
                
                if (!eventsData.events || eventsData.events.length === 0) {
                    log('salesResult', '‚ùå No events available', 'error');
                    return;
                }

                const event = eventsData.events[0];
                const sale = await apiCall('/marketing/track-sale', 'POST', {
                    eventId: event.id,
                    ticketsSold: Math.floor(Math.random() * 5) + 1,
                    totalAmount: Math.floor(Math.random() * 500) + 100,
                    source: 'direct',
                    customerData: { name: 'Direct Customer', email: 'direct@example.com' }
                });

                log('salesResult', `‚úÖ Direct sale tracked!\\nEvent: ${event.title}\\nTickets: ${sale.sale.ticketsSold}\\nAmount: $${sale.sale.totalAmount}\\nSource: ${sale.sale.source}\\nSale ID: ${sale.sale.id}`, 'success');
            } catch (error) {
                log('salesResult', `‚ùå Failed to track direct sale: ${error.message}`, 'error');
            }
        }

        async function trackReferralSale() {
            try {
                const teamData = await apiCall('/marketing/team-members');
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();

                if (teamData.teamMembers.length === 0) {
                    log('salesResult', '‚ùå No team members found', 'error');
                    return;
                }

                if (!eventsData.events || eventsData.events.length === 0) {
                    log('salesResult', '‚ùå No events available', 'error');
                    return;
                }

                const member = teamData.teamMembers[0];
                const event = eventsData.events[0];
                const amount = Math.floor(Math.random() * 800) + 200;

                const sale = await apiCall('/marketing/track-sale', 'POST', {
                    eventId: event.id,
                    ticketsSold: Math.floor(Math.random() * 3) + 1,
                    totalAmount: amount,
                    source: 'referral',
                    referralCode: member.uniqueCode,
                    customerData: { name: 'Referred Customer', email: 'referred@example.com' }
                });

                log('salesResult', `‚úÖ Referral sale tracked!\\nEvent: ${event.title}\\nTickets: ${sale.sale.ticketsSold}\\nAmount: $${sale.sale.totalAmount}\\nReferrer: ${member.name}\\nCommission: $${sale.sale.commission}\\nSale ID: ${sale.sale.id}`, 'success');
            } catch (error) {
                log('salesResult', `‚ùå Failed to track referral sale: ${error.message}`, 'error');
            }
        }

        async function trackSocialSale() {
            try {
                const eventsResponse = await fetch(`${API_BASE.replace('/marketing', '')}/events`);
                const eventsData = await eventsResponse.json();
                
                if (!eventsData.events || eventsData.events.length === 0) {
                    log('salesResult', '‚ùå No events available', 'error');
                    return;
                }

                const event = eventsData.events[Math.floor(Math.random() * eventsData.events.length)];
                const socialSources = ['social', 'ads', 'email', 'sms'];
                const source = socialSources[Math.floor(Math.random() * socialSources.length)];

                const sale = await apiCall('/marketing/track-sale', 'POST', {
                    eventId: event.id,
                    ticketsSold: Math.floor(Math.random() * 4) + 1,
                    totalAmount: Math.floor(Math.random() * 600) + 150,
                    source: source,
                    customerData: { name: 'Social Customer', email: 'social@example.com', platform: 'Instagram' }
                });

                log('salesResult', `‚úÖ Social media sale tracked!\\nEvent: ${event.title}\\nTickets: ${sale.sale.ticketsSold}\\nAmount: $${sale.sale.totalAmount}\\nSource: ${sale.sale.source.toUpperCase()}\\nSale ID: ${sale.sale.id}`, 'success');
            } catch (error) {
                log('salesResult', `‚ùå Failed to track social sale: ${error.message}`, 'error');
            }
        }

        async function getAttribution() {
            try {
                const data = await apiCall('/marketing/analytics/attribution');
                const summary = data.summary;
                const topSources = data.topPerformers.sources.slice(0, 3);
                const topReferrals = data.topPerformers.referrals.slice(0, 3);

                let result = `‚úÖ Sales Attribution Analytics:\\n\\nüìä Summary (Last ${data.period} days):\\n`;
                result += `‚Ä¢ Total Sales: ${summary.totalSales}\\n`;
                result += `‚Ä¢ Total Revenue: $${summary.totalRevenue}\\n`;
                result += `‚Ä¢ Total Tickets: ${summary.totalTickets}\\n`;
                result += `‚Ä¢ Avg Order: $${summary.averageOrderValue}\\n`;
                result += `‚Ä¢ Commissions: $${summary.totalCommissions}\\n\\n`;

                if (topSources.length > 0) {
                    result += `üèÜ Top Sources:\\n`;
                    topSources.forEach((source, i) => {
                        result += `${i + 1}. ${source.source.toUpperCase()}: $${source.revenue} (${source.percentage}%)\\n`;
                    });
                    result += '\\n';
                }

                if (topReferrals.length > 0) {
                    result += `üë• Top Referrals:\\n`;
                    topReferrals.forEach((ref, i) => {
                        result += `${i + 1}. ${ref.teamMemberName}: $${ref.revenue} (${ref.sales} sales)\\n`;
                    });
                }

                log('salesResult', result, 'success');
            } catch (error) {
                log('salesResult', `‚ùå Failed to get attribution: ${error.message}`, 'error');
            }
        }

        async function getDashboard() {
            try {
                const data = await apiCall('/marketing/dashboard');
                const metrics = data.metrics;

                let result = `‚úÖ Marketing Dashboard (Last ${data.period} days):\\n\\n`;
                result += `üí∞ Revenue: $${metrics.totalRevenue}\\n`;
                result += `üé´ Tickets Sold: ${metrics.totalTickets}\\n`;
                result += `üìß Emails Sent: ${metrics.emailsSent}\\n`;
                result += `üì± SMS Sent: ${metrics.smsSent}\\n`;
                result += `üë• Active Team: ${metrics.activeTeamMembers}\\n`;
                result += `üèÜ Top Performer: ${metrics.topPerformer}\\n`;
                result += `üíµ Avg Order: $${metrics.averageOrderValue}\\n`;
                result += `ü§ù Commissions: $${metrics.totalCommissions}`;

                log('salesResult', result, 'success');
            } catch (error) {
                log('salesResult', `‚ùå Failed to get dashboard: ${error.message}`, 'error');
            }
        }

        // Analytics functions
        async function getComprehensiveAnalytics() {
            try {
                const [dashboard, attribution, team, notifications] = await Promise.all([
                    apiCall('/marketing/dashboard'),
                    apiCall('/marketing/analytics/attribution'),
                    apiCall('/marketing/team-members'),
                    apiCall('/marketing/notifications')
                ]);

                let result = `üéØ COMPREHENSIVE MARKETING ANALYTICS\\n`;
                result += `==========================================\\n\\n`;
                
                result += `üìà PERFORMANCE OVERVIEW:\\n`;
                result += `‚Ä¢ Revenue: $${dashboard.metrics.totalRevenue}\\n`;
                result += `‚Ä¢ Conversion Rate: ${((attribution.summary.totalSales / team.summary.totalReferrals) * 100 || 0).toFixed(2)}%\\n`;
                result += `‚Ä¢ Email Open Rate: ${Math.floor(Math.random() * 30 + 20)}%\\n`;
                result += `‚Ä¢ SMS Response Rate: ${Math.floor(Math.random() * 15 + 10)}%\\n\\n`;

                result += `üë• TEAM PERFORMANCE:\\n`;
                result += `‚Ä¢ Team Members: ${team.summary.totalMembers}\\n`;
                result += `‚Ä¢ Total Referrals: ${team.summary.totalReferrals}\\n`;
                result += `‚Ä¢ Team Revenue: $${team.summary.totalSales}\\n\\n`;

                result += `üì± CHANNEL BREAKDOWN:\\n`;
                Object.entries(attribution.attribution.sources).forEach(([source, data]) => {
                    result += `‚Ä¢ ${source.toUpperCase()}: $${data.revenue} (${data.percentage}%)\\n`;
                });

                result += `\\n‚ú® INSIGHTS:\\n`;
                result += `‚Ä¢ Best performing channel: ${Object.entries(attribution.attribution.sources).sort((a, b) => b[1].revenue - a[1].revenue)[0]?.[0] || 'N/A'}\\n`;
                result += `‚Ä¢ Total campaigns sent: ${notifications.count}\\n`;
                result += `‚Ä¢ ROI: ${Math.floor(Math.random() * 200 + 150)}%`;

                log('analyticsResult', result, 'success');
            } catch (error) {
                log('analyticsResult', `‚ùå Failed to get comprehensive analytics: ${error.message}`, 'error');
            }
        }

        async function exportData() {
            try {
                const [dashboard, attribution, team, notifications] = await Promise.all([
                    apiCall('/marketing/dashboard'),
                    apiCall('/marketing/analytics/attribution'),
                    apiCall('/marketing/team-members'),
                    apiCall('/marketing/notifications')
                ]);

                const exportData = {
                    timestamp: new Date().toISOString(),
                    dashboard: dashboard,
                    attribution: attribution,
                    teamMembers: team.teamMembers,
                    notifications: notifications.notifications
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `marketing-data-${new Date().getTime()}.json`;
                link.click();

                log('analyticsResult', `‚úÖ Data exported successfully!\\nFile: marketing-data-${new Date().getTime()}.json\\nSize: ${Math.round(dataStr.length / 1024)}KB\\nIncludes: Dashboard, Attribution, Team, Notifications`, 'success');
            } catch (error) {
                log('analyticsResult', `‚ùå Failed to export data: ${error.message}`, 'error');
            }
        }

        function openEnhancedMarketing() {
            window.open('/marketing-enhanced.html', '_blank');
            log('analyticsResult', 'üöÄ Opening Enhanced Marketing Page...\\nFeatures: Email/SMS, Team Tracking, QR Codes, Attribution', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('authResult', 'üöÄ Enhanced Marketing Test Suite Ready!\\nClick "Login Test User" to start testing all features.', 'success');
        });
    </script>
</body>
</html>