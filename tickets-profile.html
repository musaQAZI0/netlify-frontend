<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile | Crowd</title>
    <link rel="stylesheet" href="tickets-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <div class="logo">
                    <span style="font-size: 2rem; font-weight: bold; color: #ff5722;">crowd</span>
                </div>
                <div class="search-container">
                    <div class="search-box">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M10 14c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm3.5.9c-1 .7-2.2 1.1-3.5 1.1-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6c0 1.3-.4 2.5-1.1 3.4l5.1 5.1-1.5 1.5-5-5.1z" fill="#666"/>
                        </svg>
                        <input type="text" placeholder="Search events" class="search-input">
                    </div>
                </div>
            </div>
            <div class="header-right">
                <a href="#" class="browse-events">Browse Events</a>
                <a href="#" class="create-event">Create an event</a>
                <div class="nav-menu">
                    <span class="nav-item">Organize <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M7 10.2l5 5 5-5-1.4-1.4-3.6 3.6-3.6-3.6z" fill="#666"/></svg></span>
                    <span class="nav-item">Help <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M7 10.2l5 5 5-5-1.4-1.4-3.6 3.6-3.6-3.6z" fill="#666"/></svg></span>
                </div>
                <div class="user-menu">
                    <svg class="user-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 18c-1.2 0-2.4-.3-3.5-.7.6-1.3 2-2.2 3.5-2.2s2.9.9 3.5 2.2c-1.1.4-2.3.7-3.5.7zm6.5-2.9c-.4.4-.8.8-1.3 1.1a5.989 5.989 0 00-10.6 0c-.5-.3-.9-.7-1.3-1.1L4 16.5c2.1 2.3 5 3.5 8 3.5s5.9-1.3 8-3.5l-1.5-1.4z" fill="#666"/>
                        <path d="M12 4C9.7 4 7.8 5.9 7.8 8.2s1.9 4.2 4.2 4.2 4.2-1.9 4.2-4.2S14.3 4 12 4zm0 6.4c-1.2 0-2.2-1-2.2-2.2C9.8 7 10.8 6 12 6s2.2 1 2.2 2.2c0 1.2-1 2.2-2.2 2.2z" fill="#666"/>
                    </svg>
                    <span class="user-email" id="userEmailDisplay">Loading...</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                        <path d="M7 10.2l5 5 5-5-1.4-1.4-3.6 3.6-3.6-3.6z" fill="#666"/>
                    </svg>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                        <path d="M5.2 19.1c1-2.8 3.7-4.7 6.7-4.7s5.7 1.9 6.7 4.7c-4.1 2.5-9.3 2.5-13.4 0zm16.1-1.9c-.5.5-1.1 1-1.7 1.5a8.15 8.15 0 00-7.6-5.2c-3.3 0-6.3 2.1-7.6 5.1-.6-.4-1.1-.9-1.6-1.4l-.8.7C4.8 20.6 8.4 22 12 22s7.2-1.4 10-4.1l-.7-.7z" fill="#999"/>
                        <path d="M12 2C9.2 2 7 4.2 7 7s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 9c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z" fill="#999"/>
                    </svg>
                </div>
                <div class="profile-info">
                    <div class="profile-name">
                        <h1 id="userNameDisplay">Loading...</h1>
                        <button class="edit-button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M6 17l8-8 1 1-8 8-1-1zm-2-.3V20h3.3l9.8-9.8-3.3-3.3L4 16.7z" fill="#666"/>
                                <path d="M19.7 7.6c.3-.3.3-.9 0-1.3l-2.1-2.1c-.3-.3-.9-.3-1.3 0l-1.6 1.6L18 9.1l1.7-1.5z" fill="#666"/>
                            </svg>
                        </button>
                    </div>
                    <div class="profile-stats">
                        <span class="stat">0 orders</span>
                        <span class="divider">•</span>
                        <span class="stat">0 likes</span>
                        <span class="divider">•</span>
                        <span class="stat">0 following</span>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <section class="orders-section">
                <h2>Orders</h2>
                <div class="orders-content">
                    <div class="email-verification">
                        <h3>Looking for your tickets?</h3>
                        <p>You need to verify your email to view transfers and gifts.</p>
                        <button class="verify-button">Verify your email</button>
                    </div>
                    <div class="ticket-illustration">
                        <svg width="120" height="80" viewBox="0 0 120 80" fill="none">
                            <rect x="10" y="20" width="100" height="40" rx="4" stroke="#ddd" stroke-width="2" fill="none" stroke-dasharray="4,4"/>
                            <circle cx="10" cy="40" r="8" fill="white" stroke="#ddd" stroke-width="2"/>
                            <circle cx="110" cy="40" r="8" fill="white" stroke="#ddd" stroke-width="2"/>
                            <line x1="30" y1="30" x2="90" y2="30" stroke="#ddd" stroke-width="1"/>
                            <line x1="30" y1="35" x2="70" y2="35" stroke="#ddd" stroke-width="1"/>
                            <line x1="30" y1="45" x2="90" y2="45" stroke="#ddd" stroke-width="1"/>
                            <line x1="30" y1="50" x2="60" y2="50" stroke="#ddd" stroke-width="1"/>
                        </svg>
                    </div>
                </div>
                <div class="past-orders">
                    <button class="see-past-orders">See past orders</button>
                </div>
            </section>

            <!-- Interests Section -->
            <section class="interests-section">
                <div class="interests-header">
                    <h2>Interests</h2>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M10.2 17l5-5-5-5-1.4 1.4 3.6 3.6-3.6 3.6z" fill="#666"/>
                    </svg>
                </div>
            </section>

            <!-- Tickets Missing Alert -->
            <div class="tickets-alert">
                <div class="alert-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M11 11h2v5h-2zm0-3h2v2h-2zm1-2c3.308 0 6 2.692 6 6s-2.692 6-6 6-6-2.692-6-6 2.692-6 6-6m0 14a8 8 0 1 0 0-16 8 8 0 0 0 0 16" fill="#3A3247"/>
                    </svg>
                </div>
                <div class="alert-content">
                    <div class="alert-title">Tickets missing?</div>
                    <a href="#" class="alert-link">Find my tickets</a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-copyright">© 2025 Crowd</div>
            <div class="footer-links">
                <a href="#">About</a>
                <a href="#">Blog</a>
                <a href="#">Help</a>
                <a href="#">Careers</a>
                <a href="#">Press</a>
                <a href="#">Impact</a>
                <a href="#">Investors</a>
                <a href="#">Security</a>
                <a href="#">Developers</a>
                <a href="#">Status</a>
                <a href="#">Terms</a>
                <a href="#">Privacy</a>
                <a href="#">Accessibility</a>
                <a href="#">Cookies</a>
                <a href="#">Manage Cookie Preferences</a>
            </div>
            <div class="footer-region">
                <select class="region-select">
                    <option value="en_US">United States</option>
                    <option value="en_GB">United Kingdom</option>
                    <option value="en_CA">Canada (EN)</option>
                    <option value="fr_CA">Canada (FR)</option>
                </select>
            </div>
        </div>
    </footer>

    <script src="js/data-manager.js"></script>
    <script src="js/auth-api.js"></script>
    <script src="tickets-script.js"></script>
    <script>
        let currentUser = null;
        let userTickets = [];

        // Load user profile data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserProfile();
            await loadUserTickets();
            loadUserOrders();
        });

        async function loadUserProfile() {
            try {
                // Check if user is authenticated using the auth API
                if (window.authAPI && window.authAPI.isAuthenticated()) {
                    const user = await window.authAPI.getCurrentUser();
                    if (user) {
                        currentUser = user;
                        // Update user email in header
                        const userEmailElement = document.getElementById('userEmailDisplay');
                        if (userEmailElement) {
                            userEmailElement.textContent = user.email;
                        }

                        // Update user name in profile section
                        const userNameElement = document.getElementById('userNameDisplay');
                        if (userNameElement) {
                            // Use the user's first and last name or fallback to email username
                            const displayName = (user.firstName && user.lastName) 
                                ? `${user.firstName} ${user.lastName}` 
                                : user.name || user.email.split('@')[0];
                            userNameElement.textContent = displayName;
                        }

                        // Update profile stats
                        await updateProfileStats(user);

                        console.log('User profile loaded from database:', user.email);
                    } else {
                        // User data not available, redirect to login
                        console.log('User data not available, redirecting to login');
                        window.location.href = 'login.html';
                    }
                } else {
                    // User not authenticated, redirect to login
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                window.location.href = 'login.html';
            }
        }

        async function updateProfileStats(user) {
            try {
                // Fetch user stats from backend
                const stats = await fetchUserStats(user.id);
                const statsElements = document.querySelectorAll('.stat');
                
                if (statsElements.length >= 3) {
                    statsElements[0].textContent = `${stats.orders || 0} orders`;
                    statsElements[1].textContent = `${stats.likes || 0} likes`;
                    statsElements[2].textContent = `${stats.following || 0} following`;
                }
            } catch (error) {
                console.error('Error updating profile stats:', error);
            }
        }

        async function fetchUserStats(userId) {
            try {
                const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/users/${userId}/stats`, {
                    headers: {
                        'Authorization': `Bearer ${window.authAPI.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.stats || {};
                }
            } catch (error) {
                console.error('Error fetching user stats:', error);
            }
            return {};
        }

        async function loadUserTickets() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/users/${currentUser.id}/tickets`, {
                    headers: {
                        'Authorization': `Bearer ${window.authAPI.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userTickets = data.tickets || [];
                    displayUserTickets();
                }
            } catch (error) {
                console.error('Error loading user tickets:', error);
            }
        }

        function displayUserTickets() {
            const ordersContent = document.querySelector('.orders-content');
            
            if (userTickets.length > 0) {
                // Replace the email verification with actual tickets
                ordersContent.innerHTML = `
                    <div class="tickets-list">
                        <h3>Your Tickets (${userTickets.length})</h3>
                        <div class="tickets-grid">
                            ${userTickets.map(ticket => `
                                <div class="ticket-card">
                                    <div class="ticket-info">
                                        <h4>${ticket.eventTitle}</h4>
                                        <p class="ticket-date">${new Date(ticket.eventDate).toLocaleDateString()}</p>
                                        <p class="ticket-location">${ticket.eventLocation}</p>
                                        <p class="ticket-type">${ticket.type} - Qty: ${ticket.quantity}</p>
                                    </div>
                                    <div class="ticket-actions">
                                        <button class="view-ticket-btn" onclick="viewTicket('${ticket.id}')">View Ticket</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Show the email verification message if no tickets
                ordersContent.innerHTML = `
                    <div class="email-verification">
                        <h3>Looking for your tickets?</h3>
                        <p>You don't have any tickets yet. Start browsing events to get your first ticket!</p>
                        <button class="browse-events-button" onclick="window.location.href='index.html'">Browse Events</button>
                    </div>
                    <div class="ticket-illustration">
                        <svg width="120" height="80" viewBox="0 0 120 80" fill="none">
                            <rect x="10" y="20" width="100" height="40" rx="4" stroke="#ddd" stroke-width="2" fill="none" stroke-dasharray="4,4"/>
                            <circle cx="10" cy="40" r="8" fill="white" stroke="#ddd" stroke-width="2"/>
                            <circle cx="110" cy="40" r="8" fill="white" stroke="#ddd" stroke-width="2"/>
                            <line x1="30" y1="30" x2="90" y2="30" stroke="#ddd" stroke-width="1"/>
                            <line x1="30" y1="35" x2="70" y2="35" stroke="#ddd" stroke-width="1"/>
                            <line x1="30" y1="45" x2="90" y2="45" stroke="#ddd" stroke-width="1"/>
                            <line x1="30" y1="50" x2="60" y2="50" stroke="#ddd" stroke-width="1"/>
                        </svg>
                    </div>
                `;
            }
        }

        async function loadUserOrders() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/users/${currentUser.id}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${window.authAPI.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const orders = data.orders || [];
                    
                    // Update past orders button
                    const pastOrdersBtn = document.querySelector('.see-past-orders');
                    if (pastOrdersBtn) {
                        pastOrdersBtn.textContent = `See past orders (${orders.length})`;
                        pastOrdersBtn.onclick = () => showPastOrders(orders);
                    }
                }
            } catch (error) {
                console.error('Error loading user orders:', error);
            }
        }

        function showPastOrders(orders) {
            if (orders.length === 0) {
                alert('No past orders found.');
                return;
            }
            
            // Create a modal or new section to show past orders
            const modal = document.createElement('div');
            modal.className = 'orders-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Past Orders</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${orders.map(order => `
                            <div class="order-item">
                                <h4>Order #${order.id}</h4>
                                <p>Date: ${new Date(order.createdAt).toLocaleDateString()}</p>
                                <p>Total: $${order.total}</p>
                                <p>Status: ${order.status}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function viewTicket(ticketId) {
            // Implement ticket viewing functionality
            console.log('Viewing ticket:', ticketId);
            alert(`Ticket viewing functionality would open ticket ${ticketId}`);
        }

        // Handle logout if user menu logout is clicked
        async function logout() {
            try {
                if (window.authAPI) {
                    await window.authAPI.logout();
                }
                // Clear local storage
                localStorage.removeItem('user');
                localStorage.removeItem('authToken');
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                // Still redirect even if logout fails
                window.location.href = 'login.html';
            }
        }

        // Verify email button functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('verify-button')) {
                alert('Email verification functionality would be implemented here.');
            }
        });
    </script>
</body>
</html>
