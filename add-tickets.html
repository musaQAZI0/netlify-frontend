<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Tickets - Crowd</title>
    <link rel="stylesheet" href="add-tickets-styles.css">
    <script src="js/data-manager.js"></script>
</head>
<body>
    <div class="tickets-container">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <div class="sidebar-content">
                <div class="back-link">
                    <a href="event-builder.html">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                        Back to event details
                    </a>
                </div>
                
                <div class="event-summary">
                    <div class="event-image-placeholder" id="sidebarEventImage"></div>
                    <h2 id="sidebarEventTitle">Event Title</h2>
                    <div class="event-datetime">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" x2="16" y1="2" y2="6"/>
                            <line x1="8" x2="8" y1="2" y2="6"/>
                            <line x1="3" x2="21" y1="10" y2="10"/>
                        </svg>
                        <span id="sidebarEventDateTime">Mon, Sep 1, 2025, 10:00 AM</span>
                    </div>
                    
                    <select class="status-select" id="eventStatus">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                    </select>
                    
                    <a href="#" class="preview-link" onclick="previewEvent()">Preview ‚Üó</a>
                </div>

                <div class="steps-section">
                    <h3>Steps</h3>
                    <div class="step-item completed" onclick="goToBuilder()">
                        <div class="step-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 12l2 2 4-4"/>
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <h4>Build event page</h4>
                            <p>Add all of your event details and let attendees know what to expect</p>
                        </div>
                    </div>
                    
                    <div class="step-item active" id="ticketsStep">
                        <div class="step-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <h4>Add tickets</h4>
                            <p>Use our suggestions to help sell more tickets or manually create your own</p>
                        </div>
                    </div>
                    
                    <div class="step-item" id="publishStep" onclick="goToPublish()">
                        <div class="step-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <h4>Publish</h4>
                            <p>Review your event page and settings, then publish your event</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="#f05537">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span>crowd</span>
                    </div>
                    <div class="header-right">
                        <button class="preview-btn" onclick="previewEvent()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            Preview Your Event
                        </button>
                        <button class="publish-btn" onclick="goToPublish()">Publish</button>
                        <div class="user-menu">
                            <div class="user-avatar" id="userAvatar">AA</div>
                            <span class="user-name" id="userName">abdul ahad</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <div class="content-header">
                    <h1>Add tickets</h1>
                    <p>Create tickets for your event. You can add multiple ticket types with different prices and availability.</p>
                </div>

                <div class="tickets-content">
                    <!-- Ticket Type Selection -->
                    <div class="ticket-type-section">
                        <h3>Choose ticket type</h3>
                        <div class="ticket-type-buttons">
                            <button class="ticket-type-btn active" data-type="paid" onclick="selectTicketType('paid')">
                                <div class="ticket-type-icon">üí≥</div>
                                <div class="ticket-type-info">
                                    <h4>Paid</h4>
                                    <p>Charge attendees for tickets</p>
                                </div>
                            </button>
                            <button class="ticket-type-btn" data-type="free" onclick="selectTicketType('free')">
                                <div class="ticket-type-icon">üé´</div>
                                <div class="ticket-type-info">
                                    <h4>Free</h4>
                                    <p>Let attendees register for free</p>
                                </div>
                            </button>
                            <button class="ticket-type-btn" data-type="donation" onclick="selectTicketType('donation')">
                                <div class="ticket-type-icon">‚ù§Ô∏è</div>
                                <div class="ticket-type-info">
                                    <h4>Donation</h4>
                                    <p>Accept donations from attendees</p>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Existing Tickets List -->
                    <div class="existing-tickets" id="existingTickets">
                        <h3>Your tickets</h3>
                        <div class="tickets-list" id="ticketsList">
                            <!-- Tickets will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="save-section">
                <button class="save-btn" onclick="saveAndContinue()">Save and continue</button>
            </div>
        </main>

        <!-- Right Sidebar - Ticket Form -->
        <aside class="right-sidebar" id="rightSidebar">
            <div class="sidebar-content">
                <div class="form-header">
                    <h3 id="formTitle">Add paid ticket</h3>
                    <button class="close-btn" onclick="closeTicketForm()">√ó</button>
                </div>

                <form class="ticket-form" id="ticketForm">
                    <!-- Ticket Name -->
                    <div class="form-group">
                        <label for="ticketName">Ticket name *</label>
                        <input type="text" id="ticketName" placeholder="e.g. General Admission" required>
                    </div>

                    <!-- Ticket Price (for paid tickets) -->
                    <div class="form-group" id="priceGroup">
                        <label for="ticketPrice">Price *</label>
                        <div class="price-input">
                            <span class="currency">$</span>
                            <input type="number" id="ticketPrice" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Donation Amount (for donation tickets) -->
                    <div class="form-group" id="donationGroup" style="display: none;">
                        <label for="suggestedDonation">Suggested donation amount</label>
                        <div class="price-input">
                            <span class="currency">$</span>
                            <input type="number" id="suggestedDonation" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="form-group">
                        <label for="ticketQuantity">Quantity available</label>
                        <input type="number" id="ticketQuantity" placeholder="100" min="1">
                        <small>Leave blank for unlimited</small>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="ticketDescription">Description</label>
                        <textarea id="ticketDescription" placeholder="Describe what's included with this ticket"></textarea>
                    </div>

                    <!-- Sale Period -->
                    <div class="form-group">
                        <label>Sale period</label>
                        <div class="date-inputs">
                            <div class="date-input-group">
                                <label for="saleStart">Start</label>
                                <input type="datetime-local" id="saleStart">
                            </div>
                            <div class="date-input-group">
                                <label for="saleEnd">End</label>
                                <input type="datetime-local" id="saleEnd">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="advanced-settings">
                        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
                            Advanced settings
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="advanced-content" id="advancedContent" style="display: none;">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="requireApproval">
                                    Require approval before purchase
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="minQuantity">Minimum quantity per order</label>
                                <input type="number" id="minQuantity" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="maxQuantity">Maximum quantity per order</label>
                                <input type="number" id="maxQuantity" placeholder="10" min="1">
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeTicketForm()">Cancel</button>
                        <button type="submit" class="save-ticket-btn">Save ticket</button>
                    </div>
                </form>
            </div>
        </aside>
    </div>

    <script>
        let currentEventData = {};
        let currentTicketType = 'paid';
        let editingTicketId = null;
        let eventTickets = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!window.dataManager.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            loadUserData();
            loadEventData();
            loadTickets();
            initializeForm();
            showTicketForm(); // Show form by default
        });

        function loadUserData() {
            const currentUser = window.dataManager.getCurrentUser();
            if (currentUser) {
                const initials = (currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0)).toUpperCase();
                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
        }

        function loadEventData() {
            try {
                const editingEvent = JSON.parse(localStorage.getItem('editingEvent') || '{}');
                if (editingEvent.id) {
                    // Get fresh event data from data manager
                    const freshEventData = window.dataManager.getEventById(editingEvent.id);
                    if (freshEventData) {
                        currentEventData = freshEventData;
                        populateEventInfo();
                    } else {
                        console.error('Event not found in data manager');
                        window.location.href = 'event-builder.html';
                    }
                } else {
                    // Redirect back to event builder if no event data
                    window.location.href = 'event-builder.html';
                }
            } catch (error) {
                console.error('Failed to load event data:', error);
                window.location.href = 'event-builder.html';
            }
        }

        function populateEventInfo() {
            document.getElementById('sidebarEventTitle').textContent = currentEventData.title;
            document.getElementById('eventStatus').value = currentEventData.status;
            
            if (currentEventData.image) {
                document.getElementById('sidebarEventImage').style.backgroundImage = `url(${currentEventData.image})`;
                document.getElementById('sidebarEventImage').style.backgroundSize = 'cover';
            }
            
            // Update date time display
            const date = new Date(currentEventData.date);
            const startTime = formatTime(currentEventData.startTime);
            const sidebarDisplay = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            }) + `, ${startTime}`;
            document.getElementById('sidebarEventDateTime').textContent = sidebarDisplay;
        }

        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}${minutes !== '00' ? ':' + minutes : ''}${ampm}`;
        }

        function loadTickets() {
            try {
                // Get tickets from the event data in data manager
                eventTickets = currentEventData.tickets || [];
                renderTicketsList();
            } catch (error) {
                console.error('Failed to load tickets:', error);
                eventTickets = [];
                renderTicketsList();
            }
        }

        function renderTicketsList() {
            const ticketsList = document.getElementById('ticketsList');
            
            if (eventTickets.length === 0) {
                ticketsList.innerHTML = `
                    <div class="no-tickets">
                        <p>No tickets created yet. Use the form on the right to add your first ticket.</p>
                    </div>
                `;
                return;
            }

            ticketsList.innerHTML = eventTickets.map(ticket => `
                <div class="ticket-item" data-ticket-id="${ticket.id}">
                    <div class="ticket-info">
                        <h4>${ticket.name}</h4>
                        <p class="ticket-price">${ticket.type === 'free' ? 'Free' : ticket.type === 'donation' ? 'Donation' : '$' + ticket.price}</p>
                        <p class="ticket-quantity">${ticket.quantity ? ticket.quantity + ' available' : 'Unlimited'}</p>
                    </div>
                    <div class="ticket-actions">
                        <button class="edit-btn" onclick="editTicket('${ticket.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteTicket('${ticket.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function selectTicketType(type) {
            currentTicketType = type;
            
            // Update button states
            document.querySelectorAll('.ticket-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update form
            updateFormForTicketType(type);
            showTicketForm();
        }

        function updateFormForTicketType(type) {
            const priceGroup = document.getElementById('priceGroup');
            const donationGroup = document.getElementById('donationGroup');
            const formTitle = document.getElementById('formTitle');
            
            // Reset form
            document.getElementById('ticketForm').reset();
            editingTicketId = null;
            
            switch(type) {
                case 'paid':
                    formTitle.textContent = 'Add paid ticket';
                    priceGroup.style.display = 'block';
                    donationGroup.style.display = 'none';
                    document.getElementById('ticketPrice').required = true;
                    break;
                case 'free':
                    formTitle.textContent = 'Add free ticket';
                    priceGroup.style.display = 'none';
                    donationGroup.style.display = 'none';
                    break;
                case 'donation':
                    formTitle.textContent = 'Add donation ticket';
                    priceGroup.style.display = 'none';
                    donationGroup.style.display = 'block';
                    break;
            }
        }

        function showTicketForm() {
            document.getElementById('rightSidebar').classList.add('active');
        }

        function closeTicketForm() {
            document.getElementById('rightSidebar').classList.remove('active');
            document.getElementById('ticketForm').reset();
            editingTicketId = null;
        }

        function initializeForm() {
            document.getElementById('ticketForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTicket();
            });
        }

        function saveTicket() {
            try {
                // Validate required fields
                const ticketName = document.getElementById('ticketName').value.trim();
                if (!ticketName) {
                    alert('Please enter a ticket name.');
                    return;
                }
                
                if (currentTicketType === 'paid') {
                    const price = parseFloat(document.getElementById('ticketPrice').value);
                    if (isNaN(price) || price < 0) {
                        alert('Please enter a valid price.');
                        return;
                    }
                }
                
                const ticketData = {
                    name: ticketName,
                    type: currentTicketType,
                    price: currentTicketType === 'paid' ? parseFloat(document.getElementById('ticketPrice').value) : 0,
                    suggestedDonation: currentTicketType === 'donation' ? parseFloat(document.getElementById('suggestedDonation').value) || 0 : 0,
                    quantity: document.getElementById('ticketQuantity').value ? parseInt(document.getElementById('ticketQuantity').value) : 0,
                    description: document.getElementById('ticketDescription').value.trim(),
                    salesStart: document.getElementById('saleStart').value,
                    salesEnd: document.getElementById('saleEnd').value,
                    requiresApproval: document.getElementById('requireApproval').checked,
                    minQuantity: parseInt(document.getElementById('minQuantity').value) || 1,
                    maxQuantity: document.getElementById('maxQuantity').value ? parseInt(document.getElementById('maxQuantity').value) : 10
                };

                if (editingTicketId) {
                    // Update existing ticket using data manager
                    const updatedTicket = window.dataManager.updateTicket(currentEventData.id, editingTicketId, ticketData);
                    showNotification('Ticket updated successfully!');
                } else {
                    // Add new ticket using data manager
                    const newTicket = window.dataManager.addTicketToEvent(currentEventData.id, ticketData);
                    showNotification('Ticket created successfully!');
                }
                
                // Refresh event data and tickets
                currentEventData = window.dataManager.getEventById(currentEventData.id);
                eventTickets = currentEventData.tickets || [];
                
                // Update localStorage for cross-page persistence
                localStorage.setItem('editingEvent', JSON.stringify(currentEventData));
                
                // Update display
                renderTicketsList();
                closeTicketForm();
                
            } catch (error) {
                console.error('Failed to save ticket:', error);
                alert('Failed to save ticket: ' + error.message);
            }
        }

        function editTicket(ticketId) {
            const ticket = eventTickets.find(t => t.id === ticketId);
            if (!ticket) return;

            editingTicketId = ticketId;
            currentTicketType = ticket.type;
            
            // Update ticket type selection
            selectTicketType(ticket.type);
            
            // Populate form
            document.getElementById('ticketName').value = ticket.name;
            document.getElementById('ticketPrice').value = ticket.price;
            document.getElementById('suggestedDonation').value = ticket.suggestedDonation;
            document.getElementById('ticketQuantity').value = ticket.quantity || '';
            document.getElementById('ticketDescription').value = ticket.description;
            document.getElementById('saleStart').value = ticket.saleStart;
            document.getElementById('saleEnd').value = ticket.saleEnd;
            document.getElementById('requireApproval').checked = ticket.requireApproval;
            document.getElementById('minQuantity').value = ticket.minQuantity;
            document.getElementById('maxQuantity').value = ticket.maxQuantity || '';
            
            // Update form title
            document.getElementById('formTitle').textContent = `Edit ${ticket.type} ticket`;
            
            showTicketForm();
        }

        function deleteTicket(ticketId) {
            if (confirm('Are you sure you want to delete this ticket?')) {
                try {
                    // Find the ticket to delete
                    const ticketIndex = eventTickets.findIndex(t => t.id === ticketId);
                    if (ticketIndex === -1) {
                        alert('Ticket not found.');
                        return;
                    }
                    
                    // Remove ticket from event using data manager
                    const updatedTickets = eventTickets.filter(t => t.id !== ticketId);
                    const updatedEvent = window.dataManager.updateEvent(currentEventData.id, {
                        tickets: updatedTickets
                    });
                    
                    // Update local data
                    currentEventData = updatedEvent;
                    eventTickets = updatedEvent.tickets || [];
                    
                    // Update localStorage
                    localStorage.setItem('editingEvent', JSON.stringify(currentEventData));
                    
                    renderTicketsList();
                    showNotification('Ticket deleted successfully!');
                    
                } catch (error) {
                    console.error('Failed to delete ticket:', error);
                    alert('Failed to delete ticket: ' + error.message);
                }
            }
        }

        function generateTicketId() {
            return window.dataManager.generateId();
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const toggle = document.querySelector('.advanced-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.classList.add('expanded');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('expanded');
            }
        }

        function showNotification(message) {
            // Simple notification - you can enhance this
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function saveAndContinue() {
            try {
                // Validate that at least one ticket exists
                if (!eventTickets || eventTickets.length === 0) {
                    alert('Please create at least one ticket before continuing.');
                    return;
                }
                
                // Update event with current status
                const updatedEvent = window.dataManager.updateEvent(currentEventData.id, {
                    ticketsConfigured: true,
                    updatedAt: new Date().toISOString()
                });
                
                // Update localStorage
                localStorage.setItem('editingEvent', JSON.stringify(updatedEvent));
                
                // Mark tickets step as completed
                const ticketsStep = document.getElementById('ticketsStep');
                if (ticketsStep) {
                    ticketsStep.classList.add('completed');
                    ticketsStep.classList.remove('active');
                    const stepIcon = ticketsStep.querySelector('.step-icon');
                    if (stepIcon) {
                        stepIcon.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 12l2 2 4-4"/>
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        `;
                    }
                }
                
                // Navigate to publish page
                window.location.href = 'publish-event.html';
                
            } catch (error) {
                console.error('Failed to save and continue:', error);
                alert('Failed to save progress: ' + error.message);
            }
        }

        function previewEvent() {
            try {
                // Update localStorage with current event data
                localStorage.setItem('editingEvent', JSON.stringify(currentEventData));
                window.location.href = 'event-preview.html';
            } catch (error) {
                console.error('Failed to save event data for preview:', error);
                window.location.href = 'event-preview.html';
            }
        }

        function goToPublish() {
            window.location.href = 'publish-event.html';
        }

        function goToBuilder() {
            window.location.href = 'event-builder.html';
        }
    </script>
</body>
</html>
