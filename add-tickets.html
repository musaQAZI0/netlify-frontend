<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Tickets - Crowd</title>
    <link rel="stylesheet" href="add-tickets-styles.css">
</head>
<body>
    <div class="tickets-container">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <div class="sidebar-content">
                <div class="back-link">
                    <a href="event-builder.html">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                        Back to event details
                    </a>
                </div>
                
                <div class="event-summary">
                    <div class="event-image-placeholder" id="sidebarEventImage"></div>
                    <h2 id="sidebarEventTitle">Event Title</h2>
                    <div class="event-datetime">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" x2="16" y1="2" y2="6"/>
                            <line x1="8" x2="8" y1="2" y2="6"/>
                            <line x1="3" x2="21" y1="10" y2="10"/>
                        </svg>
                        <span id="sidebarEventDateTime">Mon, Sep 1, 2025, 10:00 AM</span>
                    </div>
                    
                    <select class="status-select" id="eventStatus">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                    </select>
                    
                    <a href="#" class="preview-link" onclick="previewEvent()">Preview ‚Üó</a>
                </div>

                <div class="steps-section">
                    <h3>Steps</h3>
                    <div class="step-item completed" onclick="goToBuilder()">
                        <div class="step-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 12l2 2 4-4"/>
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <h4>Build event page</h4>
                            <p>Add all of your event details and let attendees know what to expect</p>
                        </div>
                    </div>
                    
                    <div class="step-item active" id="ticketsStep">
                        <div class="step-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <h4>Add tickets</h4>
                            <p>Use our suggestions to help sell more tickets or manually create your own</p>
                        </div>
                    </div>
                    
                    <div class="step-item" id="publishStep" onclick="goToPublish()">
                        <div class="step-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <h4>Publish</h4>
                            <p>Review your event page and settings, then publish your event</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="#f05537">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span>crowd</span>
                    </div>
                    <div class="header-right">
                        <button class="preview-btn" onclick="previewEvent()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            Preview Your Event
                        </button>
                        <button class="publish-btn" onclick="goToPublish()">Publish</button>
                        <div class="user-menu">
                            <div class="user-avatar" id="userAvatar">AA</div>
                            <span class="user-name" id="userName">abdul ahad</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <div class="content-header">
                    <h1>Add tickets</h1>
                    <p>Create tickets for your event. You can add multiple ticket types with different prices and availability.</p>
                </div>

                <div class="tickets-content">
                    <!-- Ticket Type Selection -->
                    <div class="ticket-type-section">
                        <h3>Choose ticket type</h3>
                        <div class="ticket-type-buttons">
                            <button class="ticket-type-btn active" data-type="paid" onclick="selectTicketType('paid')">
                                <div class="ticket-type-icon">üí≥</div>
                                <div class="ticket-type-info">
                                    <h4>Paid</h4>
                                    <p>Charge attendees for tickets</p>
                                </div>
                            </button>
                            <button class="ticket-type-btn" data-type="free" onclick="selectTicketType('free')">
                                <div class="ticket-type-icon">üé´</div>
                                <div class="ticket-type-info">
                                    <h4>Free</h4>
                                    <p>Let attendees register for free</p>
                                </div>
                            </button>
                            <button class="ticket-type-btn" data-type="donation" onclick="selectTicketType('donation')">
                                <div class="ticket-type-icon">‚ù§Ô∏è</div>
                                <div class="ticket-type-info">
                                    <h4>Donation</h4>
                                    <p>Accept donations from attendees</p>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Existing Tickets List -->
                    <div class="existing-tickets" id="existingTickets">
                        <h3>Your tickets</h3>
                        <div class="tickets-list" id="ticketsList">
                            <!-- Tickets will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="save-section">
                <button class="save-btn" onclick="saveAndContinue()">Save and continue</button>
            </div>
        </main>

        <!-- Right Sidebar - Ticket Form -->
        <aside class="right-sidebar" id="rightSidebar">
            <div class="sidebar-content">
                <div class="form-header">
                    <h3 id="formTitle">Add paid ticket</h3>
                    <button class="close-btn" onclick="closeTicketForm()">√ó</button>
                </div>

                <form class="ticket-form" id="ticketForm">
                    <!-- Ticket Name -->
                    <div class="form-group">
                        <label for="ticketName">Ticket name *</label>
                        <input type="text" id="ticketName" placeholder="e.g. General Admission" required>
                    </div>

                    <!-- Ticket Price (for paid tickets) -->
                    <div class="form-group" id="priceGroup">
                        <label for="ticketPrice">Price *</label>
                        <div class="price-input">
                            <span class="currency">$</span>
                            <input type="number" id="ticketPrice" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Donation Amount (for donation tickets) -->
                    <div class="form-group" id="donationGroup" style="display: none;">
                        <label for="suggestedDonation">Suggested donation amount</label>
                        <div class="price-input">
                            <span class="currency">$</span>
                            <input type="number" id="suggestedDonation" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="form-group">
                        <label for="ticketQuantity">Quantity available</label>
                        <input type="number" id="ticketQuantity" placeholder="100" min="1">
                        <small>Leave blank for unlimited</small>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="ticketDescription">Description</label>
                        <textarea id="ticketDescription" placeholder="Describe what's included with this ticket"></textarea>
                    </div>

                    <!-- Sale Period -->
                    <div class="form-group">
                        <label>Sale period</label>
                        <div class="date-inputs">
                            <div class="date-input-group">
                                <label for="saleStart">Start</label>
                                <input type="datetime-local" id="saleStart">
                            </div>
                            <div class="date-input-group">
                                <label for="saleEnd">End</label>
                                <input type="datetime-local" id="saleEnd">
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Tier Selection -->
                    <div class="form-group">
                        <label for="inventoryTier">Inventory Tier (Optional)</label>
                        <select id="inventoryTier">
                            <option value="">No tier (General)</option>
                        </select>
                        <small>Assign this ticket class to a specific inventory tier</small>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="advanced-settings">
                        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
                            Advanced settings
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="advanced-content" id="advancedContent" style="display: none;">
                            <!-- Quantity Restrictions -->
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="requireApproval">
                                    Require approval before purchase
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="minQuantity">Minimum quantity per order</label>
                                <input type="number" id="minQuantity" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="maxQuantity">Maximum quantity per order</label>
                                <input type="number" id="maxQuantity" placeholder="10" min="1">
                            </div>

                            <!-- Visibility Settings -->
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="hiddenTicket">
                                    Hide this ticket class from public view
                                </label>
                            </div>

                            <!-- Fee Settings -->
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="includeFee">
                                    Include fees in displayed price
                                </label>
                                <small>When checked, the displayed price includes all fees</small>
                            </div>

                            <!-- Sales Channels -->
                            <div class="form-group">
                                <label>Sales Channels</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="channelOnline" checked> Online</label>
                                    <label><input type="checkbox" id="channelAtd"> At the door</label>
                                    <label><input type="checkbox" id="channelFacebook"> Facebook</label>
                                </div>
                            </div>

                            <!-- Delivery Methods -->
                            <div class="form-group">
                                <label>Delivery Methods</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="deliveryElectronic" checked> Electronic</label>
                                    <label><input type="checkbox" id="deliveryPhysical"> Physical mail</label>
                                    <label><input type="checkbox" id="deliveryWillCall"> Will call</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeTicketForm()">Cancel</button>
                        <button type="submit" class="save-ticket-btn">Save ticket</button>
                    </div>
                </form>
            </div>
        </aside>
    </div>

    <script>
        let currentEventData = {};
        let currentTicketType = 'paid';
        let editingTicketId = null;
        let eventTickets = [];
        let inventoryTiers = [];
        let ticketGroups = [];

        document.addEventListener('DOMContentLoaded', async function() {
            // Pure database authentication check
            const isAuthenticated = await checkAuthenticationStatus();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            await loadUserData();
            await loadEventData();
            loadTickets();
            initializeForm();
            showTicketForm(); // Show form by default
        });

        async function loadUserData() {
            try {
                const response = await fetch('https://crowd-backend-zxxp.onrender.com/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        const user = data.user;
                        const initials = (user.firstName?.charAt(0) + user.lastName?.charAt(0)).toUpperCase() || 'U';
                        document.getElementById('userAvatar').textContent = initials;
                        document.getElementById('userName').textContent = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User';
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: Failed to load profile`);
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                // Don't redirect, just show default user info
                document.getElementById('userAvatar').textContent = 'U';
                document.getElementById('userName').textContent = 'User';
            }
        }

        async function loadEventData() {
            try {
                // Get event ID from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('id');

                if (!eventId) {
                    console.error('No event ID provided');
                    window.location.href = 'event-builder.html';
                    return;
                }

                // Fetch event data and advanced ticket classes
                console.log('Fetching ticket classes for event:', eventId);
                console.log('Auth token present:', getAuthToken() ? 'Yes' : 'No');

                const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}/ticket-classes`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);

                    // If ticket-classes endpoint doesn't exist (404), fallback to regular event endpoint
                    if (response.status === 404) {
                        console.log('Ticket classes endpoint not found, falling back to regular event API');
                        await loadEventDataFallback(eventId);
                        return;
                    }

                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('Ticket classes API response:', data);

                if (data.success) {
                    // Also fetch basic event data
                    const eventResponse = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });

                    console.log('Event API response status:', eventResponse.status);

                    if (eventResponse.ok) {
                        const eventData = await eventResponse.json();
                        console.log('Event data:', eventData);

                        if (eventData.success) {
                            currentEventData = eventData.event;
                            // Store advanced ticket data
                            currentEventData.ticketClasses = data.ticketClasses || [];
                            currentEventData.inventoryTiers = data.inventoryTiers || [];
                            currentEventData.ticketGroups = data.ticketGroups || [];
                            currentEventData.inventoryInfo = data.inventoryInfo || {};

                            populateEventInfo();
                            loadInventoryTiers();
                            loadTicketGroups();
                        } else {
                            throw new Error('Event API returned error: ' + eventData.message);
                        }
                    } else {
                        const eventErrorText = await eventResponse.text();
                        throw new Error(`Failed to fetch event data: HTTP ${eventResponse.status} - ${eventErrorText}`);
                    }
                } else {
                    throw new Error('Ticket classes API returned error: ' + data.message);
                }
            } catch (error) {
                console.error('Failed to load event data:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    eventId: urlParams.get('id'),
                    authToken: getAuthToken() ? 'Present' : 'Missing'
                });
                alert(`Failed to load event data: ${error.message}. Please check console for details.`);
                // Don't redirect immediately, let user see the error
                // window.location.href = 'event-builder.html';
            }
        }

        // Fallback function for when ticket-classes endpoint doesn't exist
        async function loadEventDataFallback(eventId) {
            console.log('Using fallback event loading method');

            const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            if (data.success) {
                currentEventData = data.event;
                // Initialize empty advanced features for backward compatibility
                currentEventData.ticketClasses = currentEventData.pricing?.tickets || [];
                currentEventData.inventoryTiers = [];
                currentEventData.ticketGroups = [];
                currentEventData.inventoryInfo = { hasAdmissionTiers: false };

                populateEventInfo();
                loadInventoryTiers();
                loadTicketGroups();
            } else {
                throw new Error('Event API returned error: ' + data.message);
            }
        }

        // Pure database authentication check
        async function checkAuthenticationStatus() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.log('No auth token found');
                    return false;
                }

                const response = await fetch('https://crowd-backend-zxxp.onrender.com/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                console.log('Auth verification result:', data);

                return response.ok && data.success;
            } catch (error) {
                console.error('Authentication check failed:', error);
                return false;
            }
        }

        function getAuthToken() {
            // Get from URL parameters first (for direct links)
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('token');

            // Fall back to localStorage only for minimal compatibility
            if (!token) {
                token = localStorage.getItem('authToken') ||
                       localStorage.getItem('token') ||
                       localStorage.getItem('jwt') || '';
            }

            console.log('Auth token found:', token ? 'Yes (length: ' + token.length + ')' : 'No');
            return token;
        }

        function populateEventInfo() {
            document.getElementById('sidebarEventTitle').textContent = currentEventData.title;
            document.getElementById('eventStatus').value = currentEventData.status;
            
            if (currentEventData.image) {
                document.getElementById('sidebarEventImage').style.backgroundImage = `url(${currentEventData.image})`;
                document.getElementById('sidebarEventImage').style.backgroundSize = 'cover';
            }
            
            // Update date time display
            const date = new Date(currentEventData.date);
            const startTime = formatTime(currentEventData.startTime);
            const sidebarDisplay = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            }) + `, ${startTime}`;
            document.getElementById('sidebarEventDateTime').textContent = sidebarDisplay;
        }

        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}${minutes !== '00' ? ':' + minutes : ''}${ampm}`;
        }

        function loadTickets() {
            try {
                // Get advanced ticket classes from the event data
                eventTickets = currentEventData.ticketClasses || [];
                renderTicketsList();
            } catch (error) {
                console.error('Failed to load tickets:', error);
                eventTickets = [];
                renderTicketsList();
            }
        }

        function loadInventoryTiers() {
            try {
                inventoryTiers = currentEventData.inventoryTiers || [];
                populateInventoryTierOptions();
            } catch (error) {
                console.error('Failed to load inventory tiers:', error);
                inventoryTiers = [];
            }
        }

        function loadTicketGroups() {
            try {
                ticketGroups = currentEventData.ticketGroups || [];
                renderTicketGroups();
            } catch (error) {
                console.error('Failed to load ticket groups:', error);
                ticketGroups = [];
            }
        }

        function renderTicketsList() {
            const ticketsList = document.getElementById('ticketsList');

            if (eventTickets.length === 0) {
                ticketsList.innerHTML = `
                    <div class="no-tickets">
                        <p>No ticket classes created yet. Use the form on the right to add your first ticket class.</p>
                    </div>
                `;
                return;
            }

            ticketsList.innerHTML = eventTickets.map(ticket => {
                let priceDisplay = '';
                if (ticket.type === 'free') {
                    priceDisplay = 'Free';
                } else if (ticket.type === 'donation') {
                    priceDisplay = ticket.suggestedDonation > 0 ?
                        `Donation (suggested: $${ticket.suggestedDonation})` : 'Donation';
                } else {
                    priceDisplay = `$${ticket.cost?.value || 0}`;
                }

                const quantityDisplay = ticket.quantity?.total ?
                    `${ticket.quantity.total} available (${ticket.quantity.sold || 0} sold)` :
                    'Unlimited';

                const tierName = ticket.inventoryTierId ?
                    getInventoryTierName(ticket.inventoryTierId) : '';

                return `
                    <div class="ticket-item" data-ticket-id="${ticket.id}">
                        <div class="ticket-info">
                            <h4>${ticket.name}</h4>
                            <p class="ticket-price">${priceDisplay}</p>
                            <p class="ticket-quantity">${quantityDisplay}</p>
                            ${tierName ? `<p class="ticket-tier">Tier: ${tierName}</p>` : ''}
                            <p class="ticket-type-badge">${ticket.type.toUpperCase()}</p>
                            ${ticket.visibility?.hidden ? '<p class="ticket-hidden">Hidden</p>' : ''}
                        </div>
                        <div class="ticket-actions">
                            <button class="edit-btn" onclick="editTicket('${ticket.id}')">Edit</button>
                            <button class="delete-btn" onclick="deleteTicket('${ticket.id}')">Delete</button>
                            <button class="remaining-btn" onclick="showRemainingTickets('${ticket.id}')">Remaining</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getInventoryTierName(tierId) {
            const tier = inventoryTiers.find(t => t.id === tierId);
            return tier ? tier.name : '';
        }

        function selectTicketType(type) {
            currentTicketType = type;
            
            // Update button states
            document.querySelectorAll('.ticket-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update form
            updateFormForTicketType(type);
            showTicketForm();
        }

        function updateFormForTicketType(type) {
            const priceGroup = document.getElementById('priceGroup');
            const donationGroup = document.getElementById('donationGroup');
            const formTitle = document.getElementById('formTitle');
            
            // Reset form
            document.getElementById('ticketForm').reset();
            editingTicketId = null;
            
            switch(type) {
                case 'paid':
                    formTitle.textContent = 'Add paid ticket';
                    priceGroup.style.display = 'block';
                    donationGroup.style.display = 'none';
                    document.getElementById('ticketPrice').required = true;
                    break;
                case 'free':
                    formTitle.textContent = 'Add free ticket';
                    priceGroup.style.display = 'none';
                    donationGroup.style.display = 'none';
                    break;
                case 'donation':
                    formTitle.textContent = 'Add donation ticket';
                    priceGroup.style.display = 'none';
                    donationGroup.style.display = 'block';
                    break;
            }
        }

        function showTicketForm() {
            document.getElementById('rightSidebar').classList.add('active');
        }

        function closeTicketForm() {
            document.getElementById('rightSidebar').classList.remove('active');
            document.getElementById('ticketForm').reset();
            editingTicketId = null;
        }

        function initializeForm() {
            document.getElementById('ticketForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTicket();
            });
        }

        async function saveTicket() {
            try {
                // Validate required fields
                const ticketName = document.getElementById('ticketName').value.trim();
                if (!ticketName) {
                    alert('Please enter a ticket name.');
                    return;
                }

                if (currentTicketType === 'paid') {
                    const price = parseFloat(document.getElementById('ticketPrice').value);
                    if (isNaN(price) || price < 0) {
                        alert('Please enter a valid price.');
                        return;
                    }
                }

                // Prepare advanced ticket class data
                const ticketClassData = {
                    name: ticketName,
                    type: currentTicketType,
                    cost: {
                        value: currentTicketType === 'paid' ? parseFloat(document.getElementById('ticketPrice').value) : 0,
                        currency: 'USD',
                        display: currentTicketType === 'paid' ? `USD,${parseFloat(document.getElementById('ticketPrice').value)}` : null
                    },
                    suggestedDonation: currentTicketType === 'donation' ? parseFloat(document.getElementById('suggestedDonation').value) || 0 : 0,
                    quantity: {
                        total: document.getElementById('ticketQuantity').value ? parseInt(document.getElementById('ticketQuantity').value) : null,
                        sold: 0,
                        reserved: 0
                    },
                    restrictions: {
                        minimumQuantity: parseInt(document.getElementById('minQuantity').value) || 1,
                        maximumQuantity: document.getElementById('maxQuantity').value ? parseInt(document.getElementById('maxQuantity').value) : null,
                        requiresApproval: document.getElementById('requireApproval').checked
                    },
                    sales: {
                        start: document.getElementById('saleStart').value ? new Date(document.getElementById('saleStart').value).toISOString() : null,
                        end: document.getElementById('saleEnd').value ? new Date(document.getElementById('saleEnd').value).toISOString() : null,
                        hideSaleDates: false
                    },
                    visibility: {
                        hidden: document.getElementById('hiddenTicket') ? document.getElementById('hiddenTicket').checked : false,
                        autoHide: false,
                        autoHideBefore: null,
                        autoHideAfter: null
                    },
                    salesChannels: ['online'],
                    deliveryMethods: ['electronic'],
                    fees: {
                        includeFee: document.getElementById('includeFee') ? document.getElementById('includeFee').checked : false,
                        absorptionType: 'pass_fee'
                    },
                    description: document.getElementById('ticketDescription').value.trim(),
                    inventoryTierId: document.getElementById('inventoryTier') ? document.getElementById('inventoryTier').value || null : null,
                    order: eventTickets.length
                };

                // Get current event ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('id');

                let response;
                if (editingTicketId) {
                    // Update existing ticket class
                    response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}/ticket-classes/${editingTicketId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(ticketClassData)
                    });
                } else {
                    // Create new ticket class
                    response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}/ticket-classes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(ticketClassData)
                    });
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    // Reload ticket classes data
                    await loadEventData();

                    showNotification(editingTicketId ? 'Ticket class updated successfully!' : 'Ticket class created successfully!');
                    renderTicketsList();
                    closeTicketForm();
                } else {
                    throw new Error(data.message || 'Failed to save ticket class');
                }

            } catch (error) {
                console.error('Failed to save ticket class:', error);
                alert('Failed to save ticket class: ' + error.message);
            }
        }

        function editTicket(ticketId) {
            const ticket = eventTickets.find(t => t.id === ticketId);
            if (!ticket) return;

            editingTicketId = ticketId;
            currentTicketType = ticket.type;
            
            // Update ticket type selection
            selectTicketType(ticket.type);
            
            // Populate form
            document.getElementById('ticketName').value = ticket.name;
            document.getElementById('ticketPrice').value = ticket.price;
            document.getElementById('suggestedDonation').value = ticket.suggestedDonation;
            document.getElementById('ticketQuantity').value = ticket.quantity || '';
            document.getElementById('ticketDescription').value = ticket.description;
            document.getElementById('saleStart').value = ticket.saleStart;
            document.getElementById('saleEnd').value = ticket.saleEnd;
            document.getElementById('requireApproval').checked = ticket.requireApproval;
            document.getElementById('minQuantity').value = ticket.minQuantity;
            document.getElementById('maxQuantity').value = ticket.maxQuantity || '';
            
            // Update form title
            document.getElementById('formTitle').textContent = `Edit ${ticket.type} ticket`;
            
            showTicketForm();
        }

        async function deleteTicket(ticketId) {
            if (confirm('Are you sure you want to delete this ticket class?')) {
                try {
                    // Get current event ID from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const eventId = urlParams.get('id');

                    // Delete ticket class using new API
                    const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}/ticket-classes/${ticketId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {
                        // Reload ticket classes data
                        await loadEventData();

                        renderTicketsList();
                        showNotification('Ticket class deleted successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to delete ticket class');
                    }

                } catch (error) {
                    console.error('Failed to delete ticket class:', error);
                    alert('Failed to delete ticket class: ' + error.message);
                }
            }
        }

        function generateTicketId() {
            return 'ticket_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Show remaining tickets for a ticket class
        async function showRemainingTickets(ticketClassId) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('id');

                const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}/ticket-classes/${ticketClassId}/remaining`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    const message = data.unlimited ?
                        'This ticket class has unlimited quantity.' :
                        `Remaining tickets: ${data.remaining}\nTotal: ${data.quantityTotal}\nSold: ${data.quantitySold}\nReserved: ${data.quantityReserved}`;

                    alert(message);
                } else {
                    throw new Error(data.message || 'Failed to get remaining tickets');
                }

            } catch (error) {
                console.error('Failed to get remaining tickets:', error);
                alert('Failed to get remaining tickets: ' + error.message);
            }
        }

        // Populate inventory tier options
        function populateInventoryTierOptions() {
            const tierSelect = document.getElementById('inventoryTier');
            if (!tierSelect) return;

            tierSelect.innerHTML = '<option value="">No tier (General)</option>';

            inventoryTiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier.id;
                option.textContent = `${tier.name} (${tier.quantityTotal || 'Unlimited'})`;
                tierSelect.appendChild(option);
            });
        }

        // Render ticket groups (for future enhancement)
        function renderTicketGroups() {
            // This would be implemented for grouping functionality
            console.log('Ticket groups loaded:', ticketGroups.length);
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const toggle = document.querySelector('.advanced-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.classList.add('expanded');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('expanded');
            }
        }

        function showNotification(message) {
            // Simple notification - you can enhance this
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function saveAndContinue() {
            try {
                // Validate that at least one ticket exists
                if (!eventTickets || eventTickets.length === 0) {
                    alert('Please create at least one ticket before continuing.');
                    return;
                }

                // Get current event ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('id');

                // Update event with tickets configured status
                const updateData = {
                    ticketsConfigured: true,
                    updatedAt: new Date().toISOString()
                };

                const response = await fetch(`https://crowd-backend-zxxp.onrender.com/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    // Mark tickets step as completed
                    const ticketsStep = document.getElementById('ticketsStep');
                    if (ticketsStep) {
                        ticketsStep.classList.add('completed');
                        ticketsStep.classList.remove('active');
                        const stepIcon = ticketsStep.querySelector('.step-icon');
                        if (stepIcon) {
                            stepIcon.innerHTML = `
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 12l2 2 4-4"/>
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                            `;
                        }
                    }

                    // Navigate to publish page with event ID
                    window.location.href = `publish-event.html?id=${eventId}`;
                } else {
                    throw new Error(data.message || 'Failed to save progress');
                }

            } catch (error) {
                console.error('Failed to save and continue:', error);
                alert('Failed to save progress: ' + error.message);
            }
        }

        function previewEvent() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                window.location.href = `event-preview.html?id=${eventId}`;
            } else {
                alert('Event ID not found');
            }
        }

        function goToPublish() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                window.location.href = `publish-event.html?id=${eventId}`;
            } else {
                alert('Event ID not found');
            }
        }

        function goToBuilder() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (eventId) {
                window.location.href = `event-builder.html?id=${eventId}`;
            } else {
                window.location.href = 'event-builder.html';
            }
        }
    </script>
</body>
</html>
