<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Dashboard - CROWD</title>
    <link rel="stylesheet" href="marketing-dashboard-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-generator@1.4.4/qr.min.js"></script>
    <style>
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="marketing-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#f05537">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <span>crowd</span>
                    <span class="marketing-badge">Marketing</span>
                </div>
                <div class="header-right">
                    <div class="event-selector">
                        <select id="event-selector" onchange="switchEvent()">
                            <option value="">Select Event</option>
                            <!-- Events will be populated here -->
                        </select>
                    </div>
                    <button class="back-btn" onclick="goBack()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                        Back
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span class="user-name" id="userName">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Marketing Navigation -->
            <div class="marketing-nav">
                <button class="nav-tab active" data-section="campaigns" onclick="switchSection('campaigns')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" x2="12" y1="15" y2="3"/>
                    </svg>
                    Email & SMS
                </button>
                <button class="nav-tab" data-section="tracking" onclick="switchSection('tracking')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Team Tracking
                </button>
                <button class="nav-tab" data-section="attribution" onclick="switchSection('attribution')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 3v18h18"/>
                        <path d="M7 16l4-4 4 4 6-6"/>
                    </svg>
                    Sales Attribution
                </button>
                <button class="nav-tab" data-section="analytics" onclick="switchSection('analytics')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Business Analytics
                </button>
                <button class="nav-tab" data-section="team" onclick="switchSection('team')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Team Management
                </button>
            </div>

            <!-- Email & SMS Campaigns Section -->
            <div class="section active" id="campaigns-section">
                <div class="section-header">
                    <h2>Email & SMS Campaigns</h2>
                    <button class="create-campaign-btn" onclick="createCampaign()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <line x1="12" x2="12" y1="5" y2="19"/>
                            <line x1="5" x2="19" y1="12" y2="12"/>
                        </svg>
                        Create Campaign
                    </button>
                </div>

                <div class="campaigns-overview">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon email">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-emails">0</h3>
                                <p>Emails Sent</p>
                                <span class="stat-change positive" id="email-growth">+15% this week</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon sms">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-sms">0</h3>
                                <p>SMS Sent</p>
                                <span class="stat-change positive" id="sms-growth">+8% this week</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon engagement">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2 3l6.09 13.09L14 12l2-6-6 2L2 3z"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="avg-engagement">0%</h3>
                                <p>Avg. Open Rate</p>
                                <span class="stat-change neutral" id="engagement-trend">Industry avg: 22%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon conversion">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <line x1="20" x2="20" y1="8" y2="14"/>
                                    <line x1="23" x2="17" y1="11" y2="11"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="conversion-rate">0%</h3>
                                <p>Conversion Rate</p>
                                <span class="stat-change positive" id="conversion-trend">+3.2% vs last month</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="campaigns-content">
                    <div class="campaigns-list">
                        <h3>Recent Campaigns</h3>
                        <div class="campaign-items" id="campaign-items">
                            <!-- Campaign items will be populated here -->
                        </div>
                    </div>

                    <div class="quick-send">
                        <h3>Quick Send</h3>
                        <div class="quick-send-form">
                            <div class="message-type-tabs">
                                <button class="type-tab active" data-type="email" onclick="switchMessageType('email')">Email</button>
                                <button class="type-tab" data-type="sms" onclick="switchMessageType('sms')">SMS</button>
                            </div>

                            <div class="recipient-selector">
                                <label>Send to:</label>
                                <select id="recipient-group">
                                    <option value="all-attendees">All Attendees</option>
                                    <option value="registered">Registered Only</option>
                                    <option value="not-registered">Not Registered</option>
                                    <option value="vip">VIP Guests</option>
                                    <option value="custom">Custom List</option>
                                </select>
                            </div>

                            <div class="message-content" id="email-content">
                                <input type="text" id="email-subject" placeholder="Email subject">
                                <textarea id="email-message" placeholder="Email message..." rows="4"></textarea>
                            </div>

                            <div class="message-content" id="sms-content" style="display: none;">
                                <textarea id="sms-message" placeholder="SMS message (max 160 characters)..." rows="3" maxlength="160"></textarea>
                                <div class="character-count">0/160</div>
                            </div>

                            <div class="template-actions">
                                <button class="template-btn" onclick="useTemplate()">Use Template</button>
                                <button class="preview-btn" onclick="previewMessage()">Preview</button>
                                <button class="send-btn" onclick="sendMessage()">Send Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Tracking Section -->
            <div class="section" id="tracking-section">
                <div class="section-header">
                    <h2>Team & Influencer Tracking</h2>
                    <button class="add-member-btn" onclick="addTeamMember()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <line x1="12" x2="12" y1="5" y2="19"/>
                            <line x1="5" x2="19" y1="12" y2="12"/>
                        </svg>
                        Add Member
                    </button>
                </div>

                <div class="tracking-overview">
                    <div class="overview-cards">
                        <div class="overview-card">
                            <h4>Total Team Members</h4>
                            <div class="card-metric">
                                <span class="metric-number" id="total-team-members">0</span>
                                <span class="metric-label">Active</span>
                            </div>
                        </div>
                        <div class="overview-card">
                            <h4>Total Referrals</h4>
                            <div class="card-metric">
                                <span class="metric-number" id="total-referrals">0</span>
                                <span class="metric-label">This Month</span>
                            </div>
                        </div>
                        <div class="overview-card">
                            <h4>Pending Payments</h4>
                            <div class="card-metric">
                                <span class="metric-number" id="pending-payments">$0</span>
                                <span class="metric-label">To Process</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="team-members-list">
                    <div class="list-header">
                        <h3>Team Performance</h3>
                        <div class="list-controls">
                            <select id="performance-filter">
                                <option value="all">All Members</option>
                                <option value="top-performers">Top Performers</option>
                                <option value="needs-attention">Needs Attention</option>
                            </select>
                            <button class="generate-qr-btn" onclick="generateQRCodes()">Generate QR Codes</button>
                        </div>
                    </div>

                    <div class="members-grid" id="members-grid">
                        <!-- Team members will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sales Attribution Section -->
            <div class="section" id="attribution-section">
                <div class="section-header">
                    <h2>Sales Attribution</h2>
                    <div class="date-range-selector">
                        <select id="attribution-period">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                    </div>
                </div>

                <div class="attribution-overview">
                    <div class="attribution-stats">
                        <div class="attribution-card">
                            <h4>Top Channel</h4>
                            <div class="channel-info">
                                <span class="channel-name" id="top-channel">Social Media</span>
                                <span class="channel-percentage" id="top-channel-percent">45%</span>
                            </div>
                        </div>
                        <div class="attribution-card">
                            <h4>Total Conversions</h4>
                            <div class="conversion-info">
                                <span class="conversion-number" id="total-conversions">0</span>
                                <span class="conversion-growth" id="conversion-growth">+12%</span>
                            </div>
                        </div>
                        <div class="attribution-card">
                            <h4>Revenue Generated</h4>
                            <div class="revenue-info">
                                <span class="revenue-number" id="total-revenue">$0</span>
                                <span class="revenue-growth" id="revenue-growth">+8%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="attribution-content">
                    <div class="attribution-chart">
                        <h3>Sales by Channel</h3>
                        <canvas id="attribution-chart" width="400" height="200"></canvas>
                    </div>

                    <div class="channel-breakdown">
                        <h3>Channel Performance</h3>
                        <div class="channel-list" id="channel-list">
                            <!-- Channel breakdown will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Analytics Section -->
            <div class="section" id="analytics-section">
                <div class="section-header">
                    <h2>Business Analytics</h2>
                    <button class="export-report-btn" onclick="exportReport()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" x2="12" y1="15" y2="3"/>
                        </svg>
                        Export Report
                    </button>
                </div>

                <div class="analytics-overview">
                    <div class="analytics-cards">
                        <div class="analytics-card">
                            <div class="card-header">
                                <h4>Attendee Demographics</h4>
                                <span class="growth-indicator positive">+15%</span>
                            </div>
                            <div class="demographics-chart">
                                <canvas id="demographics-chart" width="200" height="200"></canvas>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-header">
                                <h4>Discovery Sources</h4>
                                <span class="growth-indicator neutral">+2%</span>
                            </div>
                            <div class="sources-list" id="discovery-sources">
                                <!-- Discovery sources will be populated here -->
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-header">
                                <h4>Return Attendees</h4>
                                <span class="growth-indicator positive">+24%</span>
                            </div>
                            <div class="retention-metrics">
                                <div class="retention-stat">
                                    <span class="stat-value" id="first-time-attendees">0%</span>
                                    <span class="stat-label">First Time</span>
                                </div>
                                <div class="retention-stat">
                                    <span class="stat-value" id="return-attendees">0%</span>
                                    <span class="stat-label">Returning</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detailed-analytics">
                    <div class="attendance-timeline">
                        <h3>Attendance Timeline</h3>
                        <canvas id="attendance-timeline-chart" width="800" height="300"></canvas>
                    </div>

                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>Key Insights</h4>
                            <ul class="insights-list" id="key-insights">
                                <li>Peak registration time: 7-9 PM</li>
                                <li>Social media drives 45% of traffic</li>
                                <li>Mobile users: 68% of registrations</li>
                                <li>Average time to decide: 3.2 days</li>
                            </ul>
                        </div>
                        <div class="insight-card">
                            <h4>Recommendations</h4>
                            <ul class="recommendations-list" id="recommendations">
                                <li>Increase social media ad spend by 20%</li>
                                <li>Optimize mobile registration flow</li>
                                <li>Send follow-up emails after 2 days</li>
                                <li>Target evening hours for campaigns</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Management Section -->
            <div class="section" id="team-section">
                <div class="section-header">
                    <h2>Team Management</h2>
                    <button class="invite-member-btn" onclick="inviteTeamMember()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" x2="12" y1="15" y2="3"/>
                        </svg>
                        Invite Member
                    </button>
                </div>

                <div class="team-overview">
                    <div class="team-stats">
                        <div class="team-stat">
                            <span class="stat-number" id="team-size">0</span>
                            <span class="stat-label">Team Members</span>
                        </div>
                        <div class="team-stat">
                            <span class="stat-number" id="active-members">0</span>
                            <span class="stat-label">Active This Week</span>
                        </div>
                        <div class="team-stat">
                            <span class="stat-number" id="pending-invites">0</span>
                            <span class="stat-label">Pending Invites</span>
                        </div>
                    </div>
                </div>

                <div class="team-management-content">
                    <div class="permissions-guide">
                        <h3>Permission Levels</h3>
                        <div class="permissions-list">
                            <div class="permission-item">
                                <div class="permission-badge owner">Owner</div>
                                <div class="permission-details">
                                    <p>Full access to all features including team management, billing, and event deletion</p>
                                </div>
                            </div>
                            <div class="permission-item">
                                <div class="permission-badge admin">Admin</div>
                                <div class="permission-details">
                                    <p>Can manage events, view analytics, and invite team members (cannot delete events or access billing)</p>
                                </div>
                            </div>
                            <div class="permission-item">
                                <div class="permission-badge editor">Editor</div>
                                <div class="permission-details">
                                    <p>Can edit event details, manage attendees, and send marketing campaigns</p>
                                </div>
                            </div>
                            <div class="permission-item">
                                <div class="permission-badge viewer">Viewer</div>
                                <div class="permission-details">
                                    <p>Read-only access to events and basic analytics</p>
                                </div>
                            </div>
                            <div class="permission-item">
                                <div class="permission-badge helper">Helper</div>
                                <div class="permission-details">
                                    <p>Limited access for event day support (check-in, customer service)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="team-members-management">
                        <h3>Team Members</h3>
                        <div class="members-table">
                            <div class="table-header">
                                <div class="header-cell">Member</div>
                                <div class="header-cell">Role</div>
                                <div class="header-cell">Last Active</div>
                                <div class="header-cell">Actions</div>
                            </div>
                            <div class="table-body" id="team-members-table">
                                <!-- Team members will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Campaign Creation Modal -->
    <div class="modal-overlay" id="campaign-modal" style="display: none;">
        <div class="modal-content campaign-modal">
            <div class="modal-header">
                <h3>Create Marketing Campaign</h3>
                <button class="modal-close" onclick="closeCampaignModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="campaign-form">
                    <!-- Campaign form content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Team Member Modal -->
    <div class="modal-overlay" id="member-modal" style="display: none;">
        <div class="modal-content member-modal">
            <div class="modal-header">
                <h3 id="member-modal-title">Add Team Member</h3>
                <button class="modal-close" onclick="closeMemberModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="member-form">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="member-email" placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="member-role">
                            <option value="helper">Helper</option>
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Personal Message (Optional)</label>
                        <textarea id="member-message" placeholder="Add a personal note to the invitation"></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn-secondary" onclick="closeMemberModal()">Cancel</button>
                        <button class="btn-primary" onclick="sendInvitation()">Send Invitation</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000'
                : 'https://crowd-backend-zxxp.onrender.com',
            TOKEN_KEY: 'authToken'
        };

        let currentSection = 'campaigns';
        let currentEvent = null;
        let charts = {};

        // Sample data
        const sampleTeamMembers = [
            {
                id: 1,
                name: "Sarah Johnson",
                email: "sarah@example.com",
                role: "admin",
                avatar: "https://images.unsplash.com/photo-1494790108755-2616b612b8e5?w=50&h=50&fit=crop&crop=face",
                referrals: 45,
                earnings: 450,
                qrCode: "QR123456",
                lastActive: "2 hours ago",
                status: "active"
            },
            {
                id: 2,
                name: "Mike Chen",
                email: "mike@example.com",
                role: "editor",
                avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=50&h=50&fit=crop&crop=face",
                referrals: 32,
                earnings: 320,
                qrCode: "QR789012",
                lastActive: "1 day ago",
                status: "active"
            }
        ];

        const sampleCampaigns = [
            {
                id: 1,
                name: "Event Reminder - 3 Days",
                type: "email",
                status: "completed",
                sent: 1250,
                opened: 687,
                clicked: 89,
                date: "2024-01-15"
            },
            {
                id: 2,
                name: "Last Chance SMS",
                type: "sms",
                status: "scheduled",
                sent: 0,
                opened: 0,
                clicked: 0,
                date: "2024-01-20"
            }
        ];

        // Utility functions
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.trim().replace(/[<>\"'&]/g, function(match) {
                const htmlEscapes = {
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '&': '&amp;'
                };
                return htmlEscapes[match];
            });
        }

        async function makeApiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }

        function getAuthToken() {
            return localStorage.getItem(CONFIG.TOKEN_KEY) || '';
        }

        // Authentication
        async function checkAuthentication() {
            try {
                const token = getAuthToken();
                if (!token) return false;

                const data = await makeApiRequest(`${CONFIG.API_BASE_URL}/api/auth/verify`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                return data.success;
            } catch (error) {
                return false;
            }
        }

        async function loadUserData() {
            try {
                const data = await makeApiRequest(`${CONFIG.API_BASE_URL}/api/auth/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (data.success && data.user) {
                    const user = data.user;
                    const firstName = sanitizeInput(user.firstName || '');
                    const lastName = sanitizeInput(user.lastName || '');
                    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase() || 'U';
                    const fullName = `${firstName} ${lastName}`.trim() || 'User';

                    document.getElementById('userAvatar').textContent = initials;
                    document.getElementById('userName').textContent = fullName;
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
            }
        }

        // Section switching
        function switchSection(section) {
            currentSection = section;

            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Show/hide sections
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(`${section}-section`).classList.add('active');

            // Load section-specific data
            loadSectionData(section);
        }

        function loadSectionData(section) {
            switch (section) {
                case 'campaigns':
                    loadCampaignData();
                    break;
                case 'tracking':
                    loadTrackingData();
                    break;
                case 'attribution':
                    loadAttributionData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
                case 'team':
                    loadTeamData();
                    break;
            }
        }

        // Campaign functions
        function loadCampaignData() {
            // Update stats
            document.getElementById('total-emails').textContent = '1,247';
            document.getElementById('total-sms').textContent = '389';
            document.getElementById('avg-engagement').textContent = '24.5';
            document.getElementById('conversion-rate').textContent = '8.2';

            // Load campaigns list
            renderCampaigns();
        }

        function renderCampaigns() {
            const container = document.getElementById('campaign-items');
            container.innerHTML = sampleCampaigns.map(campaign => `
                <div class="campaign-item">
                    <div class="campaign-info">
                        <div class="campaign-header">
                            <h4>${campaign.name}</h4>
                            <span class="campaign-type ${campaign.type}">${campaign.type.toUpperCase()}</span>
                        </div>
                        <div class="campaign-stats">
                            <span>Sent: ${campaign.sent.toLocaleString()}</span>
                            <span>Opened: ${campaign.opened.toLocaleString()}</span>
                            <span>Clicked: ${campaign.clicked.toLocaleString()}</span>
                        </div>
                        <div class="campaign-date">${formatDate(campaign.date)}</div>
                    </div>
                    <div class="campaign-status">
                        <span class="status-badge ${campaign.status}">${campaign.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function switchMessageType(type) {
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            document.getElementById('email-content').style.display = type === 'email' ? 'block' : 'none';
            document.getElementById('sms-content').style.display = type === 'sms' ? 'block' : 'none';
        }

        function createCampaign() {
            document.getElementById('campaign-modal').style.display = 'flex';
        }

        function closeCampaignModal() {
            document.getElementById('campaign-modal').style.display = 'none';
        }

        function sendMessage() {
            const type = document.querySelector('.type-tab.active').dataset.type;
            const recipients = document.getElementById('recipient-group').value;

            if (type === 'email') {
                const subject = document.getElementById('email-subject').value;
                const message = document.getElementById('email-message').value;

                if (!subject || !message) {
                    alert('Please fill in all email fields');
                    return;
                }
            } else {
                const message = document.getElementById('sms-message').value;

                if (!message) {
                    alert('Please enter SMS message');
                    return;
                }
            }

            // Simulate sending
            alert(`${type.toUpperCase()} sent to ${recipients}!`);

            // Clear form
            if (type === 'email') {
                document.getElementById('email-subject').value = '';
                document.getElementById('email-message').value = '';
            } else {
                document.getElementById('sms-message').value = '';
            }
        }

        // Team tracking functions
        function loadTrackingData() {
            document.getElementById('total-team-members').textContent = sampleTeamMembers.length;
            document.getElementById('total-referrals').textContent = sampleTeamMembers.reduce((sum, member) => sum + member.referrals, 0);
            document.getElementById('pending-payments').textContent = `$${sampleTeamMembers.reduce((sum, member) => sum + member.earnings, 0)}`;

            renderTeamMembers();
        }

        function renderTeamMembers() {
            const container = document.getElementById('members-grid');
            container.innerHTML = sampleTeamMembers.map(member => `
                <div class="member-card">
                    <div class="member-header">
                        <img src="${member.avatar}" alt="${member.name}" class="member-avatar">
                        <div class="member-info">
                            <h4>${member.name}</h4>
                            <span class="member-role">${member.role}</span>
                        </div>
                        <div class="member-status ${member.status}"></div>
                    </div>
                    <div class="member-stats">
                        <div class="stat-item">
                            <span class="stat-value">${member.referrals}</span>
                            <span class="stat-label">Referrals</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">$${member.earnings}</span>
                            <span class="stat-label">Earnings</span>
                        </div>
                    </div>
                    <div class="member-qr">
                        <span class="qr-code">${member.qrCode}</span>
                        <button class="view-qr-btn" onclick="viewQRCode('${member.qrCode}')">View QR</button>
                    </div>
                    <div class="member-actions">
                        <button class="pay-btn" onclick="payMember(${member.id})">Pay</button>
                        <button class="details-btn" onclick="viewMemberDetails(${member.id})">Details</button>
                    </div>
                </div>
            `).join('');
        }

        function addTeamMember() {
            document.getElementById('member-modal-title').textContent = 'Add Team Member';
            document.getElementById('member-modal').style.display = 'flex';
        }

        function generateQRCodes() {
            // Generate and download QR codes for all team members
            alert('QR codes generated for all team members!');
        }

        // Attribution functions
        function loadAttributionData() {
            document.getElementById('top-channel').textContent = 'Social Media';
            document.getElementById('top-channel-percent').textContent = '45%';
            document.getElementById('total-conversions').textContent = '1,247';
            document.getElementById('total-revenue').textContent = '$24,950';

            initAttributionChart();
            renderChannelBreakdown();
        }

        function initAttributionChart() {
            const ctx = document.getElementById('attribution-chart').getContext('2d');

            if (charts.attribution) {
                charts.attribution.destroy();
            }

            charts.attribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Social Media', 'Direct', 'Email', 'Referrals', 'Ads'],
                    datasets: [{
                        data: [45, 25, 15, 10, 5],
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderChannelBreakdown() {
            const channels = [
                { name: 'Social Media', conversions: 561, revenue: 11227, change: '+12%' },
                { name: 'Direct Traffic', conversions: 312, revenue: 6238, change: '+8%' },
                { name: 'Email Marketing', conversions: 187, revenue: 3743, change: '+15%' },
                { name: 'Referrals', conversions: 125, revenue: 2495, change: '+22%' },
                { name: 'Paid Ads', conversions: 62, revenue: 1247, change: '-3%' }
            ];

            const container = document.getElementById('channel-list');
            container.innerHTML = channels.map(channel => `
                <div class="channel-item">
                    <div class="channel-info">
                        <h4>${channel.name}</h4>
                        <div class="channel-metrics">
                            <span>${channel.conversions} conversions</span>
                            <span>$${channel.revenue.toLocaleString()} revenue</span>
                        </div>
                    </div>
                    <div class="channel-change ${channel.change.startsWith('+') ? 'positive' : 'negative'}">
                        ${channel.change}
                    </div>
                </div>
            `).join('');
        }

        // Analytics functions
        function loadAnalyticsData() {
            document.getElementById('first-time-attendees').textContent = '76%';
            document.getElementById('return-attendees').textContent = '24%';

            initDemographicsChart();
            initAttendanceTimelineChart();
            renderDiscoverySources();
        }

        function initDemographicsChart() {
            const ctx = document.getElementById('demographics-chart').getContext('2d');

            if (charts.demographics) {
                charts.demographics.destroy();
            }

            charts.demographics = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['25-34', '35-44', '18-24', '45-54', '55+'],
                    datasets: [{
                        data: [35, 28, 20, 12, 5],
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function initAttendanceTimelineChart() {
            const ctx = document.getElementById('attendance-timeline-chart').getContext('2d');

            if (charts.timeline) {
                charts.timeline.destroy();
            }

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    datasets: [{
                        label: 'Registrations',
                        data: [45, 78, 134, 267, 398, 512],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderDiscoverySources() {
            const sources = [
                { name: 'Google Search', percentage: 32 },
                { name: 'Social Media', percentage: 28 },
                { name: 'Word of Mouth', percentage: 18 },
                { name: 'Email', percentage: 12 },
                { name: 'Other', percentage: 10 }
            ];

            const container = document.getElementById('discovery-sources');
            container.innerHTML = sources.map(source => `
                <div class="source-item">
                    <span class="source-name">${source.name}</span>
                    <div class="source-bar">
                        <div class="source-fill" style="width: ${source.percentage}%"></div>
                    </div>
                    <span class="source-percentage">${source.percentage}%</span>
                </div>
            `).join('');
        }

        // Team management functions
        function loadTeamData() {
            document.getElementById('team-size').textContent = sampleTeamMembers.length;
            document.getElementById('active-members').textContent = sampleTeamMembers.filter(m => m.status === 'active').length;
            document.getElementById('pending-invites').textContent = '0';

            renderTeamMembersTable();
        }

        function renderTeamMembersTable() {
            const container = document.getElementById('team-members-table');
            container.innerHTML = sampleTeamMembers.map(member => `
                <div class="table-row">
                    <div class="table-cell">
                        <div class="member-cell">
                            <img src="${member.avatar}" alt="${member.name}" class="table-avatar">
                            <div class="member-details">
                                <span class="member-name">${member.name}</span>
                                <span class="member-email">${member.email}</span>
                            </div>
                        </div>
                    </div>
                    <div class="table-cell">
                        <span class="role-badge ${member.role}">${member.role}</span>
                    </div>
                    <div class="table-cell">
                        <span class="last-active">${member.lastActive}</span>
                    </div>
                    <div class="table-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editMember(${member.id})" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete" onclick="removeMember(${member.id})" title="Remove">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function inviteTeamMember() {
            document.getElementById('member-modal-title').textContent = 'Invite Team Member';
            document.getElementById('member-email').value = '';
            document.getElementById('member-role').value = 'helper';
            document.getElementById('member-message').value = '';
            document.getElementById('member-modal').style.display = 'flex';
        }

        function closeMemberModal() {
            document.getElementById('member-modal').style.display = 'none';
        }

        function sendInvitation() {
            const email = document.getElementById('member-email').value;
            const role = document.getElementById('member-role').value;
            const message = document.getElementById('member-message').value;

            if (!email) {
                alert('Please enter an email address');
                return;
            }

            // Simulate sending invitation
            alert(`Invitation sent to ${email} as ${role}!`);
            closeMemberModal();
        }

        // Helper functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function exportReport() {
            alert('Exporting comprehensive business report...');
        }

        function switchEvent() {
            const eventId = document.getElementById('event-selector').value;
            if (eventId) {
                currentEvent = eventId;
                // Reload data for selected event
                loadSectionData(currentSection);
            }
        }

        function goBack() {
            window.history.back() || (window.location.href = 'dashboard-home.html');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            await loadUserData();
            loadSectionData(currentSection);

            // Character counter for SMS
            document.getElementById('sms-message').addEventListener('input', function(e) {
                const count = e.target.value.length;
                document.querySelector('.character-count').textContent = `${count}/160`;
            });
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            Object.values(charts).forEach(chart => {
                if (chart && chart.destroy) {
                    chart.destroy();
                }
            });
        });
    </script>
</body>
</html>