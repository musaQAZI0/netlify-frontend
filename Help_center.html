<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowd Help Center</title>
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="Help_center.css">
    <script src="js/auth-api.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="logo.jpg" alt="Logo" style="height: 32px; width: auto; object-fit: contain;">
                <span class="help-text">Help Center</span>
            </div>
            <div class="header-right">
                <!-- Loading Spinner (shown during auth check) -->
                <div id="authLoading" class="loading-spinner" style="
                    width: 20px;
                    height: 20px;
                    border: 2px solid #f3f3f3;
                    border-top: 2px solid #ea580c;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                "></div>

                <!-- Login Button (shown when not authenticated) -->
                <button class="header-login-btn" id="headerLoginBtn" style="display: none;">Log in</button>

                <!-- User Profile (shown when authenticated) -->
                <div class="user-profile" id="headerUserProfile" style="display: none;">
                    <div class="user-avatar" id="headerUserAvatar">
                        <span id="headerUserInitials"></span>
                    </div>
                    <span class="user-name" id="headerUserName"></span>
                    <div class="dropdown-arrow">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    <!-- Dropdown Menu -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-item" id="editProfileDropdown">Edit Profile</div>
                        <div class="user-dropdown-item user-dropdown-item--danger" id="logoutDropdown">Log out</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Section -->
        <section class="search-section">
            <h1 class="search-title">How can we help?</h1>
            <div class="search-container">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search help articles" class="search-input">
                </div>
            </div>
        </section>

        <!-- Tabs -->
        <section class="tabs-section">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="attending">Attending an event</button>
                <button class="tab-button" data-tab="organizing">Organizing an event</button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Get Help Faster -->
                <div class="help-faster-card">
                    <div class="help-faster-content">
                        <div class="user-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="help-text-content">
                            <h3 id="helpCardTitle">Get help faster</h3>
                            <p id="helpCardDescription">Log in for resources tailored to your account, tickets, and
                                events.</p>
                        </div>
                        <!-- Login button in help card (shown when not authenticated) -->
                        <button class="login-button" id="helpCardLoginBtn" style="display: none;">
                            Log in
                        </button>
                    </div>
                </div>

                <!-- Featured Articles -->
                <div class="featured-section">
                    <h2>Featured articles</h2>
                    <div class="articles-grid" id="articlesGrid">
                        <!-- Articles will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Browse by Topic -->
        <section class="topics-section">
            <h2>Browse by topic</h2>
            <div class="topics-grid">
                <div class="topic-card">
                    <div class="topic-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <span>Buy and register</span>
                </div>
                <div class="topic-card">
                    <div class="topic-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                    </div>
                    <span>Your tickets</span>
                </div>
                <div class="topic-card">
                    <div class="topic-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <span>Your account</span>
                </div>
                <div class="topic-card">
                    <div class="topic-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                    </div>
                    <span>Terms and policies</span>
                </div>
            </div>
        </section>

        <!-- Still Have Questions -->
        <section class="questions-section">
            <h3>Still have questions?</h3>
            <button class="contact-button">Contact Support</button>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-columns">
                <div class="footer-column">
                    <h4>Use Crowd</h4>
                    <ul>
                        <li><a href="#">Create events</a></li>
                        <li><a href="#">Community Guidelines</a></li>
                        <li><a href="#">Pricing</a></li>
                        <li><a href="#">Pricing Calculator</a></li>
                        <li><a href="#">Site status</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Download apps</h4>
                    <ul>
                        <li><a href="#">Crowd app for Android</a></li>
                        <li><a href="#">Crowd app for iOS</a></li>
                        <li><a href="#">Crowd Organizer app</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Browse resources</h4>
                    <ul>
                        <li><a href="#">Organizer Resource Hub</a></li>
                        <li><a href="#">Virtual sessions for organizers</a></li>
                        <li><a href="#">Taxes</a></li>
                        <li><a href="#">Webinars for new organizers</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Connect with us</h4>
                    <ul>
                        <li><a href="#">Contact support</a></li>
                        <li><a href="#">Facebook</a></li>
                        <li><a href="#">Instagram</a></li>
                        <li><a href="#">Twitter</a></li>
                        <li><a href="#">TikTok</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="copyright">© 2025 Crowd</div>
                <div class="footer-links">
                    <a href="#">About</a>
                    <a href="#">Blog</a>
                    <a href="#">Help</a>
                    <a href="#">Careers</a>
                    <a href="#">Press</a>
                    <a href="#">Security</a>
                    <a href="#">Developers</a>
                    <a href="#">Terms</a>
                    <a href="#">Privacy</a>
                    <a href="#">Accessibility</a>
                    <a href="#">Cookies</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Authentication state management
        let isAuthenticated = false;
        let currentUser = null;

        // Article data with corresponding page links
        const articlesData = {
            attending: [
                { title: "Find your tickets", icon: "file-text", link: "Your tickets.html" },
                { title: "Request a refund", icon: "dollar-sign", link: "Request a refund.html" },
                { title: "Contact the event organizer", icon: "message-circle", link: "Contact_organizer.html" },
                { title: "What is this charge from Crowd?", icon: "credit-card", link: "Buy_and_register.html" },
                { title: "Transfer tickets to someone else", icon: "send", link: "Your tickets.html" },
                { title: "Edit your order information", icon: "file-text", link: "Managing_orders.html" },
            ],
            organizing: [
                { title: "Create and edit ticket types", icon: "file-text", link: "Create and edit ticket types.html" },
                { title: "Add images and video to your event", icon: "file-text", link: "Add images and video to your event.html" },
                { title: "Add and manage your payout methods", icon: "credit-card", link: "Add and manage your payout methods.html" },
                { title: "Troubleshoot delayed or missing payouts", icon: "dollar-sign", link: "Troubleshoot delayed or missing payout.html" },
                { title: "Email your registered attendees", icon: "send", link: "Marketing_an_event_help_center.html" },
                { title: "Issue a full or partial refund", icon: "dollar-sign", link: "Issue a full or partial refund.html" },
            ],
        }

        // Topic mapping to pages
        const topicMapping = {
            "Buy and register": "Buy_and_register.html",
            "Your tickets": "Your tickets.html",
            "Your account": "Your account.html",
            "Terms and policies": "Terms and policies.html"
        }

        // Logged-in versions mapping
        const topicMappingLoggedIn = {
            "Buy and register": "Buy_and_register_new.html",
            "Your tickets": "Your tickets.html",
            "Your account": "Your account.html",
            "Terms and policies": "Terms and policies_new.html"
        }

        // SVG icons
        const icons = {
            "file-text":
                '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
            "dollar-sign":
                '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
            "message-circle":
                '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>',
            "credit-card":
                '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
            send: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22,2 15,22 11,13 2,9 22,2"></polygon></svg>',
        }

        // Current active tab
        let currentTab = "attending"

        // Initialize the page
        document.addEventListener("DOMContentLoaded", () => {
            console.log("Help Center JavaScript loaded successfully!")

            // Check for token in URL parameters (from redirect)
            handleTokenFromURL();
            
            // Check for immediate auth state from localStorage first
            checkLocalAuthState();
            
            // Then check with backend
            checkAuthStatus()

            renderArticles()
            setupTabListeners()
            setupSearchListener()
            setupButtonListeners()
            setupDropdownListeners()

            console.log("All event listeners setup complete")
        })

        // Check authentication status
        async function checkAuthStatus() {
            try {
                showLoadingSpinner();

                // Get token from localStorage (check both possible keys)
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Add Authorization header if token exists
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include', // Include cookies
                    headers: headers
                });

                if (response.ok) {
                    const userData = await response.json();
                    if (userData.isAuthenticated && userData.user) {
                        // Store user data in localStorage for faster loading next time
                        localStorage.setItem('currentUser', JSON.stringify(userData.user));
                        setAuthenticatedState(userData.user);
                    } else {
                        clearAuthData();
                        setUnauthenticatedState();
                    }
                } else {
                    clearAuthData();
                    setUnauthenticatedState();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Only clear auth data if we had a token but it failed
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                if (token) {
                    clearAuthData();
                }
                setUnauthenticatedState();
            }
        }

        // Check if user should be redirected to logged-in version
        function shouldRedirectToLoggedInVersion() {
            // Check if user came from organizer pages via referrer
            const referrer = document.referrer;
            const organizerPages = [
                'logged_in_Version.html',
                'dashboard-home.html', 
                'events-calendar.html',
                'orders.html',
                'marketing.html'
            ];
            
            // Check if referrer contains any organizer page
            const cameFromOrganizerPage = organizerPages.some(page => 
                referrer && referrer.includes(page)
            );
            
            // Check URL parameters for redirect flag
            const urlParams = new URLSearchParams(window.location.search);
            const fromOrganizer = urlParams.get('from') === 'organizer';
            
            // Check localStorage flag (set by organizer pages)
            const organizerContext = localStorage.getItem('organizerContext') === 'true';
            
            return cameFromOrganizerPage || fromOrganizer || organizerContext;
        }

        // Set authenticated state
        function setAuthenticatedState(user) {
            isAuthenticated = true;
            currentUser = user;

            // Check if user should be redirected to logged-in version
            if (shouldRedirectToLoggedInVersion()) {
                console.log('Redirecting authenticated user to logged-in help center');
                window.location.href = 'Help_center_logged_in.html';
                return;
            }

            // Update UI elements
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('headerLoginBtn').style.display = 'none';
            document.getElementById('headerUserProfile').style.display = 'flex';

            // Hide help card login button
            const helpCardLoginBtn = document.getElementById('helpCardLoginBtn');
            if (helpCardLoginBtn) {
                helpCardLoginBtn.style.display = 'none';
            }

            // Update user information
            const displayName = user.firstName && user.lastName 
                ? `${user.firstName} ${user.lastName}` 
                : user.firstName || user.lastName || user.email || 'User';
            
            document.getElementById('headerUserName').textContent = displayName;

            // Generate initials from name or email
            const initials = generateInitials(displayName);
            document.getElementById('headerUserInitials').textContent = initials;

            // Update avatar background color based on user ID or email
            const avatarColor = generateAvatarColor(user._id || user.email);
            document.getElementById('headerUserAvatar').style.backgroundColor = avatarColor;

            // Update help card text
            updateHelpCardForAuthenticated(user);
            
            // Update navigation based on user role
            updateNavigationForUser(user);
        }

        // Set unauthenticated state
        function setUnauthenticatedState() {
            isAuthenticated = false;
            currentUser = null;

            // Update UI elements
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('headerUserProfile').style.display = 'none';
            document.getElementById('headerLoginBtn').style.display = 'block';

            // Show help card login button
            const helpCardLoginBtn = document.getElementById('helpCardLoginBtn');
            if (helpCardLoginBtn) {
                helpCardLoginBtn.style.display = 'block';
            }

            // Update help card text
            updateHelpCardForUnauthenticated();
        }

        // Show loading spinner
        function showLoadingSpinner() {
            document.getElementById('authLoading').style.display = 'block';
            document.getElementById('headerLoginBtn').style.display = 'none';
            document.getElementById('headerUserProfile').style.display = 'none';
        }

        // Update help card for authenticated users
        function updateHelpCardForAuthenticated(user) {
            const helpCardTitle = document.getElementById('helpCardTitle');
            const helpCardDescription = document.getElementById('helpCardDescription');
            
            const firstName = user.firstName || 'User';

            if (helpCardTitle) {
                helpCardTitle.textContent = `Welcome back, ${firstName}!`;
            }
            if (helpCardDescription) {
                const roleBasedMessage = user.role === 'organizer' 
                    ? 'Access your event management tools, analytics, and organizer resources.'
                    : 'Access your personalized help resources, tickets, and account settings.';
                helpCardDescription.textContent = roleBasedMessage;
            }
        }

        // Update help card for unauthenticated users
        function updateHelpCardForUnauthenticated() {
            const helpCardTitle = document.getElementById('helpCardTitle');
            const helpCardDescription = document.getElementById('helpCardDescription');

            if (helpCardTitle) {
                helpCardTitle.textContent = 'Get help faster';
            }
            if (helpCardDescription) {
                helpCardDescription.textContent = 'Log in for resources tailored to your account, tickets, and events.';
            }
        }

        // Generate initials from name
        function generateInitials(name) {
            if (!name) return 'U';

            const words = name.trim().split(' ');
            if (words.length === 1) {
                return words[0].charAt(0).toUpperCase();
            } else {
                return (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
            }
        }

        // Generate avatar color based on user identifier
        function generateAvatarColor(identifier) {
            const colors = [
                '#4285f4', '#ea4335', '#34a853', '#fbbc05',
                '#ff6d01', '#9c27b0', '#00bcd4', '#ff5722',
                '#795548', '#607d8b', '#e91e63', '#3f51b5'
            ];

            if (!identifier) return colors[0];

            let hash = 0;
            for (let i = 0; i < identifier.length; i++) {
                hash = identifier.charCodeAt(i) + ((hash << 5) - hash);
            }

            return colors[Math.abs(hash) % colors.length];
        }
        
        // Update navigation and content based on user information
        function updateNavigationForUser(user) {
            // Add user-specific features or modify existing ones
            console.log('Updating navigation for user:', user.firstName || user.email, 'Role:', user.role);
            
            // You can add specific customizations here based on user role
            if (user.role === 'organizer') {
                // Show organizer-specific help topics more prominently
                highlightOrganizerContent();
            } else {
                // Show attendee-specific content
                highlightAttendeeContent();
            }
        }
        
        // Highlight organizer-specific content
        function highlightOrganizerContent() {
            // Switch to organizing tab by default
            const organizingTab = document.querySelector('[data-tab="organizing"]');
            const attendingTab = document.querySelector('[data-tab="attending"]');
            
            if (organizingTab && attendingTab) {
                attendingTab.classList.remove('active');
                organizingTab.classList.add('active');
                currentTab = 'organizing';
                renderArticles();
            }
        }
        
        // Highlight attendee-specific content
        function highlightAttendeeContent() {
            // Keep attending tab active (default behavior)
            console.log('Showing attendee-focused content');
        }

        // Handle login button click
        async function handleLogin() {
            try {
                // Redirect to login page
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                // Use the auth API for consistent token handling
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: headers
                });

                // Always clear both possible token keys from localStorage on logout
                localStorage.removeItem('token');
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                setUnauthenticatedState();
                
                // Optionally redirect to home page
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                // Force logout on client side even if server request fails
                localStorage.removeItem('token');
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                setUnauthenticatedState();
                window.location.href = 'index.html';
            }

            // Close dropdown
            document.getElementById('userDropdown').classList.remove('show');
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Setup dropdown listeners
        function setupDropdownListeners() {
            const userProfile = document.getElementById("headerUserProfile")
            const userDropdown = document.getElementById("userDropdown")

            if (userProfile && userDropdown) {
                userProfile.addEventListener("click", (e) => {
                    e.stopPropagation()
                    userDropdown.classList.toggle("show")
                })

                // Close dropdown when clicking outside
                document.addEventListener("click", () => {
                    userDropdown.classList.remove("show")
                })

                // Prevent dropdown from closing when clicking inside it
                userDropdown.addEventListener("click", (e) => {
                    e.stopPropagation()
                })
            }

            // Edit profile dropdown item
            const editProfileDropdown = document.getElementById("editProfileDropdown")
            if (editProfileDropdown) {
                editProfileDropdown.addEventListener("click", () => {
                    console.log("Edit profile clicked")
                    window.location.href = "Your account.html"
                })
            }

            // Logout dropdown item
            const logoutDropdown = document.getElementById("logoutDropdown")
            if (logoutDropdown) {
                logoutDropdown.addEventListener("click", () => {
                    console.log("Logout clicked")
                    handleLogout()
                })
            }
        }

        // Render articles based on current tab - NO INLINE ONCLICK
        function renderArticles() {
            console.log("Rendering articles for tab:", currentTab)
            const articlesGrid = document.getElementById("articlesGrid")

            if (!articlesGrid) {
                console.error("Articles grid element not found!")
                return
            }

            const articles = articlesData[currentTab]
            console.log("Articles to render:", articles)

            // Create articles without inline onclick - CSP compliant
            articlesGrid.innerHTML = articles
                .map(
                    (article, index) => `
                <div class="article-card" data-article-title="${article.title}" data-article-link="${article.link}">
                    <div class="article-icon">
                        ${icons[article.icon]}
                    </div>
                    <div class="article-title">${article.title}</div>
                </div>
            `,
                )
                .join("")

            // Add event listeners after creating the HTML
            setupArticleClickListeners()
            console.log("Articles rendered and event listeners added")
        }

        // Setup article click listeners - CSP compliant way
        function setupArticleClickListeners() {
            const articleCards = document.querySelectorAll('.article-card')

            articleCards.forEach(card => {
                card.addEventListener('click', function () {
                    const articleTitle = this.getAttribute('data-article-title')
                    const articleLink = this.getAttribute('data-article-link')

                    console.log("Article clicked:", articleTitle)
                    console.log("Navigating to:", articleLink)

                    if (articleLink) {
                        window.location.href = articleLink
                    } else {
                        console.error("No link found for article:", articleTitle)
                        alert("Page coming soon for: " + articleTitle)
                    }
                })

                // Add visual feedback
                card.style.cursor = 'pointer'
            })

            console.log(`Added click listeners to ${articleCards.length} article cards`)
        }

        // Setup tab button listeners
        function setupTabListeners() {
            const tabButtons = document.querySelectorAll(".tab-button")
            console.log("Found tab buttons:", tabButtons.length)

            tabButtons.forEach((button) => {
                button.addEventListener("click", function () {
                    console.log("Tab clicked:", this.dataset.tab)

                    // Remove active class from all buttons
                    tabButtons.forEach((btn) => btn.classList.remove("active"))

                    // Add active class to clicked button
                    this.classList.add("active")

                    // Update current tab
                    currentTab = this.dataset.tab

                    // Re-render articles
                    renderArticles()
                })
            })
        }

        // Setup search functionality
        function setupSearchListener() {
            const searchInput = document.getElementById("searchInput")

            if (!searchInput) {
                console.error("Search input not found!")
                return
            }

            searchInput.addEventListener("input", function () {
                const query = this.value.toLowerCase()
                console.log("Searching for:", query)
            })

            searchInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault()
                    const query = this.value.trim()
                    if (query) {
                        console.log("Search submitted:", query)
                        performSearch(query)
                    }
                }
            })

            console.log("Search listeners setup complete")
        }

        // Perform search functionality
        function performSearch(query) {
            const searchablePages = [
                { title: "Buy and Register", url: "Buy_and_register.html", keywords: ["buy", "purchase", "register", "payment", "charge"] },
                { title: "Your Tickets", url: "Your tickets.html", keywords: ["tickets", "find", "transfer", "download"] },
                { title: "Your Account", url: "Your account.html", keywords: ["account", "profile", "settings", "personal"] },
                { title: "Terms and Policies", url: "Terms and policies.html", keywords: ["terms", "policies", "legal", "privacy"] },
                { title: "Request a Refund", url: "Request a refund.html", keywords: ["refund", "cancel", "money back"] },
                { title: "Contact Organizer", url: "Contact_organizer.html", keywords: ["contact", "organizer", "message", "help"] },
                { title: "Create Ticket Types", url: "Create and edit ticket types.html", keywords: ["create", "ticket", "types", "edit"] },
                { title: "Add Media", url: "Add images and video to your event.html", keywords: ["images", "video", "media", "upload"] },
                { title: "Payout Methods", url: "Add and manage your payout methods.html", keywords: ["payout", "payment", "methods", "bank"] },
                { title: "Payout Issues", url: "Troubleshoot delayed or missing payout.html", keywords: ["troubleshoot", "delayed", "missing", "payout"] },
                { title: "Marketing", url: "Marketing_an_event_help_center.html", keywords: ["marketing", "email", "attendees", "promote"] },
                { title: "Issue Refunds", url: "Issue a full or partial refund.html", keywords: ["issue", "refund", "partial", "full"] },
                { title: "Managing Orders", url: "Managing_orders.html", keywords: ["orders", "manage", "edit", "update"] },
                { title: "Payouts and Taxes", url: "Payouts and taxes.html", keywords: ["payouts", "taxes", "financial", "earnings"] }
            ]

            const matches = searchablePages.filter(page =>
                page.title.toLowerCase().includes(query) ||
                page.keywords.some(keyword => keyword.includes(query))
            )

            if (matches.length === 1) {
                console.log("Single match found, navigating to:", matches[0].url)
                window.location.href = matches[0].url
            } else if (matches.length > 1) {
                console.log("Multiple matches found:", matches)
                const firstMatch = matches[0]
                const matchTitles = matches.map(m => m.title).join(', ')
                if (confirm(`Found ${matches.length} matches: ${matchTitles}. Navigate to "${firstMatch.title}"?`)) {
                    window.location.href = firstMatch.url
                }
            } else {
                alert(`No results found for "${query}". Try searching for topics like tickets, refunds, account, or payments.`)
            }
        }

        // Setup button listeners
        function setupButtonListeners() {
            console.log("Setting up button listeners...")

            // Header login button
            const headerLoginBtn = document.getElementById("headerLoginBtn")
            if (headerLoginBtn) {
                console.log("Header login button found")
                headerLoginBtn.addEventListener("click", handleLogin)
            }

            // Help card login button
            const helpCardLoginBtn = document.getElementById("helpCardLoginBtn")
            if (helpCardLoginBtn) {
                console.log("Help card login button found")
                helpCardLoginBtn.addEventListener("click", handleLogin)
            }

            // Contact button
            const contactButton = document.querySelector(".contact-button")
            if (contactButton) {
                console.log("Contact button found")
                contactButton.addEventListener("click", () => {
                    console.log("Contact support clicked - navigating to Contact_organizer.html")
                    window.location.href = "Contact_organizer.html"
                })
            } else {
                console.error("Contact button not found!")
            }

            // Topic cards - Using event delegation for CSP compliance
            const topicsSection = document.querySelector(".topics-section")
            if (topicsSection) {
                topicsSection.addEventListener("click", function (e) {
                    const topicCard = e.target.closest(".topic-card")
                    if (topicCard) {
                        const topicTitle = topicCard.querySelector("span").textContent
                        console.log("Topic clicked:", topicTitle)

                        // Choose appropriate mapping based on authentication status
                        const mapping = isAuthenticated ? topicMappingLoggedIn : topicMapping;
                        
                        // Show different content based on user role
                        if (isAuthenticated && currentUser && topicTitle === 'Your account') {
                            console.log('Navigating to account page for user role:', currentUser.role);
                        }

                        if (mapping[topicTitle]) {
                            console.log("Navigating to:", mapping[topicTitle])
                            window.location.href = mapping[topicTitle]
                        } else {
                            console.error("No URL mapping found for topic:", topicTitle)
                            alert("Page coming soon for: " + topicTitle)
                        }
                    }
                })
                console.log("Topic section click listener added")
            } else {
                console.error("Topics section not found!")
            }

            console.log("Button listeners setup complete")
        }

        // Handle footer link clicks using event delegation
        document.addEventListener("click", (e) => {
            if (e.target.matches(".footer-column a, .footer-links a")) {
                e.preventDefault()
                const linkText = e.target.textContent
                console.log("Footer link clicked:", linkText)

                // Map some footer links to actual pages
                const footerLinkMapping = {
                    "Contact support": "Contact_organizer.html",
                    "Help": "Help_center.html",
                    "Terms": "Terms and policies.html",
                    "Privacy": "Terms and policies.html"
                }

                if (footerLinkMapping[linkText]) {
                    window.location.href = footerLinkMapping[linkText]
                } else {
                    alert("Page coming soon: " + linkText)
                }
            }
        })

        // Check local authentication state for immediate UI update
        function checkLocalAuthState() {
            const token = localStorage.getItem('token') || localStorage.getItem('authToken');
            const userStr = localStorage.getItem('currentUser');
            
            if (token && userStr) {
                try {
                    const user = JSON.parse(userStr);
                    // Set UI immediately based on local storage
                    setAuthenticatedState(user);
                    console.log('Local auth state loaded:', user.email || user.name);
                } catch (error) {
                    console.error('Error parsing stored user data:', error);
                    clearAuthData();
                }
            } else {
                setUnauthenticatedState();
            }
        }
        
        // Handle token from URL parameters (e.g., from OAuth redirect)
        function handleTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                localStorage.setItem('token', token);
                // Remove token from URL for security
                window.history.replaceState({}, document.title, window.location.pathname);
                console.log('Token received from URL and stored');
            }
        }
        
        // Clear all authentication data
        function clearAuthData() {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
        }
        
        // Optional: Refresh auth status periodically
        setInterval(checkAuthStatus, 5 * 60 * 1000); // Check every 5 minutes

        // Debug function
        window.debugHelpCenter = function () {
            console.log("=== HELP CENTER DEBUG INFO ===")
            console.log("Authentication status:", isAuthenticated)
            console.log("Current user:", currentUser)
            console.log("Current tab:", currentTab)
            console.log("Articles data:", articlesData)
            console.log("Topic mapping:", topicMapping)
            console.log("Topic mapping (logged in):", topicMappingLoggedIn)
            console.log("Page location:", window.location.href)
            console.log("Available elements:")
            console.log("- Articles grid:", !!document.getElementById("articlesGrid"))
            console.log("- Search input:", !!document.getElementById("searchInput"))
            console.log("- Topic cards:", document.querySelectorAll(".topic-card").length)
            console.log("- Tab buttons:", document.querySelectorAll(".tab-button").length)
            console.log("- Login button:", !!document.getElementById("headerLoginBtn"))
            console.log("- User profile:", !!document.getElementById("headerUserProfile"))
            console.log("- Contact button:", !!document.querySelector(".contact-button"))

            // Test navigation
            console.log("Testing topic mappings:")
            const currentMapping = isAuthenticated ? topicMappingLoggedIn : topicMapping
            Object.entries(currentMapping).forEach(([topic, url]) => {
                console.log(`- ${topic} → ${url}`)
            })
        }

        console.log("CSP-compliant Help Center JS with Authentication loaded successfully!")
        console.log("Run debugHelpCenter() in console for debug info.")
    </script>

    <style>
        /* Loading Spinner Animation */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Additional styles for authentication elements */
        .loading-spinner {
            display: inline-block;
        }

        .help-faster-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .help-faster-content .login-button {
            margin-left: auto;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .help-faster-content {
                flex-direction: column;
                text-align: center;
            }

            .help-faster-content .login-button {
                margin-left: 0;
                margin-top: 1rem;
            }
        }
    </style>
</body>

</html>