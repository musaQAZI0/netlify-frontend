<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Event - Crowd</title>
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="event-editor-styles.css">
    <script src="js/data-manager.js"></script>
    <script src="js/google-places.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiq2Anse5vuEDCI3oKqD2iezo1MfoOiVk&libraries=places&loading=async&callback=initGooglePlaces" async defer></script>
</head>
<body>
    <div class="editor-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <div class="logo">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="#f97316">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
                
                <nav class="sidebar-nav">
                    <a href="organizer-dashboard.html" class="nav-item" title="Dashboard">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                    </a>
                    <a href="#" class="nav-item active" title="Events">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" x2="16" y1="2" y2="6"/>
                            <line x1="8" x2="8" y1="2" y2="6"/>
                            <line x1="3" x2="21" y1="10" y2="10"/>
                        </svg>
                    </a>
                    <a href="#" class="nav-item" title="Analytics">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 3v18h18"/>
                            <path d="M7 12l3-3 4 4 5-5"/>
                            <circle cx="7" cy="12" r="1"/>
                            <circle cx="10" cy="9" r="1"/>
                            <circle cx="14" cy="13" r="1"/>
                            <circle cx="19" cy="8" r="1"/>
                        </svg>
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Left Panel -->
        <div class="left-panel">
            <div class="back-link">
                <a href="organizer-dashboard.html">‚Üê Back to events</a>
            </div>
            
            <div class="event-summary">
                <div class="event-image-placeholder"></div>
                <h2 id="eventTitleSidebar">Event Title</h2>
                <div class="event-datetime">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" x2="16" y1="2" y2="6"/>
                        <line x1="8" x2="8" y1="2" y2="6"/>
                        <line x1="3" x2="21" y1="10" y2="10"/>
                    </svg>
                    <span id="eventDateTimeSidebar">Date and time</span>
                </div>
                
                <select class="status-select" id="eventStatus" onchange="updateEventStatus()">
                    <option value="draft">Draft</option>
                    <option value="published">Published</option>
                </select>
                
                <a href="event-preview.html" class="preview-link" onclick="saveAndPreview()">Preview ‚Üó</a>
            </div>

            <div class="steps-section">
                <h3>Steps</h3>
                <div class="step-item active">
                    <div class="step-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                    </div>
                    <div class="step-content">
                        <h4>Build event page</h4>
                        <p>Add all of your event details and let attendees know what to expect</p>
                    </div>
                </div>
                
                <div class="step-item completed">
                    <div class="step-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 12l2 2 4-4"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                    </div>
                    <div class="step-content">
                        <h4>Add tickets</h4>
                    </div>
                </div>
                
                <div class="step-item">
                    <div class="step-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                    </div>
                    <div class="step-content">
                        <h4>Publish</h4>
                    </div>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-item">Dashboard</div>
                <div class="menu-item">Order Options</div>
                <div class="menu-item">Payments & tax</div>
                <div class="menu-item">Marketing</div>
                <div class="menu-item">Manage Attendees</div>
                <div class="menu-item">Reporting</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="logo-text">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="#f97316">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span>crowd</span>
                    </div>
                    <div class="header-right">
                        <button class="preview-btn" onclick="saveAndPreview()">üëÅ Preview Your Event</button>
                        <button class="publish-btn" onclick="publishEvent()">Publish</button>
                        <button class="more-btn">More ‚ñº</button>
                        <div class="user-menu">
                            <div class="user-avatar" id="userAvatar">AA</div>
                            <span class="user-name" id="userName">User Name</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Event Content -->
            <div class="event-content">
                <div class="event-image-section">
                    <img src="https://images.unsplash.com/photo-1540575467063-178a50c2df87?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=400&q=80" alt="Event" class="event-image">
                    <div class="completion-badge">‚úì</div>
                </div>

                <div class="event-details-section">
                    <div class="completion-badge">‚úì</div>
                    <h1 contenteditable="true" class="editable-field" id="eventTitle" oninput="updateTitle()">Event Title</h1>
                    <p contenteditable="true" class="editable-field" id="eventDescription" oninput="saveEventData()">Event description goes here...</p>

                    <div class="event-info-grid">
                        <div class="info-section">
                            <div class="completion-badge">‚úì</div>
                            <h3>Date and time</h3>
                            <div class="datetime-display">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" x2="16" y1="2" y2="6"/>
                                    <line x1="8" x2="8" y1="2" y2="6"/>
                                    <line x1="3" x2="21" y1="10" y2="10"/>
                                </svg>
                                <div>
                                    <input type="date" class="input-field" id="eventDate" onchange="saveEventData()" style="margin-bottom: 8px;">
                                    <div style="display: flex; gap: 8px;">
                                        <input type="time" class="input-field" id="startTime" onchange="saveEventData()" style="flex: 1;">
                                        <input type="time" class="input-field" id="endTime" onchange="saveEventData()" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="completion-badge">‚úì</div>
                            <h3>Location</h3>
                            <div class="location-display">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                <input type="text" class="input-field" id="locationInput" placeholder="Enter event location" oninput="saveEventData()">
                            </div>
                        </div>
                    </div>

                    <div class="overview-section">
                        <div class="completion-badge">‚úì</div>
                        <div class="section-header">
                            <h3>Overview</h3>
                        </div>
                        
                        <div class="overview-content">
                            <h4 contenteditable="true" class="editable-field" id="overviewTitle" oninput="saveEventData()">Welcome to your event!</h4>
                            <textarea class="textarea-field" id="overviewDescription" placeholder="Describe your event..." oninput="saveEventData()">Join us for an exciting event that brings together amazing people for an unforgettable experience.</textarea>
                            
                            <h4 contenteditable="true" class="editable-field" oninput="saveEventData()">Why attend this event?</h4>
                            <textarea class="textarea-field" id="whyAttend" placeholder="Explain the benefits of attending..." oninput="saveEventData()">This event offers unique opportunities to connect, learn, and enjoy. Don't miss out on what promises to be an incredible experience.</textarea>
                            
                            <h4 contenteditable="true" class="editable-field" oninput="saveEventData()">How to participate:</h4>
                            <textarea class="textarea-field" id="howToParticipate" placeholder="Provide participation instructions..." oninput="saveEventData()">Simply register for your tickets and join us at the specified time and location. We'll provide all the details you need closer to the event date.</textarea>
                            
                            <textarea class="textarea-field" id="closingMessage" placeholder="Add a closing message..." oninput="saveEventData()">We look forward to seeing you at this amazing event!</textarea>
                        </div>
                    </div>

                    <div class="good-to-know-section">
                        <div class="section-header">
                            <h3>Good to know</h3>
                            <button class="add-btn" onclick="addGoodToKnowItem()">+</button>
                        </div>
                        
                        <div class="highlights-section">
                            <h4>Highlights</h4>
                            <div class="highlight-buttons">
                                <button class="highlight-btn" onclick="addHighlight('age')">+ Add Age info</button>
                                <button class="highlight-btn" onclick="addHighlight('door')">+ Add Door Time</button>
                            </div>
                            <div id="highlightsList"></div>
                        </div>
                        
                        <div class="faq-section">
                            <h4>Frequently asked questions</h4>
                            <div class="faq-item">
                                <span class="faq-icon">üí°</span>
                                <span>Events with FAQs have 8% more organic traffic</span>
                            </div>
                            <button class="add-question-btn" onclick="addFAQ()">+ Add question</button>
                            <div id="faqList"></div>
                        </div>
                        
                        <div class="sections-info">
                            <h4>Add more sections to your event page</h4>
                            <p>Make your event stand out even more. These sections help attendees find information and answer their questions - which means more ticket sales and less time answering messages.</p>
                            
                            <div class="section-options">
                                <div class="section-option">
                                    <div class="section-icon">üë•</div>
                                    <div class="section-info">
                                        <span>Lineup</span>
                                        <span class="new-badge">New</span>
                                    </div>
                                    <div class="section-actions">
                                        <a href="#" class="see-examples">See examples</a>
                                        <button class="add-section-btn" onclick="addSection('lineup')">Add</button>
                                    </div>
                                </div>
                                
                                <div class="section-option">
                                    <div class="section-icon">üìã</div>
                                    <div class="section-info">
                                        <span>Agenda</span>
                                    </div>
                                    <div class="section-actions">
                                        <a href="#" class="see-examples">See examples</a>
                                        <button class="add-section-btn" onclick="addSection('agenda')">Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentEventData = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!window.dataManager.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            loadEventData();
            loadUserData();

            // Initialize Google Places if API is already loaded
            if (window.google && window.google.maps && window.google.maps.places) {
                initGooglePlaces();
            }
        });

        function loadUserData() {
            const currentUser = window.dataManager.getCurrentUser();
            if (currentUser && currentUser.firstName && currentUser.lastName) {
                const initials = (currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0)).toUpperCase();
                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
        }

        function loadEventData() {
            const editingEvent = JSON.parse(localStorage.getItem('editingEvent') || '{}');
            
            if (!editingEvent.id) {
                // No event to edit, redirect to dashboard
                window.location.href = 'organizer-dashboard.html';
                return;
            }

            // Verify event belongs to current user
            const userEvent = window.dataManager.getEventById(editingEvent.id);
            if (!userEvent) {
                alert('Event not found or access denied.');
                window.location.href = 'organizer-dashboard.html';
                return;
            }

            currentEventData = userEvent;
            populateFields(userEvent);
        }

        function populateFields(eventData) {
            // Basic info
            document.getElementById('eventTitle').textContent = eventData.title || 'Untitled Event';
            document.getElementById('eventTitleSidebar').textContent = eventData.title || 'Untitled Event';
            document.getElementById('eventDescription').textContent = eventData.description || '';
            
            // Date and time
            if (eventData.date) {
                document.getElementById('eventDate').value = eventData.date;
            }
            if (eventData.startTime) {
                document.getElementById('startTime').value = eventData.startTime;
            }
            if (eventData.endTime) {
                document.getElementById('endTime').value = eventData.endTime;
            }
            
            // Location
            document.getElementById('locationInput').value = eventData.location || '';
            
            // Status
            document.getElementById('eventStatus').value = eventData.status || 'draft';
            
            // Overview content
            document.getElementById('overviewTitle').textContent = `Welcome to ${eventData.title || 'your event'}!`;
            document.getElementById('overviewDescription').value = eventData.overviewDescription || '';
            document.getElementById('whyAttend').value = eventData.whyAttend || '';
            document.getElementById('howToParticipate').value = eventData.howToParticipate || '';
            document.getElementById('closingMessage').value = eventData.closingMessage || '';
            
            // Update sidebar datetime
            updateSidebarDateTime();
        }

        function updateTitle() {
            const title = document.getElementById('eventTitle').textContent;
            document.getElementById('eventTitleSidebar').textContent = title;
            document.getElementById('overviewTitle').textContent = `Welcome to ${title}!`;
            saveEventData();
        }

        function updateSidebarDateTime() {
            const date = document.getElementById('eventDate').value;
            const startTime = document.getElementById('startTime').value;
            
            if (date && startTime) {
                const eventDate = new Date(date);
                const sidebarDateTime = `${eventDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}, ${formatTime(startTime)}`;
                document.getElementById('eventDateTimeSidebar').textContent = sidebarDateTime;
            }
        }

        function saveEventData() {
            try {
                // Collect updated data
                const updatedData = {
                    title: document.getElementById('eventTitle').textContent.trim(),
                    description: document.getElementById('eventDescription').textContent.trim(),
                    date: document.getElementById('eventDate').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    location: document.getElementById('locationInput').value.trim(),
                    status: document.getElementById('eventStatus').value,
                    overviewDescription: document.getElementById('overviewDescription').value.trim(),
                    whyAttend: document.getElementById('whyAttend').value.trim(),
                    howToParticipate: document.getElementById('howToParticipate').value.trim(),
                    closingMessage: document.getElementById('closingMessage').value.trim()
                };

                // Update event using data manager
                currentEventData = window.dataManager.updateEvent(currentEventData.id, updatedData);
                
                // Update sidebar
                updateSidebarDateTime();
                
                // Update localStorage for preview
                localStorage.setItem('editingEvent', JSON.stringify(currentEventData));
                
            } catch (error) {
                console.error('Failed to save event data:', error);
            }
        }

        function updateEventStatus() {
            saveEventData();
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function addHighlight(type) {
            const highlightsList = document.getElementById('highlightsList');
            const highlightDiv = document.createElement('div');
            highlightDiv.className = 'highlight-item';
            highlightDiv.style.marginTop = '12px';
            highlightDiv.style.padding = '12px';
            highlightDiv.style.border = '1px solid #e5e7eb';
            highlightDiv.style.borderRadius = '8px';
            
            if (type === 'age') {
                highlightDiv.innerHTML = `
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Age Restriction:</label>
                    <input type="text" class="input-field" placeholder="e.g., 18+ only" style="margin-bottom: 8px;">
                    <button onclick="this.parentElement.remove()" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                `;
            } else if (type === 'door') {
                highlightDiv.innerHTML = `
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Door Time:</label>
                    <input type="time" class="input-field" style="margin-bottom: 8px;">
                    <button onclick="this.parentElement.remove()" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                `;
            }
            
            highlightsList.appendChild(highlightDiv);
        }

        function addFAQ() {
            const faqList = document.getElementById('faqList');
            const faqDiv = document.createElement('div');
            faqDiv.className = 'faq-item';
            faqDiv.style.marginTop = '12px';
            faqDiv.style.padding = '12px';
            faqDiv.style.border = '1px solid #e5e7eb';
            faqDiv.style.borderRadius = '8px';
            
            faqDiv.innerHTML = `
                <input type="text" class="input-field" placeholder="Question" style="margin-bottom: 8px;">
                <textarea class="textarea-field" placeholder="Answer" style="margin-bottom: 8px;"></textarea>
                <button onclick="this.parentElement.remove()" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
            `;
            
            faqList.appendChild(faqDiv);
        }

        function addSection(type) {
            alert(`${type.charAt(0).toUpperCase() + type.slice(1)} section coming soon!`);
        }

        function addGoodToKnowItem() {
            alert('Additional "Good to know" items coming soon!');
        }

        function saveAndPreview() {
            saveEventData();
            window.location.href = 'event-preview.html';
        }

        function publishEvent() {
            try {
                saveEventData();
                
                const updatedEvent = window.dataManager.updateEvent(currentEventData.id, {
                    status: 'published',
                    publishedAt: new Date().toISOString()
                });
                
                currentEventData = updatedEvent;
                document.getElementById('eventStatus').value = 'published';
                localStorage.setItem('editingEvent', JSON.stringify(updatedEvent));
                
                alert('Event published successfully!');
                
            } catch (error) {
                alert('Failed to publish event: ' + error.message);
            }
        }

        // Auto-save on input changes
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('input-field') || 
                e.target.classList.contains('textarea-field') || 
                e.target.classList.contains('editable-field')) {
                // Debounce auto-save
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(saveEventData, 1000);
            }
        });

        // Save on page unload
        window.addEventListener('beforeunload', function() {
            saveEventData();
        });

        // Fallback initialization if Google Places fails
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (!window.google && window.googlePlaces) {
                    console.log('Google Maps API not available, using manual location entry only');
                    window.googlePlaces.setupManualLocationEntry();
                }
            }, 3000);
        });
    </script>
</body>
</html>
