<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reporting</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="analytics-styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth-mongodb.js"></script>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->

      <aside class="sidebar">
        <div class="sidebar-logo">
          <img src="logo.jpg" alt="Logo" style="height: 32px; width: auto; object-fit: contain;">
        </div>

        <nav class="sidebar-nav">
          <a href="dashboard-home.html" class="nav-item" title="Home">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9 22 9 12 15 12 15 22" />
            </svg>
          </a>

          <a href="events-calendar.html" class="nav-item" title="Events">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
          </a>

          <a href="orders.html" class="nav-item" title="Orders">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
              <polyline points="10 9 9 9 8 9" />
            </svg>
          </a>

          <a href="marketing.html" class="nav-item" title="Marketing">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
          </a>

          <a href="analytics.html" class="nav-item active" title="Analytics">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20V10" />
              <path d="M18 20V4" />
              <path d="M6 20v-4" />
            </svg>
          </a>

          <a href="finance.html" class="nav-item" title="Finance">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
            </svg>
          </a>
        </nav>

        <div class="sidebar-bottom">
          <a href="settings.html" class="nav-item" title="Settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3" />
              <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M20.46 20.46l-4.24-4.24M1.54 20.46l4.24-4.24M21 12h-6m-6 0H3" />
            </svg>
          </a>

          <a href="AppMarketplace.html" class="nav-item" title="Apps">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" />
              <rect x="14" y="3" width="7" height="7" />
              <rect x="14" y="14" width="7" height="7" />
              <rect x="3" y="14" width="7" height="7" />
            </svg>
          </a>

          <a href="Help_center.html" class="nav-item" title="Help">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
              <line x1="12" y1="17" x2="12.01" y2="17" />
            </svg>
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="header-content">
            <div class="logo-text">
            </div>
            <div class="header-right">
              <button
                class="create-btn"
                onclick="window.location.href='event-builder.html'"
              >
                + Create
              </button>
              <div class="user-menu" onclick="toggleUserMenu()">
                <div class="user-avatar" id="userAvatar">AA</div>
                <span class="user-name" id="userName">abdul ahad</span>
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M7 10l5 5 5-5z" />
                </svg>
              </div>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <div class="content-area">
          <!-- Empty State -->
          <div class="empty-state" id="emptyState">
            <div class="empty-illustration">
              <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
                <!-- Ghost illustration matching the screenshot -->
                <circle
                  cx="60"
                  cy="45"
                  r="25"
                  fill="none"
                  stroke="#9ca3af"
                  stroke-width="2"
                />
                <!-- Eyes -->
                <circle cx="52" cy="40" r="2" fill="#9ca3af" />
                <circle cx="68" cy="40" r="2" fill="#9ca3af" />
                <!-- Mouth -->
                <path
                  d="M52 52 Q60 58 68 52"
                  fill="none"
                  stroke="#9ca3af"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <!-- Ghost body -->
                <path
                  d="M35 70 Q35 45 60 45 Q85 45 85 70 L85 95 Q82 92 79 95 Q76 98 73 95 Q70 92 67 95 Q64 98 61 95 Q58 92 55 95 Q52 98 49 95 Q46 92 43 95 Q40 98 37 95 Q35 92 35 95 Z"
                  fill="none"
                  stroke="#9ca3af"
                  stroke-width="2"
                />
                <!-- Dotted lines below -->
                <circle cx="45" cy="105" r="1" fill="#d1d5db" />
                <circle cx="55" cy="108" r="1" fill="#d1d5db" />
                <circle cx="65" cy="105" r="1" fill="#d1d5db" />
                <circle cx="75" cy="108" r="1" fill="#d1d5db" />
              </svg>
            </div>
            <h2>Nothing to report</h2>
            <p>Your reports will be available after you sell some tickets.</p>
          </div>

          <!-- Analytics Dashboard -->
          <div
            class="analytics-dashboard"
            id="analyticsDashboard"
            style="display: none"
          >
            <!-- Page Header -->
            <div class="page-header">
              <h1>Reporting</h1>
              <div class="header-controls">
                <select class="time-filter" id="timeFilter">
                  <option value="7">Last 7 days</option>
                  <option value="30" selected>Last 30 days</option>
                  <option value="90">Last 90 days</option>
                  <option value="365">Last year</option>
                </select>
              </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
              <div class="summary-card">
                <div class="card-header">
                  <h3>Total Revenue</h3>
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="#10b981"
                  >
                    <path
                      d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                    />
                  </svg>
                </div>
                <div class="card-value" id="totalRevenue">$0</div>
                <div class="card-change positive" id="revenueChange">
                  +0% from last period
                </div>
              </div>

              <div class="summary-card">
                <div class="card-header">
                  <h3>Tickets Sold</h3>
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="#3b82f6"
                  >
                    <path d="M9 12l2 2 4-4" />
                    <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3" />
                    <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3" />
                  </svg>
                </div>
                <div class="card-value" id="totalTickets">0</div>
                <div class="card-change positive" id="ticketsChange">
                  +0% from last period
                </div>
              </div>

              <div class="summary-card">
                <div class="card-header">
                  <h3>Total Events</h3>
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="#f59e0b"
                  >
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" x2="16" y1="2" y2="6" />
                    <line x1="8" x2="8" y1="2" y2="6" />
                    <line x1="3" x2="21" y1="10" y2="10" />
                  </svg>
                </div>
                <div class="card-value" id="totalEvents">0</div>
                <div class="card-change neutral" id="eventsChange">
                  0 published
                </div>
              </div>

              <div class="summary-card">
                <div class="card-header">
                  <h3>Avg. Ticket Price</h3>
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="#8b5cf6"
                  >
                    <path d="M3 3v18h18" />
                    <path d="M7 12l3-3 4 4 5-5" />
                  </svg>
                </div>
                <div class="card-value" id="avgTicketPrice">$0</div>
                <div class="card-change neutral" id="priceChange">
                  Across all events
                </div>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
              <!-- Sales by Month -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3>Sales by Month</h3>
                  <select class="year-filter" id="yearFilter">
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                  </select>
                </div>
                <div class="chart-wrapper">
                  <canvas id="salesByMonthChart"></canvas>
                </div>
              </div>

              <!-- Top Performing Events -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3>Top Performing Events</h3>
                  <div class="chart-controls">
                    <button class="metric-toggle active" data-metric="tickets">
                      Tickets
                    </button>
                    <button class="metric-toggle" data-metric="revenue">
                      Revenue
                    </button>
                  </div>
                </div>
                <div class="chart-wrapper">
                  <canvas id="topEventsChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Revenue Breakdown -->
            <div class="charts-section">
              <div class="chart-container">
                <div class="chart-header">
                  <h3>Revenue by Ticket Type</h3>
                </div>
                <div class="chart-wrapper">
                  <canvas id="revenueBreakdownChart"></canvas>
                </div>
              </div>

              <!-- Event Performance Table -->
              <div class="table-container">
                <div class="table-header">
                  <h3>Event Performance</h3>
                  <div class="table-controls">
                    <input
                      type="text"
                      placeholder="Search events..."
                      class="search-input"
                      id="eventSearch"
                    />
                    <select class="status-filter" id="statusFilter">
                      <option value="">All Status</option>
                      <option value="published">Published</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                </div>
                <div class="table-wrapper">
                  <table class="events-table" id="eventsTable">
                    <thead>
                      <tr>
                        <th>Event</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Tickets Sold</th>
                        <th>Revenue</th>
                        <th>Conversion</th>
                      </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                      <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      let salesChart, topEventsChart, revenueChart;
      let currentMetric = "tickets";

      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          initializeAnalytics();
        }, 100);
      });
      
      async function initializeAnalytics() {
        console.log('📊 Initializing analytics...');
        
        // Wait for authAPI to be available
        if (!window.authAPI) {
          console.error('AuthAPI not available, retrying in 500ms...');
          setTimeout(initializeAnalytics, 500);
          return;
        }

        let isAuthenticated = false;
        
        try {
          // Use the actual authentication system (authAPI)
          isAuthenticated = await window.authAPI.isAuthenticated();
          console.log('🔍 AuthAPI authentication check:', isAuthenticated);
          
          if (!isAuthenticated) {
            console.log('User not authenticated, redirecting to login');
            localStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
            return;
          }

          console.log('✅ User authenticated, loading analytics...');
          await loadUserData();
          loadAnalytics();
          setupEventListeners();
          console.log('✅ Analytics initialized successfully');
        } catch (error) {
          console.error('❌ Error initializing analytics:', error);
          showErrorMessage('There was an issue loading the analytics page.');
        }
      }
      
      function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #ef4444;
          color: white;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
          z-index: 1000;
          font-weight: 500;
          max-width: 400px;
        `;
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => errorDiv.remove(), 5000);
      }

      async function loadUserData() {
        try {
          // Always fetch fresh user data from the database API - NEVER use localStorage
          console.log('🔄 Fetching fresh user data from database...');
          // Get current user from localStorage (auth-mongodb.js handles this)
          const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
          
          if (!currentUser || !currentUser.id) {
            console.error('❌ No user data received from API - user may not be logged in');
            window.location.href = 'login.html';
            return;
          }

          console.log('✅ Fresh user data loaded from database:', currentUser.email);

          // Update user display - use the actual user data structure from the API
          if (currentUser.firstName && currentUser.lastName) {
            const initials = (currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0)).toUpperCase();
            document.getElementById("userAvatar").textContent = initials;
            document.getElementById("userName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          } else if (currentUser.name) {
            // Fallback if user has a name field instead
            const nameParts = currentUser.name.split(' ');
            const initials = nameParts.length > 1 
              ? (nameParts[0].charAt(0) + nameParts[nameParts.length-1].charAt(0)).toUpperCase()
              : nameParts[0].charAt(0).toUpperCase();
            document.getElementById("userAvatar").textContent = initials;
            document.getElementById("userName").textContent = currentUser.name;
          } else {
            // Last resort - use email
            const initial = currentUser.email.charAt(0).toUpperCase();
            document.getElementById("userAvatar").textContent = initial;
            document.getElementById("userName").textContent = currentUser.email.split('@')[0];
          }
          
          // Store fresh data for offline access only
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        } catch (error) {
          console.error('❌ Error loading fresh user data:', error);
          window.location.href = 'login.html';
        }
      }

      async function loadAnalytics() {
        try {
          console.log('📊 Loading analytics data from backend...');

          // Fetch analytics data from backend API
          const token = localStorage.getItem('authToken');
          if (!token) {
            throw new Error('No authentication token found');
          }

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

          // Get analytics data from backend
          const analyticsResponse = await fetch(`${window.Config.API_BASE_URL}/api/analytics/overview`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (!analyticsResponse.ok) {
            if (analyticsResponse.status === 404) {
              // No analytics data available yet
              showEmptyState();
              return;
            }
            throw new Error(`Analytics API error: ${analyticsResponse.status}`);
          }

          const analyticsData = await analyticsResponse.json();
          console.log('✅ Analytics data received:', analyticsData);

          // Check if user has any data
          const hasData = analyticsData.overview &&
                         (analyticsData.overview.totalEvents > 0 ||
                          analyticsData.overview.totalTicketsSold > 0);

          if (!hasData) {
            showEmptyState();
          } else {
            showAnalyticsDashboard();
            updateSummaryCardsFromAPI(analyticsData.overview, analyticsData.revenue, analyticsData.attendance);
            createChartsFromAPI(analyticsData.revenue, analyticsData.events, analyticsData.ticketSales);
            populateEventsTableFromAPI(analyticsData.events.performance);
          }

        } catch (error) {
          console.error('❌ Error loading analytics:', error);
          // Show empty state if API fails
          showEmptyState();
        }
      }


      function showEmptyState() {
        document.getElementById("emptyState").style.display = "flex";
        document.getElementById("analyticsDashboard").style.display = "none";
      }

      function showAnalyticsDashboard() {
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("analyticsDashboard").style.display = "block";
      }

      function updateSummaryCardsFromAPI(overview, revenue, attendance) {
        // Update summary cards with API data
        document.getElementById("totalRevenue").textContent = `$${(overview.totalRevenue || 0).toLocaleString()}`;
        document.getElementById("totalTickets").textContent = (overview.totalTicketsSold || 0).toLocaleString();
        document.getElementById("totalEvents").textContent = (overview.totalEvents || 0).toString();

        // Calculate average ticket price
        const avgPrice = overview.totalTicketsSold > 0 ? overview.totalRevenue / overview.totalTicketsSold : 0;
        document.getElementById("avgTicketPrice").textContent = `$${avgPrice.toFixed(2)}`;

        // Update change indicators
        document.getElementById("revenueChange").textContent =
          `${overview.revenueChange >= 0 ? '+' : ''}${(overview.revenueChange || 0).toFixed(1)}% from last period`;
        document.getElementById("revenueChange").className =
          overview.revenueChange >= 0 ? 'card-change positive' : 'card-change negative';

        document.getElementById("ticketsChange").textContent =
          `${overview.ticketsChange >= 0 ? '+' : ''}${(overview.ticketsChange || 0).toFixed(1)}% from last period`;
        document.getElementById("ticketsChange").className =
          overview.ticketsChange >= 0 ? 'card-change positive' : 'card-change negative';

        const publishedCount = overview.publishedEvents || 0;
        document.getElementById("eventsChange").textContent = `${publishedCount} published`;
      }

      function updateSummaryCards(orders, events) {
        const totalRevenue = orders.reduce(
          (sum, order) => sum + order.total,
          0
        );
        const totalTickets = orders.reduce(
          (sum, order) => sum + order.ticketQuantity,
          0
        );
        const publishedEvents = events.filter(
          (e) => e.status === "published"
        ).length;
        const avgTicketPrice =
          totalTickets > 0 ? totalRevenue / totalTickets : 0;

        document.getElementById(
          "totalRevenue"
        ).textContent = `$${totalRevenue.toFixed(2)}`;
        document.getElementById("totalTickets").textContent =
          totalTickets.toLocaleString();
        document.getElementById("totalEvents").textContent =
          events.length.toString();
        document.getElementById(
          "avgTicketPrice"
        ).textContent = `$${avgTicketPrice.toFixed(2)}`;

        // Update change indicators (simplified for demo)
        document.getElementById("revenueChange").textContent = `+${Math.floor(
          Math.random() * 20
        )}% from last period`;
        document.getElementById("ticketsChange").textContent = `+${Math.floor(
          Math.random() * 15
        )}% from last period`;
        document.getElementById(
          "eventsChange"
        ).textContent = `${publishedEvents} published`;
        document.getElementById("priceChange").textContent =
          "Across all events";
      }

      function createChartsFromAPI(revenue, events, ticketSales) {
        createSalesByMonthChartFromAPI(revenue?.monthly || []);
        createTopEventsChartFromAPI(events?.topPerforming || []);
        createRevenueBreakdownChartFromAPI(ticketSales || {});
      }

      function createCharts(orders, events) {
        createSalesByMonthChart(orders);
        createTopEventsChart(orders, events);
        createRevenueBreakdownChart(orders);
      }

      function createSalesByMonthChart(orders) {
        const ctx = document
          .getElementById("salesByMonthChart")
          .getContext("2d");

        // Group orders by month
        const monthlyData = {};
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];

        // Initialize all months with 0
        months.forEach((month) => {
          monthlyData[month] = { tickets: 0, revenue: 0 };
        });

        orders.forEach((order) => {
          const date = new Date(order.orderDate);
          const month = months[date.getMonth()];
          monthlyData[month].tickets += order.ticketQuantity;
          monthlyData[month].revenue += order.total;
        });

        const ticketData = months.map((month) => monthlyData[month].tickets);
        const revenueData = months.map((month) => monthlyData[month].revenue);

        if (salesChart) salesChart.destroy();

        salesChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: months,
            datasets: [
              {
                label: "Tickets Sold",
                data: ticketData,
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                tension: 0.4,
                fill: true,
              },
              {
                label: "Revenue ($)",
                data: revenueData,
                borderColor: "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                tension: 0.4,
                fill: true,
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Tickets",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Revenue ($)",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });
      }

      function createTopEventsChart(orders, events) {
        const ctx = document.getElementById("topEventsChart").getContext("2d");

        // Group orders by event
        const eventData = {};
        orders.forEach((order) => {
          if (!eventData[order.eventTitle]) {
            eventData[order.eventTitle] = { tickets: 0, revenue: 0 };
          }
          eventData[order.eventTitle].tickets += order.ticketQuantity;
          eventData[order.eventTitle].revenue += order.total;
        });

        // Sort by current metric and take top 5
        const sortedEvents = Object.entries(eventData)
          .sort((a, b) => b[1][currentMetric] - a[1][currentMetric])
          .slice(0, 5);

        const labels = sortedEvents.map(([title]) =>
          title.length > 20 ? title.substring(0, 20) + "..." : title
        );
        const data = sortedEvents.map(([, data]) => data[currentMetric]);

        if (topEventsChart) topEventsChart.destroy();

        topEventsChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label:
                  currentMetric === "tickets" ? "Tickets Sold" : "Revenue ($)",
                data: data,
                backgroundColor: "#f97316",
                borderColor: "#ea580c",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: currentMetric === "tickets" ? "Tickets" : "Revenue ($)",
                },
              },
            },
          },
        });
      }

      function createRevenueBreakdownChart(orders) {
        const ctx = document
          .getElementById("revenueBreakdownChart")
          .getContext("2d");

        // Group by ticket type
        const ticketTypeData = {};
        orders.forEach((order) => {
          if (!ticketTypeData[order.ticketType]) {
            ticketTypeData[order.ticketType] = 0;
          }
          ticketTypeData[order.ticketType] += order.total;
        });

        const labels = Object.keys(ticketTypeData);
        const data = Object.values(ticketTypeData);
        const colors = ["#f97316", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6"];

        if (revenueChart) revenueChart.destroy();

        revenueChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
            },
          },
        });
      }

      function populateEventsTable(events, orders) {
        const tbody = document.getElementById("eventsTableBody");
        tbody.innerHTML = "";

        events.forEach((event) => {
          const eventOrders = orders.filter((o) => o.eventId === event.id);
          const ticketsSold = eventOrders.reduce(
            (sum, o) => sum + o.ticketQuantity,
            0
          );
          const revenue = eventOrders.reduce((sum, o) => sum + o.total, 0);
          const conversion =
            event.tickets && event.tickets.length > 0
              ? (
                  (ticketsSold /
                    event.tickets.reduce((sum, t) => sum + t.quantity, 0)) *
                  100
                ).toFixed(1)
              : "0.0";

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>
                        <div class="event-cell">
                            <div class="event-title">${event.title}</div>
                            <div class="event-location">${
                              event.location || "Location TBD"
                            }</div>
                        </div>
                    </td>
                    <td>${new Date(event.date).toLocaleDateString()}</td>
                    <td>
                        <span class="status-badge ${event.status}">
                            ${
                              event.status.charAt(0).toUpperCase() +
                              event.status.slice(1)
                            }
                        </span>
                    </td>
                    <td>${ticketsSold}</td>
                    <td>$${revenue.toFixed(2)}</td>
                    <td>${conversion}%</td>
                `;
          tbody.appendChild(row);
        });
      }

      function setupEventListeners() {
        // Time filter
        document
          .getElementById("timeFilter")
          .addEventListener("change", function () {
            loadAnalytics();
          });

        // Year filter
        document
          .getElementById("yearFilter")
          .addEventListener("change", function () {
            loadAnalytics();
          });

        // Metric toggle for top events
        document.querySelectorAll(".metric-toggle").forEach((button) => {
          button.addEventListener("click", function () {
            document
              .querySelectorAll(".metric-toggle")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            currentMetric = this.dataset.metric;

            // Reload analytics to update chart
            loadAnalytics();
          });
        });

        // Search and filter for events table
        document
          .getElementById("eventSearch")
          .addEventListener("input", filterEventsTable);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterEventsTable);
      }

      function filterEventsTable() {
        const searchTerm = document
          .getElementById("eventSearch")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        const rows = document.querySelectorAll("#eventsTableBody tr");

        rows.forEach((row) => {
          const eventTitle = row
            .querySelector(".event-title")
            .textContent.toLowerCase();
          const status = row
            .querySelector(".status-badge")
            .textContent.toLowerCase();

          const matchesSearch = eventTitle.includes(searchTerm);
          const matchesStatus =
            !statusFilter || status.includes(statusFilter.toLowerCase());

          row.style.display = matchesSearch && matchesStatus ? "" : "none";
        });
      }

      // API-specific chart functions
      function createSalesByMonthChartFromAPI(monthlyData) {
        const ctx = document.getElementById("salesByMonthChart").getContext("2d");

        if (!monthlyData || monthlyData.length === 0) {
          // Show empty chart
          monthlyData = Array(6).fill({ month: '', revenue: 0, tickets: 0 });
        }

        // Prepare data for the chart
        const labels = monthlyData.map((item, idx) => {
          if (item.month) {
            const date = new Date(item.month);
            return date.toLocaleDateString('en-US', { month: 'short' });
          }
          return '';
        });
        const revenueData = monthlyData.map(item => item.revenue || 0);
        const ticketsData = monthlyData.map(item => item.tickets || 0);

        if (salesChart) salesChart.destroy();

        salesChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Revenue ($)",
                data: revenueData,
                borderColor: "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                yAxisID: 'y1',
              },
              {
                label: "Tickets Sold",
                data: ticketsData,
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                display: true
              }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Tickets'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Revenue ($)'
                },
                grid: {
                  drawOnChartArea: false,
                },
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      function createTopEventsChartFromAPI(topEvents) {
        const ctx = document.getElementById("topEventsChart").getContext("2d");

        if (!topEvents || topEvents.length === 0) {
          topEvents = [{ eventTitle: 'No events yet', revenue: 0, ticketsSold: 0 }];
        }

        // Prepare data based on current metric
        const labels = topEvents.map(event => {
          const title = event.eventTitle || event.title || 'Untitled Event';
          return title.length > 20 ? title.substring(0, 20) + '...' : title;
        });
        const data = topEvents.map(event =>
          currentMetric === 'tickets' ? (event.ticketsSold || 0) : (event.revenue || 0)
        );

        if (topEventsChart) topEventsChart.destroy();

        topEventsChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: currentMetric === 'tickets' ? 'Tickets Sold' : 'Revenue ($)',
              data: data,
              backgroundColor: "#f97316",
              borderColor: "#ea580c",
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: currentMetric === 'tickets' ? 'Tickets' : 'Revenue ($)'
                },
                ticks: {
                  callback: function(value) {
                    if (currentMetric === 'revenue') {
                      return '$' + value.toLocaleString();
                    }
                    return value;
                  }
                }
              }
            }
          }
        });
      }

      function createRevenueBreakdownChartFromAPI(ticketSales) {
        const ctx = document.getElementById("revenueBreakdownChart").getContext("2d");

        // Prepare data from ticket sales
        let labels, data;
        if (ticketSales.byType && ticketSales.byType.length > 0) {
          labels = ticketSales.byType.map(item => item.type || item.ticketType || 'General');
          data = ticketSales.byType.map(item => item.revenue || item.count || 0);
        } else {
          labels = ['No data'];
          data = [1];
        }

        if (revenueChart) revenueChart.destroy();

        revenueChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: [
                "#f97316", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"
              ],
              borderWidth: 2,
              borderColor: '#ffffff',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    if (labels[0] === 'No data') return 'No data available';
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    return label + ': $' + value.toLocaleString();
                  }
                }
              }
            },
          }
        });
      }

      function populateEventsTableFromAPI(eventsData) {
        const tbody = document.getElementById("eventsTableBody");
        tbody.innerHTML = "";

        if (!eventsData || eventsData.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
              No event data available yet
            </td>
          `;
          tbody.appendChild(row);
          return;
        }

        eventsData.forEach((event) => {
          const eventDate = event.eventDate || event.date;
          const conversionRate = event.conversionRate ||
                                ((event.ticketsSold / Math.max(event.capacity || event.totalTickets || 100, 1)) * 100);

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="event-cell">
                <div class="event-title">${event.eventTitle || event.title || 'Untitled Event'}</div>
                <div class="event-location">${event.location || 'Location TBD'}</div>
              </div>
            </td>
            <td>${eventDate ? new Date(eventDate).toLocaleDateString() : 'Date TBD'}</td>
            <td>
              <span class="status-badge ${event.status || 'published'}">${
                (event.status || 'published').charAt(0).toUpperCase() +
                (event.status || 'published').slice(1)
              }</span>
            </td>
            <td>${(event.ticketsSold || 0).toLocaleString()}</td>
            <td>$${(event.revenue || 0).toFixed(2)}</td>
            <td>${conversionRate.toFixed(1)}%</td>
          `;
          tbody.appendChild(row);
        });
      }
    </script>
  </body>
</html>
